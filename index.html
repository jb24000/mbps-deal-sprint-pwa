<!DOCTYPE html>
<html lang="en" class="">
<head>
<script id="mbps-early-shim">
(function(){
  const pending = [];
  let domReady = false;
  function safeShow(id){
    try{
      const panels = document.querySelectorAll('[data-tab-panel], .tab-panel, section.tab-panel');
      panels.forEach(p => { try{ p.hidden = true; }catch(_){} });
      const target = document.getElementById(id) || document.querySelector(`[data-tab-panel="${id}"]`) || null;
      if (!target) { if (!domReady) pending.push(id); return; }
      target.hidden = false;
      const tabs = document.querySelectorAll('[data-tab], .tab, [role="tab"]');
      tabs.forEach(btn => {
        const match = (btn.getAttribute('data-tab') === id) ||
                      (btn.getAttribute('href') === `#${id}`) ||
                      (btn.id && btn.id === id);
        btn.classList.toggle('active', !!match);
      });
    }catch(e){ console.warn('[early showTab] guarded:', e); }
  }
  window.showTab = safeShow;
  document.addEventListener('DOMContentLoaded', ()=>{
    domReady = true;
    const seen = new Set();
    pending.forEach(id => { if (!seen.has(id)) { seen.add(id); safeShow(id); } });
  });
})();
</script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MB Property Solutions - Deal Sprint</title>
  <meta name="theme-color" content="#00a8ff">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <link rel="manifest" href="./manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="MB Deal Sprint">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 64 64%22><rect width=%2264%22 height=%2264%22 rx=%2210%22 fill=%22%2306b6d4%22/><text x=%2232%22 y=%2239%22 font-size=%2230%22 text-anchor=%22middle%22 fill=%22white%22 font-family=%22Arial%22>REI</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Dancing+Script:wght@600&family=Pacifico&family=Satisfy&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand:{50:'#ecfeff',100:'#cffafe',200:'#a5f3fc',300:'#67e8f9',400:'#22d3ee',500:'#06b6d4',600:'#0891b2',700:'#0e7490',800:'#155e75',900:'#164e63'},
            accent:{50:'#fdf4ff',100:'#fae8ff',200:'#f5d0fe',300:'#f0abfc',400:'#e879f9',500:'#d946ef',600:'#c026d3',700:'#a21caf',800:'#86198f',900:'#701a75'}
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --ring: 0 0 0 3px rgb(14 165 233 / .25); }
    html, body { height: 100%; }
    .card { background:white; border-radius:1rem; box-shadow:0 10px 30px rgba(2,132,199,.08); padding:1rem; border:1px solid #e2e8f0; }
    .btn { display:inline-flex; align-items:center; gap:.5rem; padding:.75rem 1rem; border-radius:.9rem; border:1px solid #e2e8f0; font-size:.95rem; font-weight:600; -webkit-tap-highlight-color: transparent; }
    .btn:active { transform:scale(.98) }
    .btn-primary { background:#06b6d4; color:white; border-color:#0e7490; }
    .btn-outline { background:white; color:#0e7490; border-color:#7dd3fc; }
    .btn-accent { background:#d946ef; color:white; border-color:#a21caf; }
    .badge { display:inline-flex; align-items:center; padding:.125rem .6rem; border-radius:999px; font-size:.8rem; font-weight:700; }
    .badge-lead{background:#e5e7eb;color:#111827}.badge-offer{background:#e0f2fe;color:#075985}.badge-pending{background:#fef9c3;color:#854d0e}
    .badge-sent{background:#dbeafe;color:#1e40af}.badge-signed{background:#dcfce7;color:#166534}.badge-attorney{background:#efe7ff;color:#6b21a8}.badge-closed{background:#bbf7d0;color:#065f46}
    .dropzone { display:flex; align-items:center; justify-content:center; min-height:140px; width:100%; border:2px dashed #bae6fd; border-radius:1rem; background:#f0f9ff; color:#0c4a6e; user-select:none; }
    .dropzone.dragover { outline: 3px solid rgba(14,165,233,.25); }
    .kanban-col { background:linear-gradient(180deg,#f8fafc,#eef2ff); border-radius:1rem; padding:.75rem; min-height:220px; }
    .tab { border-bottom:2px solid transparent; padding:.5rem .75rem; border-radius:.5rem .5rem 0 0; }
    .tab.active { border-color:#06b6d4; background:#cffafe; color:#0e7490; }
    canvas.sig { touch-action:none; }
    .draggable { cursor:grab; }
    .draggable:active { cursor:grabbing; }
    .meter { height:10px; border-radius:999px; background:#e5e7eb; overflow:hidden; }
    .meter > i { display:block; height:100%; background:#06b6d4; }
    .sticky-topbar { position: sticky; top: 0; z-index: 40; }
    
    .sprint-day { 
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); 
      border-radius: 1rem; 
      padding: 1rem; 
      margin-bottom: 1rem; 
      border: 2px solid #e2e8f0;
      transition: all 0.3s ease;
    }
    .sprint-day.day-1 { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #f59e0b; }
    .sprint-day.day-2 { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #f59e0b; }
    .sprint-day.day-3 { background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%); border-color: #3b82f6; }
    .sprint-day.day-4 { background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%); border-color: #3b82f6; }
    .sprint-day.day-5 { background: linear-gradient(135deg, #dcfce7 0%, #86efac 100%); border-color: #22c55e; }
    .sprint-day.day-6 { background: linear-gradient(135deg, #dcfce7 0%, #86efac 100%); border-color: #22c55e; }
    .sprint-day.day-7 { background: linear-gradient(135deg, #fce7f3 0%, #f9a8d4 100%); border-color: #ec4899; }

    .sprint-task { 
      display: flex; 
      align-items: center; 
      padding: 0.5rem; 
      margin: 0.25rem 0; 
      background: rgba(255, 255, 255, 0.7); 
      border-radius: 0.5rem; 
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
    .sprint-task:hover { background: rgba(255, 255, 255, 0.9); }
    .sprint-task input[type="checkbox"] { margin-right: 0.5rem; accent-color: #06b6d4; }
    .sprint-task.completed { opacity: 0.6; text-decoration: line-through; }
    
    .progress-bar { 
      width: 100%; 
      height: 1rem; 
      background: #e5e7eb; 
      border-radius: 999px; 
      overflow: hidden; 
      margin: 0.5rem 0;
    }
    .progress-fill { 
      height: 100%; 
      background: linear-gradient(90deg, #06b6d4, #0891b2); 
      transition: width 0.3s ease; 
      border-radius: 999px;
    }
    
    @media (max-width: 640px){
      .btn { padding:.95rem 1.05rem; font-size:1rem; }
      .mobile-only { display:block !important; }
      .desktop-only { display:none !important; }
      input, select, textarea { font-size:16px; }
      .sticky-tabs { position: sticky; top: 56px; z-index: 30; background: rgba(255,255,255,.9); backdrop-filter: blur(6px); }
      .sprint-day { padding: 0.75rem; margin-bottom: 0.75rem; }
      .sprint-task { padding: 0.4rem; font-size: 0.85rem; }
    }
    @media (min-width: 641px){
      .mobile-only { display:none !important; }
      .desktop-only { display:block !important; }
    }
    #pdfContainer canvas { width: 100% !important; height: auto !important; }
    .dark body { background: linear-gradient(135deg,#0b1220,#111827 40%,#0a1224); color:#e5e7eb; }
    .dark .card { background:#0f172a; border-color:#1f2937; box-shadow:none; }
    .dark .btn { border-color:#334155; color:#e5e7eb; background:#0b1322; }
    .dark .btn-outline { background:#0b1322; }
    .dark .btn-primary { background:#06b6d4; color:#031b22; border-color:#0891b2; }
    .dark .btn-accent { background:#d946ef; color:#2b0a2b; border-color:#a21caf; }
    .dark .badge-lead{background:#374151;color:#e5e7eb}
    .dark .badge-offer{background:#0b3b4a;color:#67e8f9}
    .dark .badge-pending{background:#3a3005;color:#fde68a}
    .dark .badge-sent{background:#14213d;color:#93c5fd}
    .dark .badge-signed{background:#0f3d2e;color:#bbf7d0}
    .dark .badge-attorney{background:#2d1b3f;color:#f5d0fe}
    .dark .badge-closed{background:#064e3b;color:#bbf7d0}
    .dark .dropzone { background:#0b1322; border-color:#1e293b; color:#7dd3fc; }
    .dark input, .dark select, .dark textarea { background:#0b1322; color:#e5e7eb; border-color:#334155; }
    .dark table thead { color:#93a3b8; }
    .dark #pdfContainer { background:#0b1322; border-color:#1f2937; }
    .dark .sticky-tabs { background: rgba(3,8,23,.7); backdrop-filter: blur(6px); }
    .dark .sprint-day { background: linear-gradient(135deg, #1f2937 0%, #374151 100%); border-color: #4b5563; }
    .dark .sprint-task { background: rgba(15, 23, 42, 0.8); color: #e5e7eb; }
    
/* KPI card styles */
.kpi-card {
  background: linear-gradient(135deg, #ffffff, #f0f9ff);
  border: 1px solid #e0f2fe;
  border-radius: 1rem;
  padding: 1.25rem;
  transition: all 0.3s ease;
}
.kpi-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(59, 130, 246, 0.15);
}
.dark .kpi-card {
  background: linear-gradient(135deg, #1e293b, #0f172a);
  border-color: #334155;
}
    /* Cost-efficient sync indicators */
.sync-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  padding: 0.25rem 0.5rem;
  border-radius: 0.5rem;
  font-size: 0.75rem;
  font-weight: 600;
}
.sync-badge.synced {
  background: #dcfce7;
  color: #166534;
}
.sync-badge.pending {
  background: #fef3c7;
  color: #92400e;
}
.sync-badge.error {
  background: #fee2e2;
  color: #991b1b;
}
.dark .sync-badge.synced {
  background: #064e3b;
  color: #6ee7b7;
}
.dark .sync-badge.pending {
  background: #78350f;
  color: #fde68a;
}
.dark .sync-badge.error {
  background: #7f1d1d;
  color: #fecaca;
}
    
 </style>

<style id="mbps-dark-contrast-fix">
/* High-contrast dark theme overrides */
body.dark, [data-theme="dark"] {
  color: #e6e9ef;
  background: #0b1220;
}
body.dark .btn, [data-theme="dark"] .btn {
  color: #e6e9ef;
  border-color: rgba(231, 233, 239, 0.25);
  background: #111827;
}
body.dark .btn.primary, [data-theme="dark"] .btn.primary,
body.dark .btn.blue, [data-theme="dark"] .btn.blue {
  background: #00a8ff;
  border-color: #00a8ff;
  color: #fff;
}
body.dark .card, body.dark .panel, body.dark .kb-card, body.dark .kb-col,
[data-theme="dark"] .card, [data-theme="dark"] .panel, [data-theme="dark"] .kb-card, [data-theme="dark"] .kb-col {
  background: #0f172a;
  border-color: rgba(231,233,239,0.15);
  color: #e6e9ef;
}
body.dark .kb-hd, [data-theme="dark"] .kb-hd {
  border-bottom-color: rgba(231,233,239,0.15);
  color: #fff;
}
body.dark .kb-badge, [data-theme="dark"] .kb-badge {
  border-color: rgba(231,233,239,0.25);
  color: #e6e9ef;
}
body.dark dialog, [data-theme="dark"] dialog {
  background: #0f172a;
  color: #e6e9ef;
}
body.dark dialog .hd, body.dark dialog .modal-hd, [data-theme="dark"] dialog .hd, [data-theme="dark"] dialog .modal-hd {
  border-bottom-color: rgba(231,233,239,0.15);
}
body.dark input, [data-theme="dark"] input, 
body.dark select, [data-theme="dark"] select, 
body.dark textarea, [data-theme="dark"] textarea {
  color: #e6e9ef;
  background: #111827;
  border-color: rgba(231,233,239,0.25);
}
body.dark table, [data-theme="dark"] table { color: #e6e9ef; }
body.dark th, body.dark td, [data-theme="dark"] th, [data-theme="dark"] td {
  border-color: rgba(231,233,239,0.15);
}
body.dark .kb-gloss, [data-theme="dark"] .kb-gloss {
  color: #b6bcc8;
  border-top-color: rgba(231,233,239,0.15);
}
</style>


<style id="mbps-ui-hotfix-style">
/* Agent search alignment + responsiveness */
.agent-search-input{
  min-width: 240px;
  max-width: 320px;
  width: 28ch;
  float: right;
  margin-left: auto;
}
@media (max-width: 768px){
  .agent-search-input{ float:none; width: 100%; max-width: 100%; }
}

/* Additional fix for the Agent Network search */
#agentSearch {
  max-width: 300px;
  width: 100%;
}
@media (min-width: 768px) {
  .flex.items-center.justify-between {
    flex-wrap: nowrap;
  }
}
  
/* Ensure the blank PE button (now labeled) uses the blue primary style if available */
button#btnPropertyEvaluation, .btn#btnPropertyEvaluation{
  border-color: rgba(0,168,255,.25);
}
</style>


<script id="mbps-durable-showtab">
(function(){
  // A safe function that never throws on missing targets
  function safeActivate(id){
    try{
      const panels = document.querySelectorAll('[data-tab-panel], .tab-panel, section.tab-panel');
      panels.forEach(p => { try{ p.hidden = true; }catch(_){} });
      const target = document.getElementById(id) || document.querySelector(`[data-tab-panel="${id}"]`) || null;
      if (!target) { console.warn('[showTab] target not found:', id); return; }
      target.hidden = false;
      const tabs = document.querySelectorAll('[data-tab], .tab, [role="tab"]');
      tabs.forEach(btn => {
        const match = (btn.getAttribute('data-tab') === id) ||
                      (btn.getAttribute('href') === `#${id}`) ||
                      (btn.id && btn.id === id);
        btn.classList.toggle('active', !!match);
      });
    }catch(e){ console.warn('[showTab] safeActivate error:', e); }
  }
  // Wrap any assignment to window.showTab so it always calls safeActivate first
  try{
    let _impl = window.showTab || function(id){ safeActivate(id); };
    Object.defineProperty(window, 'showTab', {
      configurable: true,
      get(){ return function(id){ safeActivate(id); try{ return _impl && _impl(id); }catch(e){ console.warn('[showTab inner]', e); } }; },
      set(v){ _impl = v; }
    });
  }catch(e){
    // Fallback: just set the safe version
    window.showTab = function(id){ safeActivate(id); };
  }
})();
</script>

</head>
<body class="bg-gradient-to-br from-brand-50 via-white to-accent-50 text-gray-800 min-h-screen">
  <!-- ONE-METRIC BAR -->
  <div class="sticky-topbar w-full bg-white/90 dark:bg-[#0b1322]/70 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-2 flex items-center justify-between gap-3">
      <div class="flex items-center gap-2 text-sm">
        <span class="font-semibold">One Metric:</span>
        <span class="text-gray-600 dark:text-gray-300">Conversations this week</span>
      </div>
      <div class="flex items-center gap-3 min-w-[180px]">
        <div id="omValue" class="text-lg font-bold">0</div>
        <div class="meter w-40 rounded-full"><i id="omMeter" style="width:0%"></i></div>
        <div id="omTarget" class="text-xs text-gray-500">Goal 50</div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto p-4 md:p-8">
    <!-- HEADER -->
    <header class="flex flex-wrap items-center justify-between gap-3 mb-6">
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-2xl bg-gradient-to-br from-brand-500 to-accent-500 grid place-content-center text-white font-bold shadow">REI</div>
        <div>
          <h1 class="text-2xl font-semibold">REI Stack â€” Millionaire Wholesaler Mode</h1>
          <p class="text-xs text-gray-600 dark:text-gray-300">Leads â†’ Offers (Cash & Terms) â†’ Contracts â†’ Dispo â†’ Closings</p>
        </div>
      </div>
      <div class="flex gap-2 items-center">
        <button id="exportCsvBtn" class="btn btn-outline"><i data-lucide="file-down"></i>Export CSV</button>
        <button id="backupBtn" class="btn btn-outline"><i data-lucide="database"></i>Backup</button>
        <input id="restoreInput" type="file" accept="application/json" class="hidden" />
        <button id="restoreBtn" class="btn btn-outline"><i data-lucide="rotate-ccw"></i>Restore</button>
        <button id="themeToggle" class="btn btn-outline" title="Toggle dark mode"><i data-lucide="moon"></i><span class="hidden sm:inline">Dark</span></button>
      </div>
    </header>

    <!-- NAV TABS -->
<nav class="sticky-tabs flex flex-wrap gap-2 mb-4 rounded-xl p-1 bg-white/80 dark:bg-[#0b1322]/70">
  <button class="tab active" data-tab="dashboard">Dashboard</button>
  <button class="tab" data-tab="sprint">Sprint</button>
  <button class="tab" data-tab="tab-seven-day-sprint">7-Day Sprint</button>
  <button class="tab" data-tab="contracts">Contracts</button>
  <button class="tab" data-tab="pipeline">Pipeline</button>
  <button class="tab" data-tab="agent-outreach">Agent Network</button>
  <button class="tab" data-tab="extended-pipeline">Extended Pipeline</button>
  <button class="tab" data-tab="signer">Sign</button>
  <button class="tab" data-tab="buyers">Buyers</button>
  <button class="tab" data-tab="kpi">KPI</button>
  <button class="tab" data-tab="settings">Settings</button>
  <!-- Add these new tabs to your existing nav, before </nav> -->
  <button class="tab" data-tab="dashboard">Dashboard</button>
  <button class="tab" data-tab="analyzers">Analyzers</button>
</nav>

<!-- DASHBOARD TAB (Professional Overview) -->
<section id="tab-dashboard" class="">
  <div class="grid lg:grid-cols-4 gap-4 mb-6">
    <!-- Quick Stats -->
    <div class="kpi-card">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm text-gray-600">Active Deals</span>
        <i data-lucide="trending-up" class="w-4 h-4 text-brand-500"></i>
      </div>
      <div id="activeDealsCount" class="text-3xl font-bold text-brand-700">0</div>
      <div class="text-xs text-gray-500 mt-1">In pipeline</div>
    </div>
    
    <div class="kpi-card">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm text-gray-600">This Month</span>
        <i data-lucide="dollar-sign" class="w-4 h-4 text-green-500"></i>
      </div>
      <div id="monthlyProfit" class="text-3xl font-bold text-green-600">$0</div>
      <div class="text-xs text-gray-500 mt-1">Closed profit</div>
    </div>
    
    <div class="kpi-card">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm text-gray-600">Hot Leads</span>
        <i data-lucide="flame" class="w-4 h-4 text-orange-500"></i>
      </div>
      <div id="hotLeadsCount" class="text-3xl font-bold text-orange-600">0</div>
      <div class="text-xs text-gray-500 mt-1">Score 70+</div>
    </div>
    
    <div class="kpi-card">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm text-gray-600">Conversion</span>
        <i data-lucide="target" class="w-4 h-4 text-purple-500"></i>
      </div>
      <div id="conversionRate" class="text-3xl font-bold text-purple-600">0%</div>
      <div class="text-xs text-gray-500 mt-1">Lead to deal</div>
    </div>
  </div>
  
  <!-- Hot Deals & Follow-ups -->
  <div class="grid lg:grid-cols-2 gap-6">
    <div class="card">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">ðŸ”¥ Hot Deals (Score 70+)</h2>
        <button onclick="renderDashboard()" class="btn btn-outline btn-sm">Refresh</button>
      </div>
      <div id="hotDealsList" class="space-y-3 max-h-96 overflow-auto">
        <div class="text-gray-500">Loading...</div>
      </div>
    </div>
    
    <div class="card">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">ðŸ“… Today's Follow-Ups</h2>
        <span id="todayCount" class="badge badge-warning">0</span>
      </div>
      <div id="todayTasksList" class="space-y-3 max-h-96 overflow-auto">
        <div class="text-gray-500">Loading...</div>
      </div>
    </div>
  </div>
  
  <!-- Quick Actions -->
  <div class="card mt-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">Quick Actions</h2>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <button onclick="document.querySelector('[data-tab=sprint]').click()" class="btn btn-outline">
        <i data-lucide="plus-circle"></i>Add Lead
      </button>
      <button onclick="document.querySelector('[data-tab=pipeline]').click()" class="btn btn-outline">
        <i data-lucide="kanban"></i>Pipeline
      </button>
      <button onclick="S3Sync.push()" class="btn btn-primary">
        <i data-lucide="cloud-upload"></i>Sync Now
      </button>
      <button onclick="document.querySelector('[data-tab=kpi]').click()" class="btn btn-outline">
        <i data-lucide="bar-chart-2"></i>Analytics
      </button>
    </div>
  </div>
</section>
    
    <!-- 7-DAY SPRINT TAB -->
    <section id="tab-seven-day-sprint" class="">
      <div class="grid lg:grid-cols-4 gap-6">
        <!-- Sprint Overview Card -->
        <div class="lg:col-span-1 card">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-brand-700">7-Day Sprint</h2>
            <button id="resetSprintBtn" class="btn btn-outline text-sm">
              <i data-lucide="refresh-cw"></i>Reset
            </button>
          </div>
          
          <!-- Progress Overview -->
          <div class="space-y-4">
            <div class="text-center">
              <div id="sprintProgress" class="text-4xl font-bold text-brand-600 mb-1">0%</div>
              <div class="text-sm text-gray-600">Complete</div>
            </div>
            
            <div class="progress-bar">
              <div id="sprintProgressFill" class="progress-fill" style="width: 0%"></div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 text-center">
                <div id="tasksCompleted" class="font-bold text-lg">0</div>
                <div class="text-xs text-gray-600">Tasks Done</div>
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 text-center">
                <div id="activeDays" class="font-bold text-lg">0</div>
                <div class="text-xs text-gray-600">Active Days</div>
              </div>
            </div>
            
            <!-- Sprint Dates -->
            <div class="pt-3 border-t text-xs text-gray-600 space-y-1">
              <div><strong>Started:</strong> <span id="sprintStartDate">Not started</span></div>
              <div><strong>Est. Complete:</strong> <span id="sprintEndDate">â€”</span></div>
            </div>
          </div>
          
          <!-- Pro Tips -->
          <div class="mt-6 p-3 bg-accent-50 dark:bg-accent-900/20 rounded-lg">
            <h3 class="font-semibold text-sm mb-2">Pro Tips</h3>
            <ul class="text-xs space-y-1 text-gray-600 dark:text-gray-300">
              <li>â€¢ Use Privy's Investor Activity filter for hot leads</li>
              <li>â€¢ Set up Saved Searches for automation</li>
              <li>â€¢ Use Comparative Search to find similar deals</li>
              <li>â€¢ Focus on distressed properties for higher margins</li>
              <li>â€¢ Track your conversion rates weekly</li>
            </ul>
          </div>
        </div>
        
        <!-- Sprint Days -->
        <div class="lg:col-span-3">
          <div id="sprintDays" class="space-y-4 max-h-[80vh] overflow-auto">
            <!-- Days will be dynamically generated here -->
          </div>
        </div>
      </div>
    </section>

    <!-- SPRINT (Original) -->
    <section id="tab-sprint" class="hidden grid lg:grid-cols-3 gap-6">
      <!-- Lead intake + calculators -->
      <section class="lg:col-span-1 card">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Add Lead (Expired â€¢ Agent â€¢ FSBO)</h2>
          <div class="flex items-center gap-2">
            <label class="text-xs flex items-center gap-1"><input id="agentMode" type="checkbox" class="accent-brand-500"> Agent Mode</label>
            <span class="text-xs text-gray-500">Saved locally</span>
          </div>
        </div>
        <form id="leadForm" class="grid grid-cols-1 gap-3">
          <div>
            <label class="text-sm font-medium">Source</label>
            <select id="leadSource" class="w-full rounded-xl border-gray-200">
              <option>Privy-Distressed</option>
              <option>Privy-HighEquity</option>
              <option>Privy-Absentee</option>
              <option>Privy-PreForeclosure</option>
              <option>Privy-Probate</option>
              <option>Privy-TaxLien</option>
              <option>Expired</option>
              <option>Agent</option>
              <option>FSBO</option>
              <option>Referral</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium">Property Address</label>
            <input id="leadAddress" class="w-full rounded-xl border-gray-200" placeholder="123 Main St, City ST" required />
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="text-sm font-medium">Seller / Contact</label>
              <input id="leadSeller" class="w-full rounded-xl border-gray-200" placeholder="Name" />
            </div>
            <div>
              <label class="text-sm font-medium">Agent (if any)</label>
              <input id="leadAgent" class="w-full rounded-xl border-gray-200" placeholder="Agent Name" />
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <input id="leadPhone" class="w-full rounded-xl border-gray-200" placeholder="Phone" />
            <input id="leadEmail" class="w-full rounded-xl border-gray-200" placeholder="Email" />
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <input id="leadARV" type="number" class="w-full rounded-xl border-gray-200" placeholder="ARV $" />
            <input id="leadRepairs" type="number" class="w-full rounded-xl border-gray-200" placeholder="Repairs $" />
            <input id="leadAsk" type="number" class="w-full rounded-xl border-gray-200" placeholder="Ask/List $" />
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <input id="leadMortgage" type="number" class="w-full rounded-xl border-gray-200" placeholder="Mortgage Bal $" />
            <input id="leadDOM" type="number" class="w-full rounded-xl border-gray-200" placeholder="Days on Market" />
            <select id="leadPropertyType" class="w-full rounded-xl border-gray-200">
              <option value="">Property Type</option>
              <option>SFH</option>
              <option>Townhome</option>
              <option>Condo</option>
              <option>Multi-Family</option>
              <option>Land</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="p-3 rounded-xl border bg-white dark:bg-[#0b1322]">
              <div class="text-gray-500">MAO (70% Rule)</div>
              <div id="maoVal" class="text-lg font-semibold">$0</div>
            </div>
            <div class="p-3 rounded-xl border bg-white dark:bg-[#0b1322]">
              <div class="text-gray-500">Cash Offer Anchor</div>
              <div id="anchorVal" class="text-lg font-semibold">$0</div>
            </div>
          </div>
          <div>
            <label class="text-sm font-medium">Notes</label>
            <textarea id="leadNotes" rows="2" class="w-full rounded-xl border-gray-200" placeholder="Condition, timeline, motivation, mortgage, termsâ€¦"></textarea>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <button type="submit" class="btn btn-primary"><i data-lucide="plus"></i>Add Lead</button>
            <button id="importLeadsBtn" type="button" class="btn btn-outline"><i data-lucide="file-up"></i>Import CSV</button>
            <input id="importLeadsInput" type="file" accept=".csv" class="hidden" />
          </div>
          <button id="privyBulkImportBtn" type="button" class="btn btn-accent w-full mt-2"><i data-lucide="upload-cloud"></i>Bulk Import from Privy</button>
          <p class="text-xs text-gray-500">CSV headers: address, seller, phone, email, agent, arv, repairs, ask, notes, source</p>
        </form>
      </section>

      <!-- Sprint queue -->
      <section class="lg:col-span-1 card">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Today's Sprint (Top 20 by Score & Due)</h2>
          <div class="text-sm text-gray-500" id="sprintCount"></div>
        </div>
        <div class="flex flex-wrap gap-2 mb-2">
          <input id="leadSearch" class="rounded-xl border-gray-200 w-full" placeholder="Search address / contact" />
          <select id="leadFilter" class="rounded-xl border-gray-200">
            <option value="">All</option><option>New</option><option>Contacted</option><option>Follow-Up</option><option>Offer Out</option><option>Dead</option>
          </select>
        </div>
        <div id="leadList" class="space-y-3 max-h-[70vh] overflow-auto"></div>
      </section>

      <!-- Scripts & quick actions -->
      <section class="lg:col-span-1 card">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold">Pro Scripts</h2>
          <label class="text-xs flex items-center gap-1"><input id="agentScriptMode" type="checkbox" class="accent-brand-500"> Agent Mode</label>
        </div>
        <div class="space-y-3 text-sm">
          <details class="border rounded-xl p-3 bg-white dark:bg-[#0b1322]" open>
            <summary class="font-semibold cursor-pointer">Expired Listing (Agent)</summary>
            <p class="mt-2" id="scriptExpiredAgent">Hey {{agent}}, this is {{me}}. I saw {{address}} came off the market. I buy a few homes a month in {{city}} â€” quick and hassle-free. Two options: clean cash close or we keep the existing financing in place and pay on time. Which nets your seller more if speed isn't the only goal?</p>
            <div class="flex gap-2 mt-2"><button class="btn btn-outline text-xs" data-script-copy>Copy</button></div>
          </details>
          <details class="border rounded-xl p-3 bg-white dark:bg-[#0b1322]">
            <summary class="font-semibold cursor-pointer">Seller â€” Subject-To Opener</summary>
            <p class="mt-2" id="scriptSubjectTo">If I cover your payments â€” taxes, insurance, maintenance â€” so you can move on with no stress, what would you need to feel good today? I'll show exact numbers & timing in writing.</p>
            <div class="flex gap-2 mt-2"><button class="btn btn-outline text-xs" data-script-copy>Copy</button></div>
          </details>
          <details class="border rounded-xl p-3 bg-white dark:bg-[#0b1322]">
            <summary class="font-semibold cursor-pointer">Follow-Up Text</summary>
            <p class="mt-2" id="scriptFollowUp">Hey {{name}}, it's {{me}} about {{address}} â€” still open to a quick offer? I can make the process easy. Want a simple cash number or a terms option that could net you more?</p>
            <div class="flex gap-2 mt-2"><button class="btn btn-outline text-xs" data-script-copy>Copy</button></div>
          </details>

          <!-- Offer Versioning -->
          <div class="border rounded-xl p-3 bg-white dark:bg-[#0b1322]">
            <div class="font-semibold mb-2">Offer Versioning (Cash & Terms)</div>
            <div class="grid gap-2">
              <input id="offerEmailTo" class="rounded-xl border-gray-200" placeholder="To (agent or seller)" />
              <div class="grid sm:grid-cols-2 gap-2">
                <label class="text-xs">Cash % of MAO: <input id="offerCashPct" type="number" value="100" min="50" max="110" class="w-20 rounded-xl border-gray-200 ml-1"></label>
                <label class="text-xs">Terms Down (% ARV): <input id="offerTermsDownPct" type="number" value="5" min="0" max="30" class="w-20 rounded-xl border-gray-200 ml-1"></label>
              </div>
              <div class="grid sm:grid-cols-2 gap-2">
                <label class="text-xs">Interest: <input id="offerTermsRate" type="number" value="4.5" step="0.1" class="w-24 rounded-xl border-gray-200 ml-1">%</label>
                <label class="text-xs">Amort (yrs): <input id="offerTermsAmort" type="number" value="30" class="w-20 rounded-xl border-gray-200 ml-1"></label>
              </div>
              <div class="grid sm:grid-cols-2 gap-2">
                <button id="sendCashOfferBtn" class="btn btn-primary"><i data-lucide="send"></i>Cash Offer</button>
                <button id="sendTermsOfferBtn" class="btn btn-outline"><i data-lucide="send"></i>Terms Offer</button>
              </div>
              <button id="sendBothOffersBtn" class="btn btn-accent"><i data-lucide="sparkles"></i>Send Both</button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Uses EmailJS + Supabase link uploads. Configure in Settings once.</p>
          </div>
        </div>
      </section>
    </section>

    <!-- CONTRACTS -->
    <section id="tab-contracts" class="hidden grid lg:grid-cols-3 gap-6">
      <section class="lg:col-span-2 card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Create Contract</h2>
          <div class="text-xs text-gray-500">Data saved locally</div>
        </div>
        <form id="dealForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Business Name</label>
            <input class="w-full rounded-xl border-gray-200 focus:outline-none focus:ring-[var(--ring)]" id="bizName" placeholder="Your LLC Name" required />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Business Address</label>
            <input class="w-full rounded-xl border-gray-200" id="bizAddress" placeholder="123 Main St, City, ST 00000" required />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Property Address</label>
            <input class="w-full rounded-xl border-gray-200" id="propertyAddress" placeholder="456 Elm St, City, ST 00000" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Seller Name(s)</label>
            <input class="w-full rounded-xl border-gray-200" id="sellerNames" placeholder="First Last; First Last" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Purchase Price ($)</label>
            <input type="number" class="w-full rounded-xl border-gray-200" id="purchasePrice" placeholder="250000" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Assignment Fee ($)</label>
            <input type="number" class="w-full rounded-xl border-gray-200" id="assignmentFee" placeholder="0" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Deal Specifics / Terms</label>
            <textarea class="w-full rounded-xl border-gray-200" id="dealTerms" rows="3" placeholder="Inspection days, earnest money, subject-to details, closing timeline, concessions, etc."></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Contract Template</label>
            <select id="contractTemplate" class="w-full rounded-xl border-gray-200">
              <option value="standard">Standard Purchase</option>
              <option value="subject_to">Subject-To Addendum</option>
              <option value="assignment">Assignment Agreement</option>
              <option value="jv">JV Agreement</option>
              <option value="authorization">Authorization to Release</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Pipeline Status</label>
            <select id="status" class="w-full rounded-xl border-gray-200">
              <option value="lead">Lead</option><option value="offer">Offer Out</option><option value="pending">Pending Signature</option>
              <option value="sent">Sent to Seller</option><option value="signed">Signed</option><option value="attorney">To Attorney / Title</option><option value="closed">Closed</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Property Photo</label>
            <div id="photoDrop" class="dropzone">Tap to upload (or drop)</div>
            <input type="file" id="photoInput" accept="image/*" class="hidden" />
            <div id="photoPreview" class="mt-2 hidden"><img id="photoImg" class="w-full h-36 object-cover rounded-xl border"/></div>
          </div>
          <div class="md:col-span-2 grid grid-cols-2 sm:grid-cols-4 gap-3 mt-2">
            <button type="button" id="genPdfBtn" class="btn btn-outline"><i data-lucide="file-text"></i>PDF</button>
            <button type="submit" class="btn btn-primary"><i data-lucide="save"></i>Save</button>
            <button type="button" id="dealFromLeadBtn" class="btn btn-accent"><i data-lucide="arrow-right"></i>Pre-fill from Selected Lead</button>
            <button type="button" id="openAttachBtn" class="btn btn-outline"><i data-lucide="paperclip"></i>Attachments</button>
          </div>
          <div class="md:col-span-2">
            <div class="mt-6 p-3 rounded-xl border">
              <div class="font-medium mb-2">Email Contract (Supabase Link)</div>
              <div class="grid md:grid-cols-3 gap-3">
                <input class="rounded-xl border-gray-200" id="emailTo" placeholder="Seller Email" />
                <input class="rounded-xl border-gray-200" id="emailjsService" placeholder="EmailJS Service ID" />
                <input class="rounded-xl border-gray-200" id="emailjsTemplate" placeholder="EmailJS Template ID" />
                <input class="rounded-xl border-gray-200 md:col-span-2" id="emailjsPublic" placeholder="EmailJS Public Key" />
                <button id="sendEmailBtn" type="button" class="btn btn-outline"><i data-lucide="send"></i>Send Email (Link)</button>
              </div>
              <p class="text-xs text-gray-500 mt-2">Set Supabase URL/Key in Settings once.</p>
            </div>
          </div>
        </form>
      </section>

      <!-- Deals Table + Dispo Blast -->
      <section class="card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Deals</h2>
          <div class="flex items-center gap-2">
            <input id="search" class="rounded-xl border-gray-200" placeholder="Search address/seller" />
            <select id="filterStatus" class="rounded-xl border-gray-200">
              <option value="">All</option><option value="lead">Lead</option><option value="offer">Offer</option><option value="pending">Pending</option>
              <option value="sent">Sent</option><option value="signed">Signed</option><option value="attorney">Attorney</option><option value="closed">Closed</option>
            </select>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="text-left text-gray-500">
              <tr><th class="py-2 pr-4">Property</th><th class="py-2 pr-4">Seller(s)</th><th class="py-2 pr-4">Price</th><th class="py-2 pr-4">Fee</th><th class="py-2 pr-4">Status</th><th class="py-2 pr-4">Actions</th></tr>
            </thead>
            <tbody id="dealRows"></tbody>
          </table>
        </div>
        <div class="mt-6 border-t pt-4">
          <h3 class="font-semibold mb-2">Dispo Blast</h3>
          <div class="grid gap-2">
            <input id="dispoTags" class="rounded-xl border-gray-200" placeholder="Buyer tags (e.g. 30318; <200k; rehab)" />
            <textarea id="dispoBody" rows="3" class="rounded-xl border-gray-200" placeholder="Short deal description + link..."></textarea>
            <button id="dispoSendBtn" class="btn btn-primary"><i data-lucide="megaphone"></i>Send to Matching Buyers</button>
            <p class="text-xs text-gray-500">Matches buyers whose criteria include any of the tags (semicolon or comma separated).</p>
          </div>
        </div>
      </section>
    </section>

    <!-- PIPELINE -->
    <section id="tab-pipeline" class="hidden">
      <aside class="card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Pipeline Board</h2>
          <div class="text-sm text-gray-500" id="dealCount"></div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          <div><div class="text-xs font-semibold mb-2">Lead</div><div id="col-lead" class="kanban-col" data-status="lead"></div></div>
          <div><div class="text-xs font-semibold mb-2">Offer</div><div id="col-offer" class="kanban-col" data-status="offer"></div></div>
          <div><div class="text-xs font-semibold mb-2">Pending</div><div id="col-pending" class="kanban-col" data-status="pending"></div></div>
          <div><div class="text-xs font-semibold mb-2">Sent</div><div id="col-sent" class="kanban-col" data-status="sent"></div></div>
          <div><div class="text-xs font-semibold mb-2">Signed</div><div id="col-signed" class="kanban-col" data-status="signed"></div></div>
          <div><div class="text-xs font-semibold mb-2">Attorney</div><div id="col-attorney" class="kanban-col" data-status="attorney"></div></div>
          <div class="sm:col-span-2 lg:col-span-3"><div class="text-xs font-semibold mb-2">Closed</div><div id="col-closed" class="kanban-col" data-status="closed"></div></div>
        </div>
      </aside>
    </section>

    <!-- SIGNER -->
    <section id="tab-signer" class="hidden">
      <div class="grid lg:grid-cols-3 gap-6">
        <section class="card lg:col-span-2">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Sign Documents</h2>
            <div class="text-xs text-gray-500">Upload PDF â†’ place fields â†’ finalize</div>
          </div>
          <div class="flex flex-wrap items-center gap-2 mb-3">
            <input id="pdfFile" type="file" accept="application/pdf" class="hidden" />
            <label for="pdfFile" class="btn btn-outline"><i data-lucide="file-up"></i>Upload PDF</label>
            <button id="addSigBtn" class="btn btn-accent" disabled><i data-lucide="pen-line"></i>Signature</button>
            <button id="addInitBtn" class="btn btn-outline" disabled><i data-lucide="signature"></i>Initials</button>
            <button id="finishBtn" class="btn btn-primary" disabled><i data-lucide="check-circle-2"></i>Finalize</button>
          </div>

          <!-- Typed signature/initials controls -->
          <div class="grid md:grid-cols-2 gap-3 mb-3">
            <div class="border rounded-xl p-3 bg-white dark:bg-[#0b1322]">
              <div class="font-semibold text-sm mb-2">Typed Signature (Adobe-style)</div>
              <div class="flex gap-2 mb-2">
                <input id="typedSigInput" class="rounded-xl border-gray-200 w-full" placeholder="Type your full name" />
                <select id="typedSigFont" class="rounded-xl border-gray-200">
                  <option value="'Great Vibes', cursive">Great Vibes</option>
                  <option value="'Dancing Script', cursive">Dancing Script</option>
                  <option value="'Pacifico', cursive">Pacifico</option>
                  <option value="'Satisfy', cursive">Satisfy</option>
                </select>
              </div>
              <button id="typedSigGenerate" class="btn btn-outline text-xs"><i data-lucide="wand-2"></i>Generate Signature</button>
            </div>
            <div class="border rounded-xl p-3 bg-white dark:bg-[#0b1322]">
              <div class="font-semibold text-sm mb-2">Typed Initials</div>
              <div class="flex gap-2 mb-2">
                <input id="typedInitInput" class="rounded-xl border-gray-200 w-full" placeholder="Type your initials" />
                <select id="typedInitFont" class="rounded-xl border-gray-200">
                  <option value="'Great Vibes', cursive">Great Vibes</option>
                  <option value="'Dancing Script', cursive">Dancing Script</option>
                  <option value="'Pacifico', cursive">Pacifico</option>
                  <option value="'Satisfy', cursive">Satisfy</option>
                </select>
              </div>
              <button id="typedInitGenerate" class="btn btn-outline text-xs"><i data-lucide="wand-2"></i>Generate Initials</button>
            </div>
          </div>
          <div id="pdfContainer" class="pdf-pages space-y-4 max-h-[70vh] overflow-auto bg-white dark:bg-[#0b1322] rounded-xl p-3 border"></div>
        </section>
        <aside class="card">
          <h3 class="font-semibold mb-2">Signer (Draw if you prefer)</h3>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">Draw once, then tap pages to place. Or use the typed options on the left.</p>
          <div class="space-y-3">
            <div>
              <label class="text-xs font-semibold">Signature (draw)</label>
              <canvas id="sigPad" class="sig w-full h-40 bg-white border rounded-xl"></canvas>
              <div class="flex gap-2 mt-2">
                <button id="sigClear" class="btn btn-outline text-xs">Clear</button>
                <button id="sigSave" class="btn btn-primary text-xs">Save Signature</button>
              </div>
            </div>
            <div>
              <label class="text-xs font-semibold">Initials (draw)</label>
              <canvas id="initPad" class="sig w-full h-24 bg-white border rounded-xl"></canvas>
              <div class="flex gap-2 mt-2">
                <button id="initClear" class="btn btn-outline text-xs">Clear</button>
                <button id="initSave" class="btn btn-primary text-xs">Save Initials</button>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <!-- BUYERS -->
    <section id="tab-buyers" class="hidden">
      <div class="card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Buyers CRM</h2>
          <button id="addBuyerBtn" class="btn btn-primary"><i data-lucide="user-plus"></i>Add Buyer</button>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="text-left text-gray-500">
              <tr><th class="py-2 pr-4">Buyer</th><th class="py-2 pr-4">Email</th><th class="py-2 pr-4">Phone</th><th class="py-2 pr-4">Criteria/Tags</th><th class="py-2 pr-4">Notes</th><th class="py-2 pr-4">Actions</th></tr>
            </thead>
            <tbody id="buyerRows"></tbody>
          </table>
        </div>
      </div>
    </section>

   <!-- AGENT NETWORK TAB -->
<section id="tab-agent-outreach" class="hidden">
  <div class="grid lg:grid-cols-3 gap-6">
    <!-- Agent Management -->
    <section class="card lg:col-span-2">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Agent Network Management</h2>
        <button id="addAgentBtn" class="btn btn-primary"><i data-lucide="user-plus"></i>Add Agent</button>
      </div>
      
      <div class="flex flex-wrap gap-2 mb-4">
        <input id="agentSearch" class="rounded-xl border-gray-200 flex-1" placeholder="Search agents..." />
        <select id="agentFilter" class="rounded-xl border-gray-200">
          <option value="">All Agents</option>
          <option value="active">Active</option>
          <option value="warm">Warm</option>
          <option value="cold">Cold</option>
          <option value="exclusive">Exclusive Partner</option>
        </select>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-gray-500">
            <tr>
              <th class="py-2 pr-4">Agent</th>
              <th class="py-2 pr-4">Brokerage</th>
              <th class="py-2 pr-4">Area</th>
              <th class="py-2 pr-4">Relationship</th>
              <th class="py-2 pr-4">Deals</th>
              <th class="py-2 pr-4">Last Contact</th>
              <th class="py-2 pr-4">Actions</th>
            </tr>
          </thead>
          <tbody id="agentRows"></tbody>
        </table>
      </div>
    </section>

    <!-- Agent Scripts & Outreach -->
    <section class="card">
      <h3 class="font-semibold mb-3">Agent Scripts & Templates</h3>
      
      <div class="space-y-3 text-sm">
        <details class="border rounded-xl p-3 bg-white dark:bg-[#0b1322]" open>
          <summary class="font-semibold cursor-pointer">Initial Agent Introduction</summary>
          <p class="mt-2">Hi [Agent Name], this is [Your Name] with [Company]. I'm a local investor who closes 3-5 deals monthly. I'd love to discuss how we can work together on deals that need quick cash closes or creative financing. When's a good time to chat about potential partnerships?</p>
          <div class="flex gap-2 mt-2"><button class="btn btn-outline text-xs" data-script-copy>Copy</button></div>
        </details>

        <details class="border rounded-xl p-3 bg-white dark:bg-[#0b1322]">
          <summary class="font-semibold cursor-pointer">Referral Request</summary>
          <p class="mt-2">Hey [Agent Name], hope you're doing well! I'm looking for distressed properties or sellers who need quick closes in [Area]. Anything 20%+ below market that needs work. I can close in 7-14 days cash or offer subject-to terms. Commission protected. Any leads?</p>
          <div class="flex gap-2 mt-2"><button class="btn btn-outline text-xs" data-script-copy>Copy</button></div>
        </details>

        <details class="border rounded-xl p-3 bg-white dark:bg-[#0b1322]">
          <summary class="font-semibold cursor-pointer">Follow-Up After Deal</summary>
          <p class="mt-2">Thanks again for the [Property Address] deal! Quick $[Amount] close as promised. I'm always looking for more opportunities like this. Mind if I send you my buying criteria sheet? I have cash ready for the right deals.</p>
          <div class="flex gap-2 mt-2"><button class="btn btn-outline text-xs" data-script-copy>Copy</button></div>
        </details>

        <details class="border rounded-xl p-3 bg-white dark:bg-[#0b1322]">
          <summary class="font-semibold cursor-pointer">MLS Access Request</summary>
          <p class="mt-2">Hi [Agent Name], I've been analyzing the [Area] market and see some opportunities for quick flips. Would you be open to setting up MLS access so I can identify properties that fit my criteria? I typically close 1-2 deals per month and always protect your commission.</p>
          <div class="flex gap-2 mt-2"><button class="btn btn-outline text-xs" data-script-copy>Copy</button></div>
        </details>
      </div>

      <!-- Bulk Agent Outreach -->
      <div class="mt-6 p-3 rounded-xl border bg-white dark:bg-[#0b1322]">
        <h4 class="font-semibold mb-3">Bulk Agent Outreach</h4>
        <div class="space-y-3">
          <select id="bulkMessageTemplate" class="w-full rounded-xl border-gray-200">
            <option value="">Select template...</option>
            <option value="intro">Initial Introduction</option>
            <option value="referral">Referral Request</option>
            <option value="market_update">Market Update</option>
            <option value="deal_alert">Deal Alert</option>
          </select>
          <textarea id="customBulkMessage" rows="4" class="w-full rounded-xl border-gray-200" placeholder="Custom message..."></textarea>
          <div class="flex gap-2">
            <button id="sendBulkEmailBtn" class="btn btn-primary text-xs">Send Bulk Email</button>
            <button id="scheduleBulkBtn" class="btn btn-outline text-xs">Schedule</button>
          </div>
          <p class="text-xs text-gray-500">Select agents above, then send targeted messages</p>
        </div>
      </div>
    </section>
  </div>
</section>
    <!-- EXTENDED PIPELINE TAB -->
<section id="tab-extended-pipeline" class="hidden">
  <div class="grid gap-6">
    <!-- Pipeline Overview -->
    <section class="card">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Extended Pipeline Management</h2>
        <div class="flex items-center gap-2">
          <select id="pipelineTimeframe" class="rounded-xl border-gray-200">
            <option value="30">30 Days</option>
            <option value="60">60 Days</option>
            <option value="90" selected>90 Days</option>
            <option value="120">120 Days</option>
          </select>
          <span class="text-sm text-gray-500" id="extendedPipelineCount">0 deals</span>
        </div>
      </div>

      <!-- Pipeline Categories -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="p-4 rounded-xl border bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20">
          <div class="text-sm text-blue-600 dark:text-blue-400">MLS Opportunities</div>
          <div class="text-2xl font-bold text-blue-700 dark:text-blue-300" id="mlsCount">0</div>
          <div class="text-xs text-blue-500">Avg 45 days</div>
        </div>
        <div class="p-4 rounded-xl border bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20">
          <div class="text-sm text-green-600 dark:text-green-400">Agent Referrals</div>
          <div class="text-2xl font-bold text-green-700 dark:text-green-300" id="referralCount">0</div>
          <div class="text-xs text-green-500">Avg 30 days</div>
        </div>
        <div class="p-4 rounded-xl border bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20">
          <div class="text-sm text-purple-600 dark:text-purple-400">Complex Deals</div>
          <div class="text-2xl font-bold text-purple-700 dark:text-purple-300" id="complexCount">0</div>
          <div class="text-xs text-purple-500">Avg 75 days</div>
        </div>
        <div class="p-4 rounded-xl border bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-900/20 dark:to-orange-800/20">
          <div class="text-sm text-orange-600 dark:text-orange-400">Joint Ventures</div>
          <div class="text-2xl font-bold text-orange-700 dark:text-orange-300" id="jvCount">0</div>
          <div class="text-xs text-orange-500">Avg 60 days</div>
        </div>
      </div>

      <!-- Extended Pipeline Board -->
      <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
        <div class="kanban-column">
          <div class="text-xs font-semibold mb-2 text-gray-600">Research</div>
          <div id="col-research" class="kanban-col min-h-[300px]" data-status="research"></div>
        </div>
        <div class="kanban-column">
          <div class="text-xs font-semibold mb-2 text-gray-600">Agent Contact</div>
          <div id="col-agent-contact" class="kanban-col min-h-[300px]" data-status="agent-contact"></div>
        </div>
        <div class="kanban-column">
          <div class="text-xs font-semibold mb-2 text-gray-600">Negotiation</div>
          <div id="col-negotiation" class="kanban-col min-h-[300px]" data-status="negotiation"></div>
        </div>
        <div class="kanban-column">
          <div class="text-xs font-semibold mb-2 text-gray-600">Due Diligence</div>
          <div id="col-due-diligence" class="kanban-col min-h-[300px]" data-status="due-diligence"></div>
        </div>
        <div class="kanban-column">
          <div class="text-xs font-semibold mb-2 text-gray-600">Ready to Contract</div>
          <div id="col-ready-contract" class="kanban-col min-h-[300px]" data-status="ready-contract"></div>
        </div>
      </div>
    </section>

    <!-- Extended Deal Form -->
    <section class="card">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-semibold">Add Extended Pipeline Deal</h3>
        <button id="moveSprintToExtendedBtn" class="btn btn-outline text-sm">Move from Sprint</button>
      </div>
      
      <form id="extendedDealForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Property Address</label>
          <input id="extPropertyAddress" class="w-full rounded-xl border-gray-200" required />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Deal Type</label>
          <select id="extDealType" class="w-full rounded-xl border-gray-200" required>
            <option value="mls">MLS Opportunity</option>
            <option value="agent-referral">Agent Referral</option>
            <option value="complex">Complex/Probate/Divorce</option>
            <option value="joint-venture">Joint Venture</option>
            <option value="wholesale">Wholesale Assignment</option>
            <option value="fix-flip">Fix & Flip</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Expected Timeline</label>
          <select id="extTimeline" class="w-full rounded-xl border-gray-200">
            <option value="30">30 Days</option>
            <option value="60">60 Days</option>
            <option value="90">90 Days</option>
            <option value="120">120+ Days</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">List Price</label>
          <input id="extListPrice" type="number" class="w-full rounded-xl border-gray-200" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">ARV Estimate</label>
          <input id="extARV" type="number" class="w-full rounded-xl border-gray-200" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Repair Estimate</label>
          <input id="extRepairs" type="number" class="w-full rounded-xl border-gray-200" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Agent Name</label>
          <input id="extAgentName" class="w-full rounded-xl border-gray-200" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Commission %</label>
          <input id="extCommission" type="number" step="0.5" value="3" class="w-full rounded-xl border-gray-200" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Priority</label>
          <select id="extPriority" class="w-full rounded-xl border-gray-200">
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high" selected>High</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
        <div class="md:col-span-3">
          <label class="block text-sm font-medium mb-1">Deal Notes</label>
          <textarea id="extNotes" rows="3" class="w-full rounded-xl border-gray-200" placeholder="Special circumstances, key contacts, negotiation notes..."></textarea>
        </div>
        <div class="md:col-span-3 flex gap-3">
          <button type="submit" class="btn btn-primary" data-lucide-ignore>Add to Extended Pipeline</button>
          <button type="button" id="analyzeExtDealBtn" class="btn btn-outline" data-lucide-ignore>Analyze Deal</button>
          <button type="button" id="scheduleFollowUpBtn" class="btn btn-outline" data-lucide-ignore>Schedule Follow-up</button>
        </div>
      </form>
    </section>
  </div>
</section>
    
    <!-- KPI -->
    <section id="tab-kpi" class="hidden">
      <div class="grid lg:grid-cols-3 gap-6">
        <section class="card lg:col-span-2">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">KPI Dashboard</h2>
            <span class="text-xs text-gray-500">Auto-calculated</span>
          </div>
          <div class="grid sm:grid-cols-2 gap-4">
            <div class="p-4 rounded-xl border bg-white dark:bg-[#0b1322]">
              <div class="text-gray-500 text-sm">Conversations this week</div>
              <div class="flex items-center justify-between"><div id="kpiConvos" class="text-2xl font-semibold">0</div><div id="kpiConvosTarget" class="text-gray-500"></div></div>
              <div class="meter mt-2"><i id="kpiConvosMeter" style="width:0%"></i></div>
            </div>
            <div class="p-4 rounded-xl border bg-white dark:bg-[#0b1322]">
              <div class="text-gray-500 text-sm">Offers sent this week</div>
              <div class="flex items-center justify-between"><div id="kpiOffers" class="text-2xl font-semibold">0</div><div id="kpiOffersTarget" class="text-gray-500"></div></div>
              <div class="meter mt-2"><i id="kpiOffersMeter" style="width:0%"></i></div>
            </div>
            <div class="p-4 rounded-xl border bg-white dark:bg-[#0b1322]">
              <div class="text-gray-500 text-sm">Contracts this month</div>
              <div class="flex items-center justify-between"><div id="kpiContracts" class="text-2xl font-semibold">0</div><div id="kpiContractsTarget" class="text-gray-500"></div></div>
              <div class="meter mt-2"><i id="kpiContractsMeter" style="width:0%"></i></div>
            </div>
            <div class="p-4 rounded-xl border bg-white dark:bg-[#0b1322]">
              <div class="text-gray-500 text-sm">Assignment $ this month</div>
              <div class="flex items-center justify-between"><div id="kpiFees" class="text-2xl font-semibold">$0</div><div class="text-gray-500">Goal: $35,000/mo</div></div>
              <div class="meter mt-2"><i id="kpiFeesMeter" style="width:0%"></i></div>
            </div>
          </div>

          <!-- Daily Activity Tracker -->
          <div class="mt-6 p-4 rounded-xl border bg-white dark:bg-[#0b1322]">
            <h3 class="font-semibold mb-3">Daily Activity Tracker</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
              <div class="border rounded-lg p-2">
                <div class="text-xs text-gray-500">Privy Searches Today</div>
                <div id="privySearchesToday" class="text-lg font-semibold">0</div>
              </div>
              <div class="border rounded-lg p-2">
                <div class="text-xs text-gray-500">Offers Sent Today</div>
                <div id="offersSentToday" class="text-lg font-semibold">0</div>
              </div>
              <div class="border rounded-lg p-2">
                <div class="text-xs text-gray-500">Follow-ups Today</div>
                <div id="followUpsToday" class="text-lg font-semibold">0</div>
              </div>
              <div class="border rounded-lg p-2">
                <div class="text-xs text-gray-500">Response Rate</div>
                <div id="responseRate" class="text-lg font-semibold">0%</div>
              </div>
            </div>

            <!-- Weekly Conversion Funnel -->
            <div class="mt-4">
              <h4 class="font-medium text-sm mb-2">Weekly Conversion Funnel</h4>
              <div class="space-y-2">
                <div class="flex items-center justify-between">
                  <span class="text-xs">Searches â†’ Offers</span>
                  <span id="searchToOfferRate" class="text-xs font-semibold">0%</span>
                </div>
                <div class="meter"><i id="searchToOfferMeter" style="width:0%"></i></div>
                <div class="flex items-center justify-between">
                  <span class="text-xs">Offers â†’ Contracts</span>
                  <span id="offerToContractRate" class="text-xs font-semibold">0%</span>
                </div>
                <div class="meter"><i id="offerToContractMeter" style="width:0%"></i></div>
              </div>
            </div>

            <!-- Pace to Goal -->
            <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
              <div class="text-sm font-medium">Monthly Pace</div>
              <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                <div>Target: 3-5 deals/month = $35,000</div>
                <div id="monthlyPace" class="mt-1"></div>
                <div id="paceRecommendation" class="mt-1 text-blue-700 dark:text-blue-300"></div>
              </div>
            </div>
          </div>
        </section>
        <aside class="card">
          <h3 class="font-semibold mb-3">Targets</h3>
          <div class="grid gap-3 text-sm">
            <div><label>Weekly Conversations</label><input id="goalConvos" type="number" class="w-full rounded-xl border-gray-200" value="50" /></div>
            <div><label>Weekly Offers</label><input id="goalOffers" type="number" class="w-full rounded-xl border-gray-200" value="10" /></div>
            <div><label>Monthly Contracts</label><input id="goalContracts" type="number" class="w-full rounded-xl border-gray-200" value="5" /></div>
            <button id="saveGoalsBtn" class="btn btn-primary">Save Goals</button>
            <p class="text-xs text-gray-500">Rule: 50 quality convos â†’ 10 offers â†’ 3â€“5 contracts.</p>
          </div>

          <!-- Quick Actions -->
          <div class="mt-6 pt-6 border-t">
            <h3 class="font-semibold mb-3">Quick Actions</h3>
            <div class="grid gap-2">
              <button id="logPrivySearchBtn" class="btn btn-outline text-sm"><i data-lucide="search"></i>Log Privy Search</button>
              <button id="markOfferSentBtn" class="btn btn-outline text-sm"><i data-lucide="send"></i>Mark Offer Sent</button>
              <button id="viewActivityLogBtn" class="btn btn-outline text-sm"><i data-lucide="bar-chart-2"></i>Activity Log</button>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="hidden">
      <div class="grid lg:grid-cols-2 gap-6">
        <section class="card">
          <h2 class="text-lg font-semibold mb-3">Supabase Storage</h2>
          <div class="grid gap-3">
            <input id="sbUrl" class="rounded-xl border-gray-200" placeholder="https://YOUR-PROJECT.supabase.co" />
            <input id="sbAnon" class="rounded-xl border-gray-200" placeholder="ANON PUBLIC KEY" />
            <input id="sbBucket" class="rounded-xl border-gray-200" placeholder="Bucket (contracts)" value="contracts" />
            <button id="saveSbBtn" class="btn btn-primary">Save Supabase</button>
            <p class="text-xs text-gray-500">Create a public bucket in Supabase Storage.</p>
          </div>
        </section>
        <section class="card">
          <h2 class="text-lg font-semibold mb-3">EmailJS</h2>
          <div class="grid gap-3">
            <input id="ejService" class="rounded-xl border-gray-200" placeholder="Service ID" />
            <input id="ejTemplate" class="rounded-xl border-gray-200" placeholder="Template ID" />
            <input id="ejPublic" class="rounded-xl border-gray-200" placeholder="Public Key" />
            <button id="saveEjBtn" class="btn btn-primary">Save EmailJS</button>
            <p class="text-xs text-gray-500">Template can use {{bizName}}, {{sellerNames}}, {{propertyAddress}}, {{link}}, etc.</p>
          </div>
        </section>
      </div>
    </section>
  </div>
<!-- ANALYZERS TAB -->
<section id="analyzers" class="hidden" data-tab-panel="analyzers">
  <div class="grid lg:grid-cols-2 gap-6">
    <!-- Wholesale Analyzer -->
    <div class="analyzer-card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-lg">ðŸ  Wholesale Analyzer</h3>
        <i data-lucide="calculator" class="w-5 h-5 text-brand-500"></i>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <input id="wsARV" type="number" class="rounded-lg border-gray-300" placeholder="ARV $" />
        <input id="wsRepairs" type="number" class="rounded-lg border-gray-300" placeholder="Repairs $" />
        <input id="wsAsk" type="number" class="rounded-lg border-gray-300" placeholder="Asking Price $" />
        <input id="wsFee" type="number" class="rounded-lg border-gray-300" placeholder="Assignment Fee $" value="10000" />
      </div>
      <div id="wsResults" class="analyzer-result">
        <div class="analyzer-metric">
          <div id="wsMAO" class="value">$0</div>
          <div class="label">Max Offer (70%)</div>
        </div>
        <div class="analyzer-metric">
          <div id="wsSpread" class="value">$0</div>
          <div class="label">Deal Spread</div>
        </div>
        <div class="analyzer-metric">
          <div id="wsROI" class="value">0%</div>
          <div class="label">ROI</div>
        </div>
        <div class="analyzer-metric">
          <div id="wsStrength" class="value">â€”</div>
          <div class="label">Deal Strength</div>
        </div>
      </div>
    </div>

    <!-- Subject-To Analyzer -->
    <div class="analyzer-card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-lg">ðŸ¡ Subject-To Analyzer</h3>
        <i data-lucide="home" class="w-5 h-5 text-green-500"></i>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <input id="stARV" type="number" class="rounded-lg border-gray-300" placeholder="ARV $" />
        <input id="stMortgage" type="number" class="rounded-lg border-gray-300" placeholder="Mortgage Balance $" />
        <input id="stPayment" type="number" class="rounded-lg border-gray-300" placeholder="Monthly Payment $" />
        <input id="stRent" type="number" class="rounded-lg border-gray-300" placeholder="Market Rent $" />
      </div>
      <div id="stResults" class="analyzer-result">
        <div class="analyzer-metric">
          <div id="stEquity" class="value">$0</div>
          <div class="label">Instant Equity</div>
        </div>
        <div class="analyzer-metric">
          <div id="stCashflow" class="value">$0</div>
          <div class="label">Monthly Cashflow</div>
        </div>
        <div class="analyzer-metric">
          <div id="stLTV" class="value">0%</div>
          <div class="label">LTV</div>
        </div>
        <div class="analyzer-metric">
          <div id="stRisk" class="value">â€”</div>
          <div class="label">Risk Level</div>
        </div>
      </div>
    </div>

    <!-- Fix & Flip Analyzer -->
    <div class="analyzer-card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-lg">ðŸ”¨ Fix & Flip Analyzer</h3>
        <i data-lucide="wrench" class="w-5 h-5 text-orange-500"></i>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <input id="ffPurchase" type="number" class="rounded-lg border-gray-300" placeholder="Purchase Price $" />
        <input id="ffARV" type="number" class="rounded-lg border-gray-300" placeholder="ARV $" />
        <input id="ffRepairs" type="number" class="rounded-lg border-gray-300" placeholder="Repair Costs $" />
        <input id="ffHoldMonths" type="number" class="rounded-lg border-gray-300" placeholder="Hold Months" value="6" />
        <input id="ffHoldCosts" type="number" class="rounded-lg border-gray-300" placeholder="Monthly Hold Costs $" value="2500" />
        <input id="ffSellCosts" type="number" class="rounded-lg border-gray-300" placeholder="Selling Costs %" value="8" />
      </div>
      <div id="ffResults" class="analyzer-result">
        <div class="analyzer-metric">
          <div id="ffProfit" class="value">$0</div>
          <div class="label">Net Profit</div>
        </div>
        <div class="analyzer-metric">
          <div id="ffROI" class="value">0%</div>
          <div class="label">ROI</div>
        </div>
        <div class="analyzer-metric">
          <div id="ffMargin" class="value">0%</div>
          <div class="label">Profit Margin</div>
        </div>
        <div class="analyzer-metric">
          <div id="ffRisk" class="value">â€”</div>
          <div class="label">Risk Level</div>
        </div>
      </div>
    </div>

    <!-- Airbnb Analyzer -->
    <div class="analyzer-card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-lg">ðŸ–ï¸ Airbnb Analyzer</h3>
        <i data-lucide="bed" class="w-5 h-5 text-purple-500"></i>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <input id="abPurchase" type="number" class="rounded-lg border-gray-300" placeholder="Purchase Price $" />
        <input id="abRehab" type="number" class="rounded-lg border-gray-300" placeholder="Rehab/Furnish $" />
        <input id="abNightlyRate" type="number" class="rounded-lg border-gray-300" placeholder="Nightly Rate $" />
        <input id="abOccupancy" type="number" class="rounded-lg border-gray-300" placeholder="Occupancy %" value="65" />
        <input id="abExpenses" type="number" class="rounded-lg border-gray-300" placeholder="Monthly Expenses $" />
        <input id="abDownPayment" type="number" class="rounded-lg border-gray-300" placeholder="Down Payment %" value="25" />
      </div>
      <div id="abResults" class="analyzer-result">
        <div class="analyzer-metric">
          <div id="abRevenue" class="value">$0</div>
          <div class="label">Monthly Revenue</div>
        </div>
        <div class="analyzer-metric">
          <div id="abCashflow" class="value">$0</div>
          <div class="label">Net Cashflow</div>
        </div>
        <div class="analyzer-metric">
          <div id="abROI" class="value">0%</div>
          <div class="label">Cash-on-Cash ROI</div>
        </div>
        <div class="analyzer-metric">
          <div id="abPayback" class="value">â€”</div>
          <div class="label">Payback Period</div>
        </div>
      </div>
    </div>
  </div>
</section>

  <!-- Bulk Import Modal -->
  <div id="bulkImportModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-[#0b1322] rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-auto p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">Bulk Import from Privy</h2>
        <button id="closeBulkImport" class="btn btn-outline text-sm"><i data-lucide="x"></i></button>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Step 1: Upload Privy Export</label>
        <input id="privyFileInput" type="file" accept=".csv" class="hidden" />
        <button id="selectPrivyFile" class="btn btn-outline"><i data-lucide="file-up"></i>Select CSV File</button>
        <span id="privyFileName" class="ml-3 text-sm text-gray-500"></span>
      </div>

      <div id="fieldMappingSection" class="hidden mb-4">
        <label class="block text-sm font-medium mb-2">Step 2: Map Fields</label>
        <p class="text-xs text-gray-500 mb-3">Match your Privy columns to the system fields</p>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div class="flex items-center justify-between">
            <span>Property Address:</span>
            <select id="mapAddress" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Owner Name:</span>
            <select id="mapOwner" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Mailing Address:</span>
            <select id="mapMailing" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Phone:</span>
            <select id="mapPhone" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Email:</span>
            <select id="mapEmail" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Est. Value/ARV:</span>
            <select id="mapARV" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Mortgage Balance:</span>
            <select id="mapMortgage" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Est. Equity:</span>
            <select id="mapEquity" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Property Type:</span>
            <select id="mapType" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Days on Market:</span>
            <select id="mapDOM" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>List Price:</span>
            <select id="mapListPrice" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Status/Notes:</span>
            <select id="mapStatus" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
        </div>

        <div class="mt-4">
          <label class="block text-sm font-medium mb-2">Import Settings</label>
          <div class="space-y-2">
            <label class="flex items-center gap-2 text-sm">
              <input id="skipDuplicates" type="checkbox" checked class="accent-brand-500">
              Skip duplicate addresses
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input id="autoCalcRepairs" type="checkbox" checked class="accent-brand-500">
              Auto-calculate repairs (25% of ARV for distressed)
            </label>
            <div class="flex items-center gap-2">
              <label class="text-sm">Default Source:</label>
              <select id="defaultSource" class="rounded-lg border-gray-200 text-sm">
                <option>Privy-Distressed</option>
                <option>Privy-HighEquity</option>
                <option>Privy-Absentee</option>
                <option>Privy-PreForeclosure</option>
                <option>Privy-Probate</option>
                <option>Privy-TaxLien</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div id="previewSection" class="hidden mb-4">
        <label class="block text-sm font-medium mb-2">Step 3: Preview Import</label>
        <div class="border rounded-lg p-3 bg-gray-50 dark:bg-gray-900 max-h-60 overflow-auto">
          <div id="importPreview" class="text-xs space-y-2"></div>
        </div>
        <div class="mt-2 text-sm">
          <span>Total rows: <span id="totalRows" class="font-semibold">0</span></span>
          <span class="ml-4">Valid leads: <span id="validLeads" class="font-semibold text-green-600">0</span></span>
          <span class="ml-4">Duplicates: <span id="duplicateCount" class="font-semibold text-yellow-600">0</span></span>
        </div>
      </div>

      <div class="flex gap-3 justify-end mt-6">
        <button id="cancelImport" class="btn btn-outline">Cancel</button>
        <button id="processImport" class="btn btn-primary hidden"><i data-lucide="upload"></i>Import Leads</button>
      </div>

      <div id="importProgress" class="hidden mt-4">
        <div class="text-sm mb-2">Importing... <span id="progressCount">0</span> / <span id="progressTotal">0</span></div>
        <div class="meter"><i id="progressBar" style="width:0%"></i></div>
      </div>
    </div>
  </div>

  <script>
    lucide.createIcons();
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // ========= 7-Day Sprint Data =========
    const sprintTasks = [
      { day: 1, task: "Log into Privy and run 3 different search filters (distressed, high equity, pre-foreclosure)" },
      { day: 1, task: "Export and organize leads from Privy into your lead management system" },
      { day: 1, task: "Research comparable sales (comps) for top 10 leads to validate ARV estimates" },
      { day: 2, task: "Make initial contact calls to top 10 highest-scored leads" },
      { day: 2, task: "Send follow-up texts to leads who didn't answer the phone" },
      { day: 2, task: "Email property information requests to listing agents for agent-listed properties" },
      { day: 3, task: "Follow up with leads who showed interest from Day 2 outreach" },
      { day: 3, task: "Calculate and present both cash and terms offers to qualified leads" },
      { day: 3, task: "Schedule property walkthrough appointments for serious prospects" },
      { day: 4, task: "Visit scheduled properties and conduct thorough inspections" },
      { day: 4, task: "Update repair estimates based on physical property inspections" },
      { day: 4, task: "Submit formal written offers (cash and/or subject-to) to qualified properties" },
      { day: 5, task: "Follow up on submitted offers and negotiate terms with sellers/agents" },
      { day: 5, task: "Execute purchase agreements for accepted offers" },
      { day: 5, task: "Begin buyer outreach for contracted properties (dispo blast)" },
      { day: 6, task: "Schedule and conduct property showings with qualified cash buyers" },
      { day: 6, task: "Negotiate assignment fees with interested buyers" },
      { day: 6, task: "Prepare assignment agreements for ready-to-close buyers" },
      { day: 7, task: "Coordinate with title companies/attorneys for closing logistics" },
      { day: 7, task: "Confirm all closing documents are prepared and signed" },
      { day: 7, task: "Plan next week's lead generation strategy based on this week's results" }
    ];

    // ========= STATE & ONE METRIC =========
    const state = {
      calls: JSON.parse(localStorage.getItem('calls') || '[]'),
      goals: JSON.parse(localStorage.getItem('goals') || '{"convos":50,"offers":10,"contracts":5}'),
      sprintTasks: JSON.parse(localStorage.getItem('sprintTasks') || 'null'),
      sprintStartDate: localStorage.getItem('sprintStartDate') || null,
      settings: {
        sbUrl: localStorage.getItem('SUPABASE_URL') || '',
        sbAnon: localStorage.getItem('SUPABASE_ANON') || '',
        sbBucket: localStorage.getItem('SUPABASE_BUCKET') || 'contracts',
        ejService: localStorage.getItem('EJ_SERVICE') || '',
        ejTemplate: localStorage.getItem('EJ_TEMPLATE') || '',
        ejPublic: localStorage.getItem('EJ_PUBLIC') || ''
      },
      leads: JSON.parse(localStorage.getItem('leads') || '[]'),
      deals: JSON.parse(localStorage.getItem('deals') || '[]'),
      buyers: JSON.parse(localStorage.getItem('buyers') || '[]'),
      signer: { 
        pdfBytes: null, 
        pages: [], 
        signatureUrl: null, 
        initialsUrl: null, 
        placements: [] 
      },
      selectedLeadId: null
    };
    
    state.agents = JSON.parse(localStorage.getItem('agents') || '[]');
    state.extendedDeals = JSON.parse(localStorage.getItem('extendedDeals') || '[]');

    // === PATCH: Deal Scoring & Pipeline Enhancements ===
state.dealScoring = {
  motivationWeight: 4,
  sourceQuality: {
    'Agent-Referral': 20,
    'Wholesaler-JV': 18,
    'Bird-Dog': 15,
    'PPC-Google': 12,
    'PPC-Facebook': 10,
    'Cold-Call': 8,
    'Direct-Mail': 7,
    'Privy-Distressed': 15,
    'Privy-PreForeclosure': 18,
    'Propstream-Absentee': 12,
    'BatchLeads-Probate': 16
  }
};

state.followUpSequences = {
  cold: [1, 3, 7, 14, 30, 45, 60],
  warm: [1, 2, 4, 7, 14, 21],
  offer: [1, 2, 3, 5, 7],
  contract: [1, 3, 5, 7, 10, 14]
};

state.pipelineStages = [
  "New Lead",
  "Initial Contact",
  "Analyzing",
  "Offer Submitted",
  "Negotiating",
  "Under Contract",
  "Due Diligence", 
  "Assigning/Closing",
  "Closed",
  "Dead"
];

// REPLACE all S3 sync implementations with this single unified version
// Place this after your state initialization (around line 1200)

const S3Sync = {
  API_BASE: "https://pocy3byloc.execute-api.us-east-1.amazonaws.com/prod",
  USER_ID: localStorage.getItem('mbpsCurrentUser') || 'owner',
  SYNC_INTERVAL: 5 * 60 * 1000, // 5 minutes
  
  isDirty: false,
  lastSync: parseInt(localStorage.getItem('lastS3Sync') || '0'),
  syncTimer: null,
  
  async getPresignedUrl(action = 'get') {
    const endpoint = action === 'get' ? '/getUrl' : '/putUrl';
    const url = `${this.API_BASE}${endpoint}?userId=${this.USER_ID}&file=deals.json`;
    const response = await fetch(url);
    const data = await response.json();
    return data.url;
  },
  
  markDirty() {
    this.isDirty = true;
    localStorage.setItem('hasUnsyncedChanges', 'true');
    this.updateIndicator();
  },
  
async push() {
  if (!this.isDirty) return true;
  
  try {
    const url = await this.getPresignedUrl('put');
    
    // Pull data from localStorage instead of undefined 'state'
    const fullData = {
      deals: JSON.parse(localStorage.getItem('deals') || '[]'),
      leads: JSON.parse(localStorage.getItem('leads') || '[]'),
      buyers: JSON.parse(localStorage.getItem('buyers') || '[]'),
      agents: JSON.parse(localStorage.getItem('agents') || '[]'),
      extendedDeals: JSON.parse(localStorage.getItem('extendedDeals') || '[]'),
      sprintTasks: JSON.parse(localStorage.getItem('sprintTasks') || '[]'),
      settings: JSON.parse(localStorage.getItem('settings') || '{}'),
      goals: JSON.parse(localStorage.getItem('goals') || '{}'),
      calls: JSON.parse(localStorage.getItem('calls') || '[]'),
      timestamp: Date.now()
    };
    
    const response = await fetch(url, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(fullData)
    });
    
    if (response.ok) {
      this.isDirty = false;
      this.lastSync = Date.now();
      localStorage.setItem('lastS3Sync', this.lastSync);
      localStorage.removeItem('hasUnsyncedChanges');
      console.log('âœ… Synced to S3');
      this.updateIndicator();
    }
    
    return response.ok;
  } catch (error) {
    console.error('S3 sync error:', error);
    return false;
  }
},
  
  async pull() {
    try {
      const url = await this.getPresignedUrl('get');
      const response = await fetch(url);
      
      if (response.status === 404) {
        console.log('No remote data yet');
        return null;
      }
      
      const remoteData = await response.json();
      return remoteData;
    } catch (error) {
      console.error('S3 pull error:', error);
      return null;
    }
  },
  
  updateIndicator() {
    const badge = document.getElementById('mbpsOutboxBadge');
    if (badge) {
      badge.textContent = this.isDirty ? 'Unsaved' : 'Synced';
      badge.className = this.isDirty ? 
        'badge mbps-status-warn' : 'badge mbps-status-ok';
    }
  },
  
  init() {
    // Start 5-minute sync timer
    this.syncTimer = setInterval(() => {
      if (this.isDirty) this.push();
    }, this.SYNC_INTERVAL);
    
    // Sync on important events
    window.addEventListener('beforeunload', () => {
      if (this.isDirty) this.push();
    });
    
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && this.isDirty) this.push();
    });
    
    // Check for unsaved changes
    if (localStorage.getItem('hasUnsyncedChanges') === 'true') {
      this.isDirty = true;
      setTimeout(() => this.push(), 3000);
    }
  }
};

// Replace ALL save() calls with saveWithSync()
function saveWithSync(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
  S3Sync.markDirty();
}

    if (!state.sprintTasks) {
      state.sprintTasks = sprintTasks.map((task, index) => ({
        ...task,
        id: `task-${index}`,
        completed: false,
        completedAt: null
      }));
      localStorage.setItem('sprintTasks', JSON.stringify(state.sprintTasks));
    }

    const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const money = (n)=> new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(Number(n||0));

    function saveCalls(){ localStorage.setItem('calls', JSON.stringify(state.calls)); }
    function saveSprintTasks(){ localStorage.setItem('sprintTasks', JSON.stringify(state.sprintTasks)); }

    function weekStartMs(){
      const d=new Date();
      const day=d.getDay();
      const diff=d.getDate()-day+(day===0?-6:1);
      const ws=new Date(d.setDate(diff));
      return new Date(ws.getFullYear(),ws.getMonth(),ws.getDate()).getTime();
    }

    function renderOneMetric(){
      const start=weekStartMs();
      const convos=state.calls.filter(c=>c.ts>=start).length;
      const goal=Number(state.goals.convos||50);
      document.getElementById('omValue').textContent = convos;
      document.getElementById('omTarget').textContent = `Goal ${goal}`;
      document.getElementById('omMeter').style.width = Math.min(100, Math.round((convos/goal)*100))+'%';
    }

    function logConvo(type, meta = {}) {
      state.calls.push({ type, ts: Date.now(), ...meta });
      saveCalls();
      renderOneMetric();
      updateKPI();
    }

    // Dashboard rendering function - ADD THIS BEFORE renderSevenDaySprint (around line 380)
function renderDashboard() {
  // Calculate metrics
  const activeDeals = (state.deals || []).filter(d => 
    !['Closed', 'Dead'].includes(d.status) && !d.archived
  ).length;
  
  const thisMonth = new Date();
  thisMonth.setDate(1);
  const monthlyDeals = (state.deals || []).filter(d => 
    d.closedAt && new Date(d.closedAt) >= thisMonth
  );
  const monthlyProfit = monthlyDeals.reduce((sum, d) => 
    sum + (Number(d.fee) || Number(d.assignmentFee) || 0), 0
  );
  
  const hotLeads = (state.leads || []).filter(l => {
    const score = typeof enhancedScoreLead === 'function' ? 
      enhancedScoreLead(l) : scoreLead(l);
    return score >= 70 && l.status !== 'Dead';
  });
  
  const totalLeads = (state.leads || []).length;
  const totalDeals = (state.deals || []).filter(d => 
    d.status !== 'lead'
  ).length;
  const convRate = totalLeads > 0 ? (totalDeals / totalLeads * 100) : 0;
  
  // Update dashboard elements
  const el = id => document.getElementById(id);
  if (el('activeDealsCount')) el('activeDealsCount').textContent = activeDeals;
  if (el('monthlyProfit')) el('monthlyProfit').textContent = money(monthlyProfit);
  if (el('hotLeadsCount')) el('hotLeadsCount').textContent = hotLeads.length;
  if (el('conversionRate')) el('conversionRate').textContent = convRate.toFixed(1) + '%';
  
  // Render hot deals list
  const hotDealsList = el('hotDealsList');
  if (hotDealsList) {
    if (hotLeads.length > 0) {
      hotDealsList.innerHTML = hotLeads.slice(0, 5).map(lead => {
        const score = typeof enhancedScoreLead === 'function' ? 
          enhancedScoreLead(lead) : scoreLead(lead);
        return `
          <div class="border rounded-lg p-3 hover:bg-gray-50 dark:hover:bg-gray-800">
            <div class="flex justify-between items-start mb-1">
              <div class="font-medium text-sm">${lead.address || 'No address'}</div>
              <span class="badge badge-signed text-xs">Score: ${score}</span>
            </div>
            <div class="text-xs text-gray-600">
              ${lead.seller || 'Unknown'} â€¢ ${lead.source || 'No source'}
            </div>
            <div class="flex gap-2 mt-2">
              <button onclick="if(confirm('Call ${lead.phone || 'No phone'}?')) location.href='tel:${lead.phone}'" 
                      class="btn btn-outline text-xs px-2 py-1">Call</button>
              <button onclick="document.querySelector('[data-tab=sprint]').click()" 
                      class="btn btn-primary text-xs px-2 py-1">View</button>
            </div>
          </div>
        `;
      }).join('');
    } else {
      hotDealsList.innerHTML = '<div class="text-gray-500 text-center py-4">No hot deals yet (Score 70+ required)</div>';
    }
  }
  
  // Render today's tasks
  const todayList = el('todayTasksList');
  if (todayList) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const todayTasks = (state.leads || []).filter(l => 
      l.nextAction && 
      new Date(l.nextAction) >= today && 
      new Date(l.nextAction) < tomorrow
    );
    
    if (el('todayCount')) el('todayCount').textContent = todayTasks.length;
    
    if (todayTasks.length > 0) {
      todayList.innerHTML = todayTasks.slice(0, 5).map(lead => `
        <div class="border rounded-lg p-3">
          <div class="font-medium text-sm">${lead.address || 'No address'}</div>
          <div class="text-xs text-gray-600">${lead.seller || 'Unknown'}</div>
          <div class="text-xs text-brand-600 mt-1">Follow-up scheduled</div>
        </div>
      `).join('');
    } else {
      todayList.innerHTML = '<div class="text-gray-500 text-center py-4">No follow-ups scheduled for today</div>';
    }
  }
  
  // Refresh icons
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

// Make it globally accessible
window.renderDashboard = renderDashboard;

    // ========= 7-Day Sprint Functions =========
    function renderSevenDaySprint() {
      const container = document.getElementById('sprintDays');
      if (!container) return;

      const completedTasks = state.sprintTasks.filter(t => t.completed).length;
      const totalTasks = state.sprintTasks.length;
      const progressPercent = Math.round((completedTasks / totalTasks) * 100);
      
      document.getElementById('sprintProgress').textContent = progressPercent + '%';
      document.getElementById('sprintProgressFill').style.width = progressPercent + '%';
      document.getElementById('tasksCompleted').textContent = `${completedTasks}/${totalTasks}`;
      
      const activeDays = new Set(state.sprintTasks.filter(t => t.completed).map(t => t.day)).size;
      document.getElementById('activeDays').textContent = activeDays;

      if (state.sprintStartDate) {
        const startDate = new Date(state.sprintStartDate);
        const endDate = new Date(startDate.getTime() + (6 * 24 * 60 * 60 * 1000));
        document.getElementById('sprintStartDate').textContent = startDate.toLocaleDateString();
        document.getElementById('sprintEndDate').textContent = endDate.toLocaleDateString();
      } else {
        document.getElementById('sprintStartDate').textContent = 'Not started';
        document.getElementById('sprintEndDate').textContent = 'â€”';
      }

      const tasksByDay = {};
      for (let day = 1; day <= 7; day++) {
        tasksByDay[day] = state.sprintTasks.filter(t => t.day === day);
      }

      container.innerHTML = '';

      for (let day = 1; day <= 7; day++) {
        const dayTasks = tasksByDay[day];
        const dayCompletedTasks = dayTasks.filter(t => t.completed).length;
        const dayProgress = dayTasks.length > 0 ? Math.round((dayCompletedTasks / dayTasks.length) * 100) : 0;
        
        const dayNames = ['', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        
        const dayDiv = document.createElement('div');
        dayDiv.className = `sprint-day day-${day}`;
        
        dayDiv.innerHTML = `
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-bold text-lg">Day ${day} - ${dayNames[day]}</h3>
            <div class="flex items-center gap-2">
              <span class="text-sm font-semibold">${dayCompletedTasks}/${dayTasks.length}</span>
              <div class="w-12 h-2 bg-white/50 rounded-full overflow-hidden">
                <div class="h-full bg-white transition-all duration-300" style="width: ${dayProgress}%"></div>
              </div>
            </div>
          </div>
          <div class="space-y-2">
            ${dayTasks.map(task => `
              <div class="sprint-task ${task.completed ? 'completed' : ''}">
                <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleSprintTask('${task.id}')" />
                <span>${task.task}</span>
              </div>
            `).join('')}
          </div>
        `;
        
        container.appendChild(dayDiv);
      }
    }

    function toggleSprintTask(taskId) {
      const task = state.sprintTasks.find(t => t.id === taskId);
      if (!task) return;

      task.completed = !task.completed;
      task.completedAt = task.completed ? Date.now() : null;

      if (task.completed && !state.sprintStartDate) {
        state.sprintStartDate = Date.now();
        localStorage.setItem('sprintStartDate', state.sprintStartDate);
      }

      saveSprintTasks();
      renderSevenDaySprint();

      const completedCount = state.sprintTasks.filter(t => t.completed).length;
      if (completedCount === 7) {
        setTimeout(() => alert("First day complete! You're building momentum!"), 100);
      } else if (completedCount === 14) {
        setTimeout(() => alert("Halfway there! Keep pushing forward!"), 100);  
      } else if (completedCount === 21) {
        setTimeout(() => alert("Sprint complete! You're a wholesaling machine! Time to start a new sprint."), 100);
      }
    }

    function resetSprint() {
      if (confirm('Reset your 7-Day Sprint? This will clear all progress.')) {
        state.sprintTasks = sprintTasks.map((task, index) => ({
          ...task,
          id: `task-${index}`,
          completed: false,
          completedAt: null
        }));
        state.sprintStartDate = null;
        saveSprintTasks();
        localStorage.removeItem('sprintStartDate');
        renderSevenDaySprint();
        alert('Sprint reset! Ready for a fresh week!');
      }
    }

    document.getElementById('resetSprintBtn').addEventListener('click', resetSprint);

    renderOneMetric();
    renderDashboard();

    // THEME
    (function themeInit(){
      const root = document.documentElement;
      const saved = localStorage.getItem('THEME');
      if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        root.classList.add('dark');
      }
    })();

    document.getElementById('themeToggle').addEventListener('click', ()=>{
      const root = document.documentElement;
      const isDark = root.classList.toggle('dark');
      localStorage.setItem('THEME', isDark ? 'dark' : 'light');
      lucide.createIcons();
    });

    // ========= NAV =========
   const sections = {
  dashboard:'#tab-dashboard',  // ADD THIS LINE   
  sprint:'#tab-sprint',
  'tab-seven-day-sprint':'#tab-seven-day-sprint',
  contracts:'#tab-contracts',
  pipeline:'#tab-pipeline',
  'agent-outreach':'#tab-agent-outreach',
  'extended-pipeline':'#tab-extended-pipeline',
  signer:'#tab-signer',
  buyers:'#tab-buyers',
  kpi:'#tab-kpi',
  settings:'#tab-settings'
};

    document.querySelectorAll('.tab').forEach(t=>
      t.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        Object.values(sections).forEach(sel=>document.querySelector(sel).classList.add('hidden'));
        document.querySelector(sections[t.dataset.tab]).classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        if (t.dataset.tab === 'seven-day-sprint') {
          renderSevenDaySprint();
        }
        // ADD THESE 3 LINES HERE:
        if (t.dataset.tab === 'dashboard') {
          renderDashboard();
        }
      }));

    // ========= Lead Scoring & Management =========
    function scoreLead(l){
      const sourceW = { 
        'Privy-Distressed': 35, 'Privy-HighEquity': 30, 'Privy-Absentee': 28, 'Privy-PreForeclosure': 40,
        'Privy-Probate': 35, 'Privy-TaxLien': 38, 'Expired': 25, 'Agent': 20, 'FSBO': 15, 'Referral': 30, 'Other': 10 
      }[l.source] || 10;

      const spread = Math.max(0, (l.arv||0)*0.7 - (l.repairs||0) - (l.ask||0));
      const spreadW = Math.min(30, spread / 10000);
      const equity = (l.arv||0) - (l.mortgageBalance||0);
      const equityW = equity > 50000 ? 15 : equity > 20000 ? 10 : 0;
      const ageDays = (Date.now() - (l.createdAt||Date.now())) / 86400000;
      const recencyW = Math.max(0, 15 - ageDays);
      const dueW = l.nextAction && l.nextAction <= Date.now() ? 20 : 0;
      const kw = ((l.notes||'') + ' ' + (l.agent||'')).toLowerCase();
      const distressKw = /(pre-foreclosure|foreclosure|tax lien|probate|divorce|behind|vacant|tired|relocating|job loss|inheritance|code violation|expired)/.test(kw);
      const kwW = distressKw ? 15 : 0;
      const domW = l.dom > 90 ? 10 : l.dom > 60 ? 5 : 0;
      const contactW = l.attempts === 0 ? 10 : l.attempts < 3 ? 5 : 0;

      return Math.round(sourceW + spreadW + equityW + recencyW + dueW + kwW + domW + contactW);
    }

    // ADD this enhanced scoring - don't remove your existing scoreLead
function enhancedScoreLead(lead) {
  let score = 0;
  
  // Motivation (40 points max)
  score += (Number(lead.motivation) || 5) * 4;
  
  // Source quality (20 points max)
  const sourceScores = state.dealScoring?.sourceQuality || {};
  score += sourceScores[lead.source] || 5;
  
  // Deal spread (30 points max)
  const arv = Number(lead.arv || 0);
  const repairs = Number(lead.repairs || 0);
  const ask = Number(lead.ask || arv);
  const mao = arv * 0.7 - repairs - 10000;
  const spread = mao - ask;
  
  if (spread >= 30000) score += 30;
  else if (spread >= 20000) score += 25;
  else if (spread >= 10000) score += 20;
  else if (spread >= 5000) score += 15;
  else if (spread >= 0) score += 10;
  
  // Recency bonus (10 points max)
  const daysOld = (Date.now() - lead.createdAt) / 86400000;
  if (daysOld < 1) score += 10;
  else if (daysOld < 3) score += 7;
  else if (daysOld < 7) score += 5;
  
  // Contact attempts penalty
  if ((lead.attempts || 0) > 5) score -= 10;
  else if ((lead.attempts || 0) > 3) score -= 5;
  
  return Math.min(100, Math.max(0, score));
}

    const leadForm = document.getElementById('leadForm');
    const leadARV = document.getElementById('leadARV');
    const leadRepairs = document.getElementById('leadRepairs');
    const maoVal = document.getElementById('maoVal');
    const anchorVal = document.getElementById('anchorVal');

   function recalcMAO(){
   const arv = Number(leadARV.value || 0);
   const repairs = Number(leadRepairs.value || 0);
  
  // Use the professional calculator if it exists
  if (typeof analyzeWholesalePro === 'function') {
    const result = analyzeWholesalePro({ arv, repairs, fee: 10000 });
    
    maoVal.textContent = money(result.maxOffer);
    anchorVal.textContent = money(result.minAcceptable);
    
    // Update additional fields if they exist
    const spreadEl = document.getElementById('spreadVal');
    const strengthEl = document.getElementById('dealStrengthVal');
    if (spreadEl) spreadEl.textContent = money(result.spread);
    if (strengthEl) {
      strengthEl.textContent = result.dealStrength;
      strengthEl.className = 'font-bold ' + result.strengthClass;
    }
  } else {
    // Fallback to original calculation
    const mao = Math.max(0, arv*0.7 - repairs);
    maoVal.textContent = money(mao);
    anchorVal.textContent = money(mao*0.9);
  }
}

    ['input','change'].forEach(ev=>{
      leadARV && leadARV.addEventListener(ev,recalcMAO);
      leadRepairs && leadRepairs.addEventListener(ev,recalcMAO);
    });

    leadForm && leadForm.addEventListener('submit',(e)=>{
      e.preventDefault();
      const lead = {
        id: 'L'+Date.now(),
        source: document.getElementById('leadSource').value,
        address: document.getElementById('leadAddress').value.trim(),
        seller: document.getElementById('leadSeller').value.trim(),
        agent: document.getElementById('leadAgent').value.trim(),
        phone: document.getElementById('leadPhone').value.trim(),
        email: document.getElementById('leadEmail').value.trim(),
        arv: Number(document.getElementById('leadARV').value||0),
        repairs: Number(document.getElementById('leadRepairs').value||0),
        ask: Number(document.getElementById('leadAsk').value||0),
        mortgageBalance: Number(document.getElementById('leadMortgage').value||0),
        dom: Number(document.getElementById('leadDOM').value||0),
        propertyType: document.getElementById('leadPropertyType').value,
        notes: document.getElementById('leadNotes').value.trim(),
        status: 'New',
        attempts: 0,
        offerSent: false,
        offerResponse: null,
        createdAt: Date.now(),
        nextAction: Date.now() + 24*3600*1000
      };

      if (lead.source.startsWith('Privy')) {
        const searches = JSON.parse(localStorage.getItem('privySearches') || '[]');
        const today = new Date().toDateString();
        const todaySearch = searches.find(s => s.date === today);
        if (todaySearch) {
          todaySearch.count++;
        } else {
          searches.push({ date: today, count: 1 });
        }
        localStorage.setItem('privySearches', JSON.stringify(searches));
      }

      state.leads.unshift(lead);
      save('leads',state.leads);
      leadForm.reset();
      recalcMAO();
      renderLeads();
      updateDailyMetrics();
      alert('Lead added');
    });

    function scheduleCadence(l, step=0){
      const offsets = [0,2,4,7,10];
      const nextIndex = Math.min(offsets.length-1, step);
      l.nextAction = Date.now() + offsets[nextIndex]*86400000;
      l.cadenceStep = nextIndex+1;
    }

    function renderLeads(){
      const list = document.getElementById('leadList');
      if (!list) return;
      const q=(document.getElementById('leadSearch')?.value||'').toLowerCase();
      const flt=document.getElementById('leadFilter')?.value;
      const today = Date.now();
      const arr = state.leads
        .filter(l=> (!flt || l.status===flt) && (l.address.toLowerCase().includes(q) || (l.seller||'').toLowerCase().includes(q) || (l.agent||'').toLowerCase().includes(q)))
        .map(l=> ({ l, score: enhancedScoreLead(l), due: (l.nextAction||0) <= today }))
        .sort((a,b)=> (b.due - a.due) || (b.score - a.score) || ((b.l.createdAt||0) - (a.l.createdAt||0)))
        .slice(0,20);

      const countElem = document.getElementById('sprintCount');
      if (countElem) countElem.textContent = `${arr.length} in queue`;
      list.innerHTML='';
      arr.forEach(({l,score})=>{
        const div = document.createElement('div');
        div.className='border rounded-xl p-3 bg-white dark:bg-[#0b1322]';
        const dueBadge = (l.nextAction && l.nextAction<=today) ? '<span class="badge badge-pending ml-2">Due</span>':'';
        const offerBadge = l.offerSent ? '<span class="badge badge-offer ml-1">Offer Sent</span>' : '';
        const equity = (l.arv||0) - (l.mortgageBalance||0);
        const equityDisplay = l.mortgageBalance ? `Equity: ${money(equity)}` : '';

        div.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-medium">${l.address}</div>
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-500">Score</span>
              <span class="badge ${score>=60?'badge-signed':score>=40?'badge-offer':'badge-lead'}">${score}</span>
              ${dueBadge}
              ${offerBadge}
            </div>
          </div>
          <div class="text-xs text-gray-600 dark:text-gray-300 mt-1">
            ${l.seller||'â€”'} ${l.agent? ' â€¢ Agent: '+l.agent:''}
            ${l.propertyType ? ' â€¢ ' + l.propertyType : ''}
            ${l.dom ? ' â€¢ DOM: ' + l.dom : ''}
          </div>
          <div class="text-xs text-gray-500 mt-1">
            ARV ${money(l.arv)} â€¢ Repairs ${money(l.repairs)} â€¢ Ask ${money(l.ask)}
            ${equityDisplay}
          </div>
          <div class="flex flex-wrap gap-2 mt-2">
            <a class="btn btn-outline text-xs callBtn" href="tel:${l.phone||''}"><i data-lucide="phone"></i>Call</a>
            <a class="btn btn-outline text-xs textBtn" href="sms:${l.phone||''}"><i data-lucide="message-square"></i>Text</a>
            <button class="btn btn-outline text-xs emailLead"><i data-lucide="mail"></i>Email</button>
            <button class="btn btn-outline text-xs offerLead"><i data-lucide="file-text"></i>Offer</button>
            <button class="btn btn-outline text-xs followLead"><i data-lucide="clock"></i>Follow-Up</button>
            <button class="btn btn-outline text-xs toDeal"><i data-lucide="arrow-right"></i>To Deal</button>
            <button class="btn btn-outline text-xs delLead"><i data-lucide="trash"></i>Del</button>
          </div>
          <div class="text-xs text-gray-600 mt-1">${l.notes||''}</div>
        `;

        div.querySelector('.callBtn').addEventListener('click', ()=>{
          l.attempts = (l.attempts || 0) + 1;
          l.lastContact = Date.now();
          logConvo('call', {leadId: l.id});
          saveWithSync('leads', state.leads);
        });

        div.querySelector('.textBtn').addEventListener('click', ()=>{
          l.attempts = (l.attempts || 0) + 1;
          l.lastContact = Date.now();
          logConvo('text', {leadId: l.id});
          saveWithSync('leads', state.leads);
        });

        div.querySelector('.emailLead').addEventListener('click',()=> {
          document.getElementById('offerEmailTo').value = l.email || '';
        });

        div.querySelector('.offerLead').addEventListener('click',()=> {
          leadToContract(l);
          l.offerSent = true;
          l.offerSentDate = Date.now();
          saveWithSync('leads', state.leads);
        });

        div.querySelector('.followLead').addEventListener('click',()=> {
          scheduleCadence(l, (l.cadenceStep||0));
          save('leads',state.leads);
          renderLeads();
          alert('Follow-up scheduled');
        });

        div.querySelector('.toDeal').addEventListener('click',()=> leadToDeal(l));

        div.querySelector('.delLead').addEventListener('click',()=>{
          if(confirm('Delete lead?')){
            state.leads = state.leads.filter(x=>x.id!==l.id);
            save('leads',state.leads);
            renderLeads();
          }
        });

        div.addEventListener('click', ()=> state.selectedLeadId = l.id);
        list.appendChild(div);
      });
      lucide.createIcons();
    }

    function leadToDeal(l){
      const deal = {
        bizName: document.getElementById('bizName')?.value.trim() || 'Your LLC',
        bizAddress: document.getElementById('bizAddress')?.value.trim() || '',
        propertyAddress: l.address,
        sellerNames: l.seller || '',
        purchasePrice: Math.max(0, (l.arv||0)*0.7 - (l.repairs||0)),
        dealTerms: `Generated from lead. Source: ${l.source}. Notes: ${l.notes||''}`,
        status: 'lead',
        photoDataUrl: null,
        createdAt: Date.now(),
        fee: 0,
        id: 'D'+Date.now()
      };
      state.deals.unshift(deal);
      save('deals',state.deals);
      alert('Moved to Deals. Open Contracts tab to edit.');
    }

    function leadToContract(l){
      document.querySelector('.tab[data-tab="contracts"]')?.click();
      const addr = document.getElementById('propertyAddress');
      const seller = document.getElementById('sellerNames'); 
      const price = document.getElementById('purchasePrice');
      const terms = document.getElementById('dealTerms');
      if (addr) addr.value = l.address;
      if (seller) seller.value = l.seller||'';
      if (price) price.value = Math.max(0, (l.arv||0)*0.7 - (l.repairs||0));
      if (terms) terms.value = `Offer auto-generated from lead. Source: ${l.source}.`;
      window.scrollTo({ top: 0, behavior:'smooth' });
      state.selectedLeadId = l.id;
    }

    const leadSearchElem = document.getElementById('leadSearch');
    const leadFilterElem = document.getElementById('leadFilter');
    leadSearchElem && leadSearchElem.addEventListener('input',renderLeads);
    leadFilterElem && leadFilterElem.addEventListener('change',renderLeads);

    // Copy script buttons
    document.querySelectorAll('[data-script-copy]').forEach(btn=>
      btn.addEventListener('click',()=>{
        const p = btn.closest('details').querySelector('p');
        navigator.clipboard.writeText(p.textContent.replace(/\s+/g,' ').trim()).then(()=>{
          btn.textContent = 'Copied!';
          setTimeout(()=>btn.textContent='Copy', 2000);
        });
      }));

    // ========= Contracts / Templates =========
    const STATUS_MAP = {
      lead:{label:'Lead',cls:'badge-lead'},
      offer:{label:'Offer Out',cls:'badge-offer'},
      pending:{label:'Pending Signature',cls:'badge-pending'},
      sent:{label:'Sent to Seller',cls:'badge-sent'},
      signed:{label:'Signed',cls:'badge-signed'},
      attorney:{label:'To Attorney / Title',cls:'badge-attorney'},
      closed:{label:'Closed',cls:'badge-closed'}
    };

    function CONTRACT_TEXT(template, d){
      const baseHeader = `PURCHASE AGREEMENT
Date: ${new Date().toLocaleDateString()}
Buyer: ${d.bizName}, located at ${d.bizAddress}.
Seller(s): ${d.sellerNames}.
Property: ${d.propertyAddress}.`;

      const baseBody = `Purchase Price: ${money(d.purchasePrice)}.
Earnest Money: $1,000 (refundable within inspection period unless otherwise stated).
Closing: On or before 30 days from execution, or as mutually agreed.
Condition: Property sold AS-IS. Buyer may access property for inspections.
Title & Taxes: Seller to provide clear, marketable title. Taxes prorated at closing.
Assignments: Buyer may assign this agreement.`;

      let extra = '';
      if (template==='standard'){
        extra = `Additional Terms: ${d.dealTerms || 'N/A'}.`;
      } else if (template==='subject_to'){
        extra = `SUBJECT-TO ADDENDUM:
1) Buyer to acquire property subject-to existing financing (no loan assumption).
2) Buyer will make monthly payments directly to lender(s) on time.
3) Seller consents to this arrangement and acknowledges due-on-sale risk.
4) Buyer covers taxes, insurance, maintenance from closing.
Additional Terms: ${d.dealTerms || 'N/A'}.`;
      } else if (template==='assignment'){
        extra = `ASSIGNMENT OF CONTRACT:
Assignor: ${d.bizName}
Assignee: ____________________________
Underlying Contract: ${d.propertyAddress}
Assignment Fee: ${money(d.fee||0)}
Assignee accepts all obligations; Assignor discloses all known facts.
Additional Terms: ${d.dealTerms || 'N/A'}.`;
      } else if (template==='jv'){
        extra = `JOINT VENTURE AGREEMENT:
Partner A: ${d.bizName}
Partner B: ____________________________
Purpose: Marketing & assignment of ${d.propertyAddress}
Split: ____% / ____%
Expenses: Pre-approval required above $____.
Additional Terms: ${d.dealTerms || 'N/A'}.`;
      } else if (template==='authorization'){
        extra = `AUTHORIZATION TO RELEASE:
Seller authorizes ${d.bizName} to obtain mortgage payoff, reinstatement, and escrow details on ${d.propertyAddress}.
Lender: __________________
Loan #: ______________
Phone: ______________
Additional Terms: ${d.dealTerms || 'N/A'}.`;
      }

      const footer = `
Signatures:
Buyer: ____________________________ Date: ____________
Seller: ____________________________ Date: ____________
Seller: ____________________________ Date: ____________`;

      return `${baseHeader}\n${baseBody}\n${extra}\n${footer}`;
    }

    async function generatePdf(deal, opts={}){
      const { jsPDF } = window.jspdf;
      const { includePhoto=true, templateKey='standard' } = opts;
      const doc = new jsPDF({ unit:'pt', format:'letter' });
      const margin=40, lineHeight=16, maxWidth=515;
      let y=60;
      doc.setFont('Helvetica','bold');
      doc.setFontSize(16);
      const title = templateKey==='assignment' ? 'ASSIGNMENT AGREEMENT' :
                   templateKey==='jv' ? 'JOINT VENTURE AGREEMENT' :
                   templateKey==='authorization' ? 'AUTHORIZATION TO RELEASE' :
                   templateKey==='subject_to' ? 'PURCHASE + SUBJECT-TO ADDENDUM' : 'PURCHASE AGREEMENT';
      doc.text(title, margin, y);
      y+=30;
      if (includePhoto && deal.photoDataUrl){
        try {
          doc.addImage(deal.photoDataUrl,'JPEG', margin, y, 140, 100);
        } catch {}
        y+=120;
      }
      doc.setFont('Helvetica','normal');
      doc.setFontSize(11);
      const text = CONTRACT_TEXT(templateKey, deal);
      const lines = doc.splitTextToSize(text, maxWidth);
      lines.forEach((ln,i)=> doc.text(ln, margin, y + i*lineHeight));
      doc.setFontSize(9);
      doc.text('Generated by REI Stack â€” For attorney review. Not legal advice.', margin, 760);
      return doc;
    }

    // Photo upload (drop + click)
    (function photoUpload(){
      const photoInput = document.getElementById('photoInput');
      const photoDrop = document.getElementById('photoDrop');
      if (!photoInput || !photoDrop) return;
      const show = (dataUrl)=>{
        state.photoDataUrl = dataUrl;
        document.getElementById('photoPreview').classList.remove('hidden');
        document.getElementById('photoImg').src = dataUrl;
      };
      photoDrop.addEventListener('click',()=> photoInput.click());
      photoDrop.addEventListener('dragover', e=>{e.preventDefault(); photoDrop.classList.add('dragover');});
      photoDrop.addEventListener('dragleave', ()=> photoDrop.classList.remove('dragover'));
      photoDrop.addEventListener('drop', e=>{
        e.preventDefault();
        photoDrop.classList.remove('dragover');
        const f = e.dataTransfer.files && e.dataTransfer.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = ()=> show(r.result);
        r.readAsDataURL(f);
      });
      photoInput.addEventListener('change', e=>{
        const f = e.target.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = ()=> show(r.result);
        r.readAsDataURL(f);
      });
    })();

    // Save Deal
    document.getElementById('dealForm') && document.getElementById('dealForm').addEventListener('submit',(e)=>{
      e.preventDefault();
      const deal = {
        bizName: document.getElementById('bizName').value.trim(),
        bizAddress: document.getElementById('bizAddress').value.trim(),
        propertyAddress: document.getElementById('propertyAddress').value.trim(),
        sellerNames: document.getElementById('sellerNames').value.trim(),
        purchasePrice: parseFloat(document.getElementById('purchasePrice').value||'0'),
        fee: parseFloat(document.getElementById('assignmentFee').value||'0'),
        dealTerms: document.getElementById('dealTerms').value.trim(),
        template: document.getElementById('contractTemplate').value,
        status: document.getElementById('status').value,
        photoDataUrl: state.photoDataUrl || null,
        createdAt: Date.now(),
        id: 'D'+Date.now()
      };
      state.deals.unshift(deal);
      save('deals',state.deals);
      renderDealsTable();
      renderPipeline();
      e.target.reset();
      state.photoDataUrl=null;
      const prev=document.getElementById('photoPreview');
      if(prev) prev.classList.add('hidden');
      alert('Deal saved');
    });

    document.getElementById('genPdfBtn') && document.getElementById('genPdfBtn').addEventListener('click', async ()=>{
      const d = state.deals[0];
      if(!d){
        alert('Save a deal first.');
        return;
      }
      (await generatePdf(d, { templateKey: d.template||'standard' })).save(`Contract_${d.propertyAddress.replaceAll(' ','_')}.pdf`);
    });

    document.getElementById('dealFromLeadBtn') && document.getElementById('dealFromLeadBtn').addEventListener('click',()=>{
      const l = state.leads.find(x=>x.id===state.selectedLeadId) || state.leads[0];
      if(!l){
        alert('No lead selected');
        return;
      }
      document.getElementById('propertyAddress').value = l.address;
      document.getElementById('sellerNames').value = l.seller||'';
      document.getElementById('purchasePrice').value = Math.max(0, (l.arv||0)*0.7 - (l.repairs||0));
      document.getElementById('dealTerms').value = `Offer auto-generated from lead. Source: ${l.source}.`;
      document.querySelector('.tab[data-tab="contracts"]')?.click();
    });

    function renderDealsTable(){
      const tbody = document.getElementById('dealRows');
      if(!tbody) return;
      const q=(document.getElementById('search')?.value||'').toLowerCase();
      const fs=document.getElementById('filterStatus')?.value;
      tbody.innerHTML='';
      state.deals
        .filter(d=>!fs||d.status===fs)
        .filter(d=> d.propertyAddress.toLowerCase().includes(q) || (d.sellerNames||'').toLowerCase().includes(q))
        .forEach((d,idx)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="py-2 pr-4">${d.propertyAddress}</td>
            <td class="py-2 pr-4">${d.sellerNames||''}</td>
            <td class="py-2 pr-4">${money(d.purchasePrice)}</td>
            <td class="py-2 pr-4">${money(d.fee||0)}</td>
            <td class="py-2 pr-4"><span class="badge ${STATUS_MAP[d.status].cls}">${STATUS_MAP[d.status].label}</span></td>
            <td class="py-2 pr-4 flex gap-2">
              <button class="btn btn-outline text-xs px-2 py-1 gen">PDF</button>
              <button class="btn btn-outline text-xs px-2 py-1 edit">Edit</button>
              <button class="btn btn-outline text-xs px-2 py-1 del">Delete</button>
            </td>
          `;
          tr.querySelector('.gen').onclick = async ()=>{
            (await generatePdf(d, { templateKey: d.template||'standard' })).save(`Contract_${d.propertyAddress.replaceAll(' ','_')}.pdf`);
          };
          tr.querySelector('.edit').onclick = ()=> loadDealIntoForm(idx);
          tr.querySelector('.del').onclick = ()=>{
            if(confirm('Delete this deal?')){
              state.deals.splice(idx,1);
              save('deals',state.deals);
              renderDealsTable();
              renderPipeline();
            }
          };
          tbody.appendChild(tr);
        });
    }

    function loadDealIntoForm(idx){
      const d = state.deals[idx];
      if(!d) return;
      document.getElementById('bizName').value = d.bizName;
      document.getElementById('bizAddress').value = d.bizAddress;
      document.getElementById('propertyAddress').value = d.propertyAddress;
      document.getElementById('sellerNames').value = d.sellerNames;
      document.getElementById('purchasePrice').value = d.purchasePrice;
      document.getElementById('assignmentFee').value = d.fee||0;
      document.getElementById('dealTerms').value = d.dealTerms||'';
      document.getElementById('contractTemplate').value = d.template||'standard';
      document.getElementById('status').value = d.status;
      state.photoDataUrl = d.photoDataUrl||null;
      if(state.photoDataUrl){
        document.getElementById('photoPreview').classList.remove('hidden');
        document.getElementById('photoImg').src = state.photoDataUrl;
      }
      document.querySelector('.tab[data-tab="contracts"]')?.click();
    }

    const searchElem = document.getElementById('search');
    const filterStatusElem = document.getElementById('filterStatus');
    searchElem && searchElem.addEventListener('input', renderDealsTable);
    filterStatusElem && filterStatusElem.addEventListener('change', renderDealsTable);

    function renderPipeline(){
      const dealCountElem = document.getElementById('dealCount');
      if (dealCountElem) dealCountElem.textContent = `${state.deals.length} total deals`;
      ['lead','offer','pending','sent','signed','attorney','closed'].forEach(st=>{
        const col = document.getElementById('col-'+st);
        if(!col) return;
        col.innerHTML='';
        state.deals.filter(d=>d.status===st).forEach(deal=>{
          const card = document.createElement('div');
          card.className='bg-white dark:bg-[#0b1322] rounded-xl border p-3 text-sm space-y-1';
          card.innerHTML = `
            <div class="font-medium">${deal.propertyAddress}</div>
            <div class="text-xs text-gray-500">${deal.sellerNames||''} â€¢ ${money(deal.purchasePrice)}</div>
            <div class="flex items-center justify-between pt-1 gap-2">
              <span class="badge ${STATUS_MAP[deal.status].cls}">${STATUS_MAP[deal.status].label}</span>
              <div class="flex items-center gap-2">
                <select class="mobile-only border rounded-lg px-2 py-1 text-xs">
                  ${Object.keys(STATUS_MAP).map(k=>`<option value="${k}" ${k===deal.status?'selected':''}>${STATUS_MAP[k].label}</option>`).join('')}
                </select>
                <button class="btn btn-outline text-xs px-2 py-1 desktop-only">PDF</button>
              </div>
            </div>
          `;
          const sel = card.querySelector('select');
          sel && (sel.onchange = ()=>{
            deal.status = sel.value;
            save('deals',state.deals);
            renderPipeline();
            renderDealsTable();
          });
          const pdfBtn = card.querySelector('button');
          pdfBtn && (pdfBtn.onclick = async ()=>{
            (await generatePdf(deal, { templateKey: deal.template||'standard' })).save(`Contract_${deal.propertyAddress.replaceAll(' ','_')}.pdf`);
          });
          col.appendChild(card);
        });
      });
    }

    // ========= EmailJS + Supabase =========
    function sb(){
      return window.supabase.createClient(state.settings.sbUrl, state.settings.sbAnon);
    }

    async function uploadPdfAndGetUrl(fileBlob, fileNameHint='Contract'){
      if (!state.settings.sbUrl || !state.settings.sbAnon){
        throw new Error('Supabase not configured');
      }
      const client = sb();
      const safe=(fileNameHint||'Contract').replace(/[^a-z0-9-_]/gi,'_');
      const path = `${safe}_${Date.now()}.pdf`;
      const { error } = await client.storage.from(state.settings.sbBucket||'contracts').upload(path, fileBlob, { contentType:'application/pdf', upsert:false });
      if (error) throw error;
      const { data } = client.storage.from(state.settings.sbBucket||'contracts').getPublicUrl(path);
      return data.publicUrl;
    }

    async function ensureEmailJs(){
      if (!window.emailjs){
        await new Promise(res=>{
          const s=document.createElement('script');
          s.src='https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js';
          s.onload=res;
          document.body.appendChild(s);
        });
      }
      const pub = state.settings.ejPublic;
      if(!pub) throw new Error('EmailJS public key missing');
      window.emailjs.init({ publicKey: pub });
    }

    async function sendEmail({to, subject, body, vars={}}){
      const svc=state.settings.ejService, tpl=state.settings.ejTemplate;
      if(!(svc&&tpl)) throw new Error('EmailJS service or template missing');
      await ensureEmailJs();
      return window.emailjs.send(svc, tpl, { to_email: to, subject, message: body, ...vars });
    }

    document.getElementById('sendEmailBtn') && document.getElementById('sendEmailBtn').addEventListener('click', async ()=>{
      try{
        const to = document.getElementById('emailTo').value.trim();
        if(!to) return alert('Seller email required');
        const svc = document.getElementById('emailjsService').value.trim();
        if(svc){
          state.settings.ejService=svc;
          localStorage.setItem('EJ_SERVICE', svc);
        }
        const tpl = document.getElementById('emailjsTemplate').value.trim();
        if(tpl){
          state.settings.ejTemplate=tpl;
          localStorage.setItem('EJ_TEMPLATE', tpl);
        }
        const pub = document.getElementById('emailjsPublic').value.trim();
        if(pub){
          state.settings.ejPublic=pub;
          localStorage.setItem('EJ_PUBLIC', pub);
        }
        const deal = state.deals[0];
        if(!deal) return alert('Save a deal first');
        const pdf = await generatePdf(deal, { templateKey: deal.template||'standard' });
        const blob = pdf.output('blob');
        const link = await uploadPdfAndGetUrl(blob, deal.propertyAddress);
        await sendEmail({ to, subject:`Contract for ${deal.propertyAddress} â€” ${deal.bizName}`, body:`Here is the agreement link: ${link}`, vars:{ bizName:deal.bizName, sellerNames:deal.sellerNames, propertyAddress:deal.propertyAddress, link } });
        alert('Email sent with public link!');
      }catch(e){
        alert('Send failed: '+e.message);
      }
    });

    function computeMAOFromLeadOrForm(){
      const arv = Number(document.getElementById('leadARV')?.value||0);
      const rep = Number(document.getElementById('leadRepairs')?.value||0);
      return Math.max(0, arv*0.7 - rep);
    }

    async function sendOfferVariant(kind){
      try{
        const to = (document.getElementById('offerEmailTo')?.value||'').trim();
        if(!to) return alert('Recipient required');
        const address = document.getElementById('leadAddress')?.value || (state.leads[0]?.address||'Property');
        const biz = document.getElementById('bizName')?.value || 'Your LLC';
        const mao = computeMAOFromLeadOrForm();
        let price = mao;
        let templateKey='standard';
        let terms = 'Cash offer';
        if (kind==='cash'){
          const pct = Number(document.getElementById('offerCashPct')?.value||100)/100;
          price = Math.round(mao*pct);
          terms = `Cash offer at ~${Math.round(pct*100)}% of MAO.`;
        } else if(kind==='terms'){
          const arv = Number(document.getElementById('leadARV')?.value||0);
          const downPct = Number(document.getElementById('offerTermsDownPct')?.value||5)/100;
          const rate = Number(document.getElementById('offerTermsRate')?.value||4.5);
          const yrs = Number(document.getElementById('offerTermsAmort')?.value||30);
          const down = Math.round(arv*downPct);
          const princ = Math.max(0, (price||arv) - down);
          const mRate = rate/100/12;
          const n = yrs*12;
          const pmt = mRate>0 ? Math.round(princ * (mRate*Math.pow(1+mRate,n))/(Math.pow(1+mRate,n)-1)) : Math.round(princ/n);
          templateKey='subject_to';
          terms = `Subject-to terms: ~${money(down)} down, ~${rate}% ${yrs}yr, est P&I â‰ˆ ${money(pmt)}/mo (taxes/ins extra).`;
          price = arv || mao;
        }
        const tempDeal = {
          bizName: biz,
          bizAddress: document.getElementById('bizAddress')?.value||'',
          propertyAddress: address,
          sellerNames: '',
          purchasePrice: price,
          dealTerms: terms,
          status: 'offer',
          photoDataUrl: null,
          template: templateKey
        };
        const pdf = await generatePdf(tempDeal, { templateKey });
        const blob = pdf.output('blob');
        const link = await uploadPdfAndGetUrl(blob, tempDeal.propertyAddress);
        const body = `${terms}\n\nView agreement: ${link}`;
        await sendEmail({ to, subject:`Offer for ${address} â€” ${biz} (${kind.toUpperCase()})`, body, vars:{ bizName:biz, sellerNames:'', propertyAddress:address, link } });
        alert(`${kind==='cash'?'Cash':'Terms'} offer sent!`);
      }catch(e){
        alert('Offer send failed: '+e.message);
      }
    }

    document.getElementById('sendCashOfferBtn') && document.getElementById('sendCashOfferBtn').addEventListener('click', e=>{
      e.preventDefault();
      sendOfferVariant('cash');
    });

    document.getElementById('sendTermsOfferBtn') && document.getElementById('sendTermsOfferBtn').addEventListener('click', e=>{
      e.preventDefault();
      sendOfferVariant('terms');
    });

    document.getElementById('sendBothOffersBtn') && document.getElementById('sendBothOffersBtn').addEventListener('click', async e=>{
      e.preventDefault();
      await sendOfferVariant('cash');
      await sendOfferVariant('terms');
    });

    document.getElementById('dispoSendBtn') && document.getElementById('dispoSendBtn').addEventListener('click', async ()=>{
      try{
        const tags = (document.getElementById('dispoTags')?.value||'').toLowerCase().split(/[,;]+/).map(s=>s.trim()).filter(Boolean);
        const body = document.getElementById('dispoBody')?.value||'New deal available.';
        if (!tags.length) return alert('Enter at least one tag');
        const matches = state.buyers.filter(b=>
          (b.criteria||'').toLowerCase().split(/[,;]+/).some(c=> tags.includes(c.trim())));
        if (!matches.length) return alert('No matching buyers yet.');
        await ensureEmailJs();
        for (const b of matches){
          await sendEmail({ to:b.email, subject:'Deal Opportunity', body, vars:{} });
        }
        alert('Blast sent to matching buyers!');
      }catch(e){
        alert('Blast failed: '+e.message);
      }
    });

    // ========= Signer =========
    const pdfjsLibLocal = window['pdfjs-dist/build/pdf'];
    pdfjsLibLocal.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    const pdfFile = document.getElementById('pdfFile');
    const pdfContainer = document.getElementById('pdfContainer');
    const addSigBtn = document.getElementById('addSigBtn');
    const addInitBtn = document.getElementById('addInitBtn');
    const finishBtn = document.getElementById('finishBtn');
    let currentTool = null;

    pdfFile && pdfFile.addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      state.signer.pdfBytes = await file.arrayBuffer();
      await loadPdfForPreview(state.signer.pdfBytes);
      if(addSigBtn) addSigBtn.disabled=false;
      if(addInitBtn) addInitBtn.disabled=false;
      if(finishBtn) finishBtn.disabled=false;
    });

    async function loadPdfForPreview(pdfBytes){
      if (!pdfContainer) return;
      pdfContainer.innerHTML='';
      state.signer.placements = [];
      const loadingTask = pdfjsLibLocal.getDocument({ data: pdfBytes });
      const pdf = await loadingTask.promise;
      state.signer.pages=[];
      for(let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 1.1 });
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const ctx = canvas.getContext('2d');
        await page.render({ canvasContext: ctx, viewport }).promise;
        canvas.className='mx-auto border rounded-lg bg-white';
        canvas.dataset.page=i;
        pdfContainer.appendChild(canvas);
        state.signer.pages.push({canvas,viewport});
        const tap = (evt)=>{
          if(!currentTool) return;
          const rect=canvas.getBoundingClientRect();
          const x=(evt.touches?evt.touches[0].clientX:evt.clientX)-rect.left;
          const y=(evt.touches?evt.touches[0].clientY:evt.clientY)-rect.top;
          placeFieldOnCanvas(canvas,x,y,currentTool==='sig'?'Signature':'Initials');
        };
        canvas.addEventListener('click', tap, {passive:true});
        canvas.addEventListener('touchstart', tap, {passive:true});
      }
    }

    function placeFieldOnCanvas(canvas,x,y,label){
      const ctx=canvas.getContext('2d');
      ctx.save();
      ctx.strokeStyle='#06b6d4';
      ctx.setLineDash([4,3]);
      ctx.strokeRect(x-60,y-18,120,36);
      ctx.fillStyle='#06b6d4';
      ctx.font='12px sans-serif';
      ctx.fillText(label,x-55,y-24);
      ctx.restore();
      state.signer.placements.push({ page:Number(canvas.dataset.page), x, y, type: label.toLowerCase() });
    }

    addSigBtn && addSigBtn.addEventListener('click',()=> currentTool='sig');
    addInitBtn && addInitBtn.addEventListener('click',()=> currentTool='init');

    function makePad(canvas){
      if(!canvas) return null;
      function resize(){
        const ratio = Math.max(1, Math.floor(window.devicePixelRatio||1));
        const dw = canvas.clientWidth||300;
        const dh = canvas.classList.contains('h-24')?96:160;
        canvas.width=dw*ratio;
        canvas.height=dh*ratio;
        const ctx = canvas.getContext('2d');
        ctx.setTransform(ratio,0,0,ratio,0,0);
      }
      resize();
      window.addEventListener('resize', resize);
      const ctx=canvas.getContext('2d');
      let drawing=false, last=null;
      function draw(e){
        const r=canvas.getBoundingClientRect();
        const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;
        const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;
        if(!drawing) return;
        ctx.lineWidth=2;
        ctx.lineCap='round';
        ctx.strokeStyle='#111827';
        ctx.beginPath();
        ctx.moveTo(last.x,last.y);
        ctx.lineTo(x,y);
        ctx.stroke();
        last={x,y};
      }
      canvas.addEventListener('mousedown', e=>{drawing=true; last={x:e.offsetX,y:e.offsetY}});
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', ()=>drawing=false);
      canvas.addEventListener('mouseleave', ()=>drawing=false);
      canvas.addEventListener('touchstart', e=>{drawing=true; const r=canvas.getBoundingClientRect(); last={x:e.touches[0].clientX-r.left,y:e.touches[0].clientY-r.top}}, {passive:true});
      canvas.addEventListener('touchmove', draw, {passive:true});
      canvas.addEventListener('touchend', ()=>drawing=false);
      return {
        clear(){ ctx.clearRect(0,0,canvas.width,canvas.height); },
        toDataURL(){ return canvas.toDataURL('image/png'); }
      };
    }

    const sigPad = makePad(document.getElementById('sigPad'));
    const initPad = makePad(document.getElementById('initPad'));
    const sigClear = document.getElementById('sigClear');
    const initClear = document.getElementById('initClear');
    sigClear && sigClear.addEventListener('click',()=> sigPad && sigPad.clear());
    initClear && initClear.addEventListener('click',()=> initPad && initPad.clear());

    document.getElementById('sigSave') && document.getElementById('sigSave').addEventListener('click',()=>{
      state.signer.signatureUrl = sigPad && sigPad.toDataURL();
      alert('Signature (drawn) saved. Tap to place.');
    });

    document.getElementById('initSave') && document.getElementById('initSave').addEventListener('click',()=>{
      state.signer.initialsUrl = initPad && initPad.toDataURL();
      alert('Initials (drawn) saved. Tap to place.');
    });

    function renderTypedToDataURL(text, fontCss, px){
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = Math.max(400, text.length*24);
      canvas.height = px+40;
      ctx.fillStyle='#111827';
      ctx.font = `${px}px ${fontCss||'cursive'}`;
      ctx.textBaseline='alphabetic';
      ctx.fillText(text, 20, px+10);
      return canvas.toDataURL('image/png');
    }

    document.getElementById('typedSigGenerate') && document.getElementById('typedSigGenerate').addEventListener('click',()=>{
      const text = (document.getElementById('typedSigInput')?.value.trim()) || '';
      if(!text) return alert('Type your name for the signature');
      const font = (document.getElementById('typedSigFont')?.value) || "'Great Vibes', cursive";
      state.signer.signatureUrl = renderTypedToDataURL(text, font, 50);
      alert('Typed signature saved. Tap PDF to place.');
    });

    document.getElementById('typedInitGenerate') && document.getElementById('typedInitGenerate').addEventListener('click',()=>{
      const text = (document.getElementById('typedInitInput')?.value.trim()) || '';
      if(!text) return alert('Type your initials');
      const font = (document.getElementById('typedInitFont')?.value) || "'Great Vibes', cursive";
      state.signer.initialsUrl = renderTypedToDataURL(text, font, 36);
      alert('Typed initials saved. Tap PDF to place.');
    });

    finishBtn && finishBtn.addEventListener('click', async ()=>{
      if(!state.signer.pdfBytes) return alert('No PDF loaded');
      if(!state.signer.placements.length) return alert('No signatures/initials placed');
      try{
        const pdfDoc = await PDFLib.PDFDocument.load(state.signer.pdfBytes);
        const pages = pdfDoc.getPages();
        for(const p of state.signer.placements){
          const page = pages[p.page-1];
          const {width,height} = page.getSize();
          const scale = width / (state.signer.pages[p.page-1].viewport.width);
          const imgUrl = p.type==='signature'? state.signer.signatureUrl : state.signer.initialsUrl;
          if(!imgUrl) continue;
          const img = await pdfDoc.embedPng(imgUrl);
          const dims = img.scale(0.5);
          page.drawImage(img, {
            x: p.x*scale - dims.width/2,
            y: height - p.y*scale - dims.height/2,
            width: dims.width,
            height: dims.height
          });
        }
        const finalBytes = await pdfDoc.save();
        const blob = new Blob([finalBytes], {type:'application/pdf'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Signed_Contract.pdf';
        a.click();
        URL.revokeObjectURL(url);
        alert('Signed PDF downloaded!');
      }catch(e){
        alert('Finalize failed: '+e.message);
      }
    });

    // ========= Buyers CRM =========
    function renderBuyersTable(){
      const tbody = document.getElementById('buyerRows');
      if(!tbody) return;
      tbody.innerHTML='';
      state.buyers.forEach((buyer,idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 pr-4">${buyer.name}</td>
          <td class="py-2 pr-4">${buyer.email||''}</td>
          <td class="py-2 pr-4">${buyer.phone||''}</td>
          <td class="py-2 pr-4">${buyer.criteria||''}</td>
          <td class="py-2 pr-4">${buyer.notes||''}</td>
          <td class="py-2 pr-4">
            <button class="btn btn-outline text-xs px-2 py-1 del">Delete</button>
          </td>
        `;
        tr.querySelector('.del').onclick = ()=>{
          if(confirm('Delete buyer?')){
            state.buyers.splice(idx,1);
            save('buyers',state.buyers);
            renderBuyersTable();
          }
        };
        tbody.appendChild(tr);
      });
    }

    document.getElementById('addBuyerBtn') && document.getElementById('addBuyerBtn').addEventListener('click',()=>{
      const name = prompt('Buyer name:');
      if(!name) return;
      const email = prompt('Email:');
      const phone = prompt('Phone:');
      const criteria = prompt('Criteria/Tags (e.g. 30318; <200k; rehab):');
      const notes = prompt('Notes:');
      const buyer = {
        name,
        email: email||'',
        phone: phone||'',
        criteria: criteria||'',
        notes: notes||'',
        id: 'B'+Date.now()
      };
      state.buyers.push(buyer);
      save('buyers',state.buyers);
      renderBuyersTable();
    });

    // ========= KPI Dashboard =========
    function updateKPI(){
      const today = new Date();
      const thisWeekStart = weekStartMs();
      const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1).getTime();
      
      const weekConvos = state.calls.filter(c=>c.ts>=thisWeekStart&&c.type==='call').length;
      const weekTexts = state.calls.filter(c=>c.ts>=thisWeekStart&&c.type==='text').length;
      const totalConvos = weekConvos + weekTexts;
      
      const weekOffers = state.leads.filter(l=>l.offerSentDate&&l.offerSentDate>=thisWeekStart).length;
      const monthContracts = state.deals.filter(d=>d.createdAt>=thisMonthStart&&d.status!=='lead').length;
      const monthFees = state.deals.filter(d=>d.createdAt>=thisMonthStart&&d.status==='closed').reduce((sum,d)=>(sum+(d.fee||0)),0);
      
      document.getElementById('kpiConvos').textContent = totalConvos;
      document.getElementById('kpiOffers').textContent = weekOffers;
      document.getElementById('kpiContracts').textContent = monthContracts;
      document.getElementById('kpiFees').textContent = money(monthFees);
      
      const convosTarget = state.goals.convos||50;
      const offersTarget = state.goals.offers||10;
      const contractsTarget = state.goals.contracts||5;
      
      document.getElementById('kpiConvosTarget').textContent = `Goal ${convosTarget}`;
      document.getElementById('kpiOffersTarget').textContent = `Goal ${offersTarget}`;
      document.getElementById('kpiContractsTarget').textContent = `Goal ${contractsTarget}`;
      
      document.getElementById('kpiConvosMeter').style.width = Math.min(100, (totalConvos/convosTarget)*100)+'%';
      document.getElementById('kpiOffersMeter').style.width = Math.min(100, (weekOffers/offersTarget)*100)+'%';
      document.getElementById('kpiContractsMeter').style.width = Math.min(100, (monthContracts/contractsTarget)*100)+'%';
      document.getElementById('kpiFeesMeter').style.width = Math.min(100, (monthFees/35000)*100)+'%';
      
      updateDailyMetrics();
    }

    function updateDailyMetrics(){
      const today = new Date().toDateString();
      const searches = JSON.parse(localStorage.getItem('privySearches')||'[]');
      const todaySearches = searches.find(s=>s.date===today)?.count || 0;
      
      const todayOffers = state.leads.filter(l=>l.offerSentDate && new Date(l.offerSentDate).toDateString()===today).length;
      const todayFollowups = state.calls.filter(c=>c.type==='call'&&new Date(c.ts).toDateString()===today).length;
      
      const totalLeads = state.leads.length;
      const responseLeads = state.leads.filter(l=>l.attempts>0).length;
      const responseRate = totalLeads > 0 ? Math.round((responseLeads/totalLeads)*100) : 0;
      
      document.getElementById('privySearchesToday').textContent = todaySearches;
      document.getElementById('offersSentToday').textContent = todayOffers;  
      document.getElementById('followUpsToday').textContent = todayFollowups;
      document.getElementById('responseRate').textContent = responseRate+'%';
      
      const totalSearches = searches.reduce((sum,s)=>sum+s.count,0);
      const totalOffers = state.leads.filter(l=>l.offerSent).length;
      const totalContracts = state.deals.filter(d=>d.status!=='lead').length;
      
      const searchToOfferRate = totalSearches>0 ? Math.round((totalOffers/totalSearches)*100) : 0;
      const offerToContractRate = totalOffers>0 ? Math.round((totalContracts/totalOffers)*100) : 0;
      
      document.getElementById('searchToOfferRate').textContent = searchToOfferRate+'%';
      document.getElementById('offerToContractRate').textContent = offerToContractRate+'%';
      
      document.getElementById('searchToOfferMeter').style.width = Math.min(100, searchToOfferRate)+'%';
      document.getElementById('offerToContractMeter').style.width = Math.min(100, offerToContractRate)+'%';
      
      const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth()+1, 0).getDate();
      const dayOfMonth = new Date().getDate();
      const monthProgress = dayOfMonth / daysInMonth;
      const monthContracts = state.deals.filter(d=>d.createdAt>=new Date(new Date().getFullYear(), new Date().getMonth(), 1).getTime()&&d.status!=='lead').length;
      const projectedContracts = monthContracts / monthProgress;
      const paceElement = document.getElementById('monthlyPace');
      const recElement = document.getElementById('paceRecommendation');
      
      if (paceElement) {
        paceElement.textContent = `Current: ${monthContracts} deals | Projected: ${Math.round(projectedContracts)} deals`;
      }
      
      if (recElement) {
        if (projectedContracts < 3) {
          recElement.textContent = "âš ï¸ Behind pace - increase daily activity";
        } else if (projectedContracts > 5) {
          recElement.textContent = "ðŸš€ Ahead of pace - maintain momentum!";
        } else {
          recElement.textContent = "âœ… On track for monthly goal";
        }
      }
    }

    document.getElementById('saveGoalsBtn') && document.getElementById('saveGoalsBtn').addEventListener('click',()=>{
      state.goals.convos = Number(document.getElementById('goalConvos').value||50);
      state.goals.offers = Number(document.getElementById('goalOffers').value||10);
      state.goals.contracts = Number(document.getElementById('goalContracts').value||5);
      save('goals',state.goals);
      updateKPI();
      alert('Goals saved');
    });

    document.getElementById('logPrivySearchBtn') && document.getElementById('logPrivySearchBtn').addEventListener('click',()=>{
      const searches = JSON.parse(localStorage.getItem('privySearches')||'[]');
      const today = new Date().toDateString();
      const todaySearch = searches.find(s=>s.date===today);
      if (todaySearch) {
        todaySearch.count++;
      } else {
        searches.push({date:today, count:1});
      }
      localStorage.setItem('privySearches', JSON.stringify(searches));
      updateDailyMetrics();
      alert('Privy search logged');
    });

    document.getElementById('markOfferSentBtn') && document.getElementById('markOfferSentBtn').addEventListener('click',()=>{
      const lead = state.leads[0];
      if (lead) {
        lead.offerSent = true;
        lead.offerSentDate = Date.now();
        saveWithSync('leads', state.leads);
        updateKPI();
        alert('Offer marked as sent');
      } else {
        alert('No leads to mark');
      }
    });

    document.getElementById('viewActivityLogBtn') && document.getElementById('viewActivityLogBtn').addEventListener('click',()=>{
      const log = state.calls.slice(-20).reverse().map(c=>
        `${new Date(c.ts).toLocaleString()}: ${c.type} ${c.leadId?'(Lead '+c.leadId+')':''}`
      ).join('\n');
      alert('Recent Activity:\n\n' + (log || 'No activity yet'));
    });

    // ========= Settings =========
    function loadSettingsUI(){
      document.getElementById('sbUrl').value = state.settings.sbUrl;
      document.getElementById('sbAnon').value = state.settings.sbAnon;
      document.getElementById('sbBucket').value = state.settings.sbBucket;
      document.getElementById('ejService').value = state.settings.ejService;
      document.getElementById('ejTemplate').value = state.settings.ejTemplate;
      document.getElementById('ejPublic').value = state.settings.ejPublic;
      
      document.getElementById('goalConvos').value = state.goals.convos;
      document.getElementById('goalOffers').value = state.goals.offers;
      document.getElementById('goalContracts').value = state.goals.contracts;
    }

    document.getElementById('saveSbBtn') && document.getElementById('saveSbBtn').addEventListener('click',()=>{
      state.settings.sbUrl = document.getElementById('sbUrl').value.trim();
      state.settings.sbAnon = document.getElementById('sbAnon').value.trim();
      state.settings.sbBucket = document.getElementById('sbBucket').value.trim();
      localStorage.setItem('SUPABASE_URL', state.settings.sbUrl);
      localStorage.setItem('SUPABASE_ANON', state.settings.sbAnon);
      localStorage.setItem('SUPABASE_BUCKET', state.settings.sbBucket);
      alert('Supabase settings saved');
    });

    document.getElementById('saveEjBtn') && document.getElementById('saveEjBtn').addEventListener('click',()=>{
      state.settings.ejService = document.getElementById('ejService').value.trim();
      state.settings.ejTemplate = document.getElementById('ejTemplate').value.trim();
      state.settings.ejPublic = document.getElementById('ejPublic').value.trim();
      localStorage.setItem('EJ_SERVICE', state.settings.ejService);
      localStorage.setItem('EJ_TEMPLATE', state.settings.ejTemplate);
      localStorage.setItem('EJ_PUBLIC', state.settings.ejPublic);
      alert('EmailJS settings saved');
    });

    // ========= Import/Export =========
    document.getElementById('exportCsvBtn') && document.getElementById('exportCsvBtn').addEventListener('click',()=>{
      const headers = ['Type','Address','Seller','Phone','Email','ARV','Ask','Status','Notes','Created'];
      const rows = [headers.join(',')];
      state.leads.forEach(l=>{
        const row = [
          'Lead',
          `"${l.address}"`,
          `"${l.seller||''}"`,
          l.phone||'',
          l.email||'',
          l.arv||'',
          l.ask||'',
          l.status||'',
          `"${(l.notes||'').replace(/"/g,'""')}"`,
          new Date(l.createdAt||Date.now()).toLocaleDateString()
        ];
        rows.push(row.join(','));
      });
      state.deals.forEach(d=>{
        const row = [
          'Deal',
          `"${d.propertyAddress}"`,
          `"${d.sellerNames||''}"`,
          '',
          '',
          '',
          d.purchasePrice||'',
          d.status||'',
          `"${(d.dealTerms||'').replace(/"/g,'""')}"`,
          new Date(d.createdAt||Date.now()).toLocaleDateString()
        ];
        rows.push(row.join(','));
      });
      const csv = rows.join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `REI_Export_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('backupBtn') && document.getElementById('backupBtn').addEventListener('click',()=>{
      const backup = {
        leads: state.leads,
        deals: state.deals,
        buyers: state.buyers,
        calls: state.calls,
        goals: state.goals,
        sprintTasks: state.sprintTasks,
        sprintStartDate: state.sprintStartDate,
        settings: state.settings,
        exportDate: new Date().toISOString()
      };
      const json = JSON.stringify(backup, null, 2);
      const blob = new Blob([json], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `REI_Backup_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('restoreBtn') && document.getElementById('restoreBtn').addEventListener('click',()=>{
      document.getElementById('restoreInput').click();
    });

    document.getElementById('restoreInput') && document.getElementById('restoreInput').addEventListener('change',(e)=>{
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try {
          const backup = JSON.parse(reader.result);
          if (confirm('Restore data? This will overwrite current data.')) {
            if (backup.leads) { state.leads = backup.leads; saveWithSync('leads', state.leads); }
            if (backup.deals) { state.deals = backup.deals; saveWithSync('deals', state.deals); }
            if (backup.buyers) { state.buyers = backup.buyers; save('buyers', state.buyers); }
            if (backup.calls) { state.calls = backup.calls; save('calls', state.calls); }
            if (backup.goals) { state.goals = backup.goals; save('goals', state.goals); }
            if (backup.sprintTasks) { state.sprintTasks = backup.sprintTasks; saveSprintTasks(); }
            if (backup.sprintStartDate) { state.sprintStartDate = backup.sprintStartDate; localStorage.setItem('sprintStartDate', backup.sprintStartDate);
                                        }                                     
            renderAll();
            alert('Data restored successfully');
          }
        } 
          catch (err) {
          alert('Invalid backup file');
        }
      };
      reader.readAsText(file);
    });

    // ========= CSV Import =========  
    document.getElementById('importLeadsBtn') && document.getElementById('importLeadsBtn').addEventListener('click',()=>{
      document.getElementById('importLeadsInput').click();
    });

    document.getElementById('importLeadsInput') && document.getElementById('importLeadsInput').addEventListener('change',(e)=>{
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        const csv = reader.result;
        const lines = csv.split('\n').filter(line=>line.trim());
        if (lines.length < 2) return alert('CSV must have headers and at least one row');
        
        const headers = lines[0].toLowerCase().split(',').map(h=>h.trim().replace(/"/g,''));
        const imported = [];
        
        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',').map(v=>v.trim().replace(/"/g,''));
          const lead = {
            id: 'L'+Date.now()+'_'+i,
            source: 'CSV Import',
            address: getValue('address', headers, values) || '',
            seller: getValue('seller', headers, values) || getValue('name', headers, values) || '',
            agent: getValue('agent', headers, values) || '',
            phone: getValue('phone', headers, values) || '',
            email: getValue('email', headers, values) || '',
            arv: Number(getValue('arv', headers, values) || 0),
            repairs: Number(getValue('repairs', headers, values) || 0),
            ask: Number(getValue('ask', headers, values) || getValue('list', headers, values) || 0),
            mortgageBalance: Number(getValue('mortgage', headers, values) || 0),
            dom: Number(getValue('dom', headers, values) || getValue('days', headers, values) || 0),
            propertyType: getValue('type', headers, values) || getValue('property', headers, values) || '',
            notes: getValue('notes', headers, values) || '',
            status: 'New',
            attempts: 0,
            offerSent: false,
            createdAt: Date.now(),
            nextAction: Date.now() + 24*3600*1000
          };
          
          if (lead.address) {
            imported.push(lead);
          }
        }
        
        if (imported.length > 0) {
          state.leads.unshift(...imported);
          saveWithSync('leads', state.leads);
          renderLeads();
          alert(`Imported ${imported.length} leads from CSV`);
        } else {
          alert('No valid leads found in CSV');
        }
      };
      reader.readAsText(file);
    });

    function getValue(key, headers, values) {
      const index = headers.findIndex(h => h.includes(key));
      return index >= 0 ? values[index] : '';
    }

    // ========= Privy Bulk Import Modal =========
    const bulkImportModal = document.getElementById('bulkImportModal');
    const privyBulkImportBtn = document.getElementById('privyBulkImportBtn');
    const closeBulkImport = document.getElementById('closeBulkImport');
    const selectPrivyFile = document.getElementById('selectPrivyFile');
    const privyFileInput = document.getElementById('privyFileInput');
    const processImport = document.getElementById('processImport');
    
    let privyData = [];
    
    privyBulkImportBtn && privyBulkImportBtn.addEventListener('click', ()=>{
      bulkImportModal.classList.remove('hidden');
    });
    
    closeBulkImport && closeBulkImport.addEventListener('click', ()=>{
      bulkImportModal.classList.add('hidden');
      document.getElementById('fieldMappingSection').classList.add('hidden');
      document.getElementById('previewSection').classList.add('hidden');
      processImport.classList.add('hidden');
    });
    
    selectPrivyFile && selectPrivyFile.addEventListener('click', ()=>{
      privyFileInput.click();
    });
    
    privyFileInput && privyFileInput.addEventListener('change', (e)=>{
      const file = e.target.files[0];
      if (!file) return;
      
      document.getElementById('privyFileName').textContent = file.name;
      
      const reader = new FileReader();
      reader.onload = ()=>{
        const csv = reader.result;
        const lines = csv.split('\n').filter(line=>line.trim());
        if (lines.length < 2) return alert('CSV must have headers and data');
        
        const headers = lines[0].split(',').map(h=>h.trim().replace(/"/g,''));
        privyData = { headers, rows: lines.slice(1) };
        
        const mappingSelects = ['mapAddress','mapOwner','mapMailing','mapPhone','mapEmail','mapARV','mapMortgage','mapEquity','mapType','mapDOM','mapListPrice','mapStatus'];
        mappingSelects.forEach(selectId => {
          const select = document.getElementById(selectId);
          if (select) {
            select.innerHTML = '<option value="">-- Skip --</option>';
            headers.forEach((header, idx) => {
              select.innerHTML += `<option value="${idx}">${header}</option>`;
            });
          }
        });
        
        document.getElementById('fieldMappingSection').classList.remove('hidden');
      };
      reader.readAsText(file);
    });
    
    function autoMapFields() {
      if (!privyData.headers) return;
      const headers = privyData.headers.map(h => h.toLowerCase());
      
      const mappings = {
        mapAddress: ['address', 'property address', 'property_address', 'street'],
        mapOwner: ['owner', 'owner name', 'owner_name', 'seller'],
        mapPhone: ['phone', 'owner phone', 'phone number'],
        mapEmail: ['email', 'owner email', 'email address'],
        mapARV: ['arv', 'value', 'estimated value', 'market value'],
        mapMortgage: ['mortgage', 'loan balance', 'mortgage balance'],
        mapEquity: ['equity', 'estimated equity'],
        mapListPrice: ['list price', 'asking price', 'price']
      };
      
      Object.keys(mappings).forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        for (let keyword of mappings[selectId]) {
          const index = headers.findIndex(h => h.includes(keyword));
          if (index >= 0) {
            select.value = index;
            break;
          }
        }
      });
    }
    
    document.getElementById('fieldMappingSection') && document.getElementById('fieldMappingSection').addEventListener('change', ()=>{
      if (!privyData.rows) return;
      
      autoMapFields();
      
      const preview = document.getElementById('importPreview');
      const totalRows = document.getElementById('totalRows');
      const validLeads = document.getElementById('validLeads');
      const duplicateCount = document.getElementById('duplicateCount');
      
      if (!preview) return;
      
      const mappings = {
        address: document.getElementById('mapAddress').value,
        owner: document.getElementById('mapOwner').value,
        phone: document.getElementById('mapPhone').value,
        email: document.getElementById('mapEmail').value,
        arv: document.getElementById('mapARV').value,
        mortgage: document.getElementById('mapMortgage').value
      };
      
      let validCount = 0;
      let dupCount = 0;
      preview.innerHTML = '';
      
      const sampleRows = privyData.rows.slice(0, 5);
      sampleRows.forEach((row, idx) => {
        const values = row.split(',').map(v => v.trim().replace(/"/g, ''));
        const address = mappings.address ? values[mappings.address] : '';
        const owner = mappings.owner ? values[mappings.owner] : '';
        
        if (address) {
          validCount++;
          if (state.leads.some(l => l.address.toLowerCase() === address.toLowerCase())) {
            dupCount++;
          }
        }
        
        preview.innerHTML += `<div>Row ${idx + 1}: ${address} | ${owner} | ARV: ${mappings.arv ? values[mappings.arv] : 'N/A'}</div>`;
      });
      
      totalRows.textContent = privyData.rows.length;
      validLeads.textContent = validCount;
      duplicateCount.textContent = dupCount;
      
      document.getElementById('previewSection').classList.remove('hidden');
      processImport.classList.remove('hidden');
    });
    
    processImport && processImport.addEventListener('click', ()=>{
      if (!privyData.rows) return;
      
      const mappings = {
        address: document.getElementById('mapAddress').value,
        owner: document.getElementById('mapOwner').value,
        phone: document.getElementById('mapPhone').value,
        email: document.getElementById('mapEmail').value,
        arv: document.getElementById('mapARV').value,
        mortgage: document.getElementById('mapMortgage').value,
        equity: document.getElementById('mapEquity').value,
        listPrice: document.getElementById('mapListPrice').value
      };
      
      const skipDuplicates = document.getElementById('skipDuplicates').checked;
      const autoCalcRepairs = document.getElementById('autoCalcRepairs').checked;
      const defaultSource = document.getElementById('defaultSource').value;
      
      const imported = [];
      let skipped = 0;
      
      privyData.rows.forEach((row, idx) => {
        const values = row.split(',').map(v => v.trim().replace(/"/g, ''));
        const address = mappings.address ? values[mappings.address] : '';
        
        if (!address) return;
        
        if (skipDuplicates && state.leads.some(l => l.address.toLowerCase() === address.toLowerCase())) {
          skipped++;
          return;
        }
        
        const arv = mappings.arv ? Number(values[mappings.arv] || 0) : 0;
        const repairs = autoCalcRepairs ? Math.round(arv * 0.25) : 0;
        
        const lead = {
          id: 'PL' + Date.now() + '_' + idx,
          source: defaultSource,
          address: address,
          seller: mappings.owner ? values[mappings.owner] : '',
          phone: mappings.phone ? values[mappings.phone] : '',
          email: mappings.email ? values[mappings.email] : '',
          arv: arv,
          repairs: repairs,
          ask: mappings.listPrice ? Number(values[mappings.listPrice] || 0) : 0,
          mortgageBalance: mappings.mortgage ? Number(values[mappings.mortgage] || 0) : 0,
          notes: `Imported from Privy - ${new Date().toLocaleDateString()}`,
          status: 'New',
          attempts: 0,
          offerSent: false,
          createdAt: Date.now(),
          nextAction: Date.now() + 24*3600*1000
        };
        
        imported.push(lead);
      });
      
      if (imported.length > 0) {
        state.leads.unshift(...imported);
        saveWithSync('leads', state.leads);
        renderLeads();
        bulkImportModal.classList.add('hidden');
        alert(`Successfully imported ${imported.length} leads! ${skipped > 0 ? `(${skipped} duplicates skipped)` : ''}`);
      } else {
        alert('No valid leads to import');
      }
    });

// Add these state extensions to your existing state object
state.agents = JSON.parse(localStorage.getItem('agents') || '[]');
state.extendedDeals = JSON.parse(localStorage.getItem('extendedDeals') || '[]');

// Agent management functions
function renderAgentsTable() {
  const tbody = document.getElementById('agentRows');
  if (!tbody) return;
  
  const search = (document.getElementById('agentSearch')?.value || '').toLowerCase();
  const filter = document.getElementById('agentFilter')?.value;
  
  tbody.innerHTML = '';
  
  state.agents
    .filter(agent => !filter || agent.relationship === filter)
    .filter(agent => !search || 
      agent.name.toLowerCase().includes(search) ||
      (agent.brokerage || '').toLowerCase().includes(search) ||
      (agent.area || '').toLowerCase().includes(search)
    )
    .forEach((agent, idx) => {
      const tr = document.createElement('tr');
      const lastContact = agent.lastContact ? new Date(agent.lastContact).toLocaleDateString() : 'Never';
      const relationshipColors = {
        active: 'badge-signed',
        warm: 'badge-offer', 
        cold: 'badge-lead',
        exclusive: 'badge-closed'
      };
      
      tr.innerHTML = `
        <td class="py-2 pr-4">
          <div class="font-medium">${agent.name}</div>
          <div class="text-xs text-gray-500">${agent.phone || ''} | ${agent.email || ''}</div>
        </td>
        <td class="py-2 pr-4">${agent.brokerage || ''}</td>
        <td class="py-2 pr-4">${agent.area || ''}</td>
        <td class="py-2 pr-4">
          <span class="badge ${relationshipColors[agent.relationship] || 'badge-lead'}">${agent.relationship || 'Cold'}</span>
        </td>
        <td class="py-2 pr-4">${agent.dealsCompleted || 0}</td>
        <td class="py-2 pr-4 text-xs">${lastContact}</td>
        <td class="py-2 pr-4">
          <div class="flex gap-1">
            <button class="btn btn-outline text-xs px-2 py-1 contact-agent" data-idx="${idx}">Contact</button>
            <button class="btn btn-outline text-xs px-2 py-1 edit-agent" data-idx="${idx}">Edit</button>
            <button class="btn btn-outline text-xs px-2 py-1 delete-agent" data-idx="${idx}">Del</button>
          </div>
        </td>
      `;
      
      tbody.appendChild(tr);
    });
    
  // Add event listeners
  tbody.querySelectorAll('.contact-agent').forEach(btn => {
    btn.addEventListener('click', () => contactAgent(btn.dataset.idx));
  });
  
  tbody.querySelectorAll('.edit-agent').forEach(btn => {
    btn.addEventListener('click', () => editAgent(btn.dataset.idx));
  });
  
  tbody.querySelectorAll('.delete-agent').forEach(btn => {
    btn.addEventListener('click', () => deleteAgent(btn.dataset.idx));
  });
}

function contactAgent(idx) {
  const agent = state.agents[idx];
  if (!agent) return;
  
  agent.lastContact = Date.now();
  agent.contactCount = (agent.contactCount || 0) + 1;
  
  save('agents', state.agents);
  renderAgentsTable();
  
  // Log the contact
  logConvo('agent_contact', { agentId: agent.id, agentName: agent.name });
}

function editAgent(idx) {
  const agent = state.agents[idx];
  if (!agent) return;
  
  const name = prompt('Agent name:', agent.name);
  if (name === null) return;
  
  const brokerage = prompt('Brokerage:', agent.brokerage || '');
  const area = prompt('Primary area:', agent.area || '');
  const phone = prompt('Phone:', agent.phone || '');
  const email = prompt('Email:', agent.email || '');
  const relationship = prompt('Relationship (active/warm/cold/exclusive):', agent.relationship || 'cold');
  
  agent.name = name;
  agent.brokerage = brokerage;
  agent.area = area;
  agent.phone = phone;
  agent.email = email;
  agent.relationship = relationship;
  
  save('agents', state.agents);
  renderAgentsTable();
}

function deleteAgent(idx) {
  if (confirm('Delete this agent?')) {
    state.agents.splice(idx, 1);
    save('agents', state.agents);
    renderAgentsTable();
  }
}

// Extended pipeline functions
function renderExtendedPipeline() {
  const timeframe = Number(document.getElementById('pipelineTimeframe')?.value || 90);
  const cutoff = Date.now() - (timeframe * 24 * 60 * 60 * 1000);
  
  const recentDeals = state.extendedDeals.filter(deal => deal.createdAt >= cutoff);
  
  // Update counts
  document.getElementById('extendedPipelineCount').textContent = `${recentDeals.length} deals`;
  
  const mlsDeals = recentDeals.filter(d => d.type === 'mls').length;
  const referralDeals = recentDeals.filter(d => d.type === 'agent-referral').length;
  const complexDeals = recentDeals.filter(d => d.type === 'complex').length;
  const jvDeals = recentDeals.filter(d => d.type === 'joint-venture').length;
  
  document.getElementById('mlsCount').textContent = mlsDeals;
  document.getElementById('referralCount').textContent = referralDeals;
  document.getElementById('complexCount').textContent = complexDeals;
  document.getElementById('jvCount').textContent = jvDeals;
  
  // Render pipeline cards
  const statuses = ['research', 'agent-contact', 'negotiation', 'due-diligence', 'ready-contract'];
  
  statuses.forEach(status => {
    const col = document.getElementById(`col-${status}`);
    if (!col) return;
    
    col.innerHTML = '';
    
    recentDeals.filter(deal => deal.status === status).forEach(deal => {
      const card = document.createElement('div');
      card.className = 'bg-white dark:bg-[#0b1322] rounded-xl border p-3 text-sm space-y-2 draggable';
      card.draggable = true;
      card.dataset.dealId = deal.id;
      
      const priorityColors = {
        urgent: 'badge-pending',
        high: 'badge-offer',
        medium: 'badge-lead',
        low: 'badge-lead opacity-60'
      };
      
      const typeLabels = {
        'mls': 'MLS',
        'agent-referral': 'Referral',
        'complex': 'Complex',
        'joint-venture': 'JV',
        'wholesale': 'Wholesale',
        'fix-flip': 'Fix & Flip'
      };
      
      card.innerHTML = `
        <div class="font-medium text-xs">${deal.address}</div>
        <div class="flex items-center justify-between">
          <span class="badge ${priorityColors[deal.priority] || 'badge-lead'}">${typeLabels[deal.type] || deal.type}</span>
          <span class="text-xs text-gray-500">${deal.timeline}d</span>
        </div>
        <div class="text-xs text-gray-600">
          List: ${money(deal.listPrice)} | ARV: ${money(deal.arv)}
        </div>
        <div class="text-xs text-gray-500">${deal.agentName || 'No agent'}</div>
        <div class="flex items-center gap-2 pt-2">
          <button class="btn btn-outline text-xs px-2 py-1 flex-1 edit-ext-deal">Edit</button>
          <button class="btn btn-outline text-xs px-2 py-1 flex-1 analyze-ext-deal">Analyze</button>
        </div>
      `;

      // Add event listeners for the buttons
      const editBtn = card.querySelector('.edit-ext-deal');
      const analyzeBtn = card.querySelector('.analyze-ext-deal');
      
      if (editBtn) {
        editBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          editExtendedDeal(deal.id);
        });
      }
      
      if (analyzeBtn) {
        analyzeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          analyzeDeal(deal);
        });
      }

      // Add drag and drop
      card.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', deal.id);
        card.classList.add('opacity-50');
      });
      
      card.addEventListener('dragend', () => {
        card.classList.remove('opacity-50');
      });
      
      col.appendChild(card);
    });
  });
  
  // Add drop zones
  statuses.forEach(status => {
    const col = document.getElementById(`col-${status}`);
    if (!col) return;
    
    col.addEventListener('dragover', (e) => {
      e.preventDefault();
      col.classList.add('bg-blue-100', 'dark:bg-blue-900/20');
    });
    
    col.addEventListener('dragleave', () => {
      col.classList.remove('bg-blue-100', 'dark:bg-blue-900/20');
    });
    
    col.addEventListener('drop', (e) => {
      e.preventDefault();
      col.classList.remove('bg-blue-100', 'dark:bg-blue-900/20');
      
      const dealId = e.dataTransfer.getData('text/plain');
      const deal = state.extendedDeals.find(d => d.id === dealId);
      
      if (deal) {
        deal.status = status;
        save('extendedDeals', state.extendedDeals);
        renderExtendedPipeline();
      }
    });
  });
}

// Event listeners
document.getElementById('addAgentBtn')?.addEventListener('click', () => {
  const name = prompt('Agent name:');
  if (!name) return;
  
  const agent = {
    id: 'A' + Date.now(),
    name,
    brokerage: prompt('Brokerage:') || '',
    area: prompt('Primary area:') || '',
    phone: prompt('Phone:') || '',
    email: prompt('Email:') || '',
    relationship: prompt('Relationship (active/warm/cold/exclusive):') || 'cold',
    dealsCompleted: 0,
    contactCount: 0,
    createdAt: Date.now()
  };
  
  state.agents.push(agent);
  save('agents', state.agents);
  renderAgentsTable();
});

document.getElementById('extendedDealForm')?.addEventListener('submit', (e) => {
  e.preventDefault();
  
  const deal = {
    id: 'ED' + Date.now(),
    address: document.getElementById('extPropertyAddress').value,
    type: document.getElementById('extDealType').value,
    timeline: Number(document.getElementById('extTimeline').value),
    listPrice: Number(document.getElementById('extListPrice').value || 0),
    arv: Number(document.getElementById('extARV').value || 0),
    repairs: Number(document.getElementById('extRepairs').value || 0),
    agentName: document.getElementById('extAgentName').value,
    commission: Number(document.getElementById('extCommission').value || 3),
    priority: document.getElementById('extPriority').value,
    notes: document.getElementById('extNotes').value,
    status: 'research',
    createdAt: Date.now()
  };
  
  state.extendedDeals.push(deal);
  save('extendedDeals', state.extendedDeals);
  
  document.getElementById('extendedDealForm').reset();
  renderExtendedPipeline();
  alert('Deal added to extended pipeline');
});

// Search and filter events
document.getElementById('agentSearch')?.addEventListener('input', renderAgentsTable);
document.getElementById('agentFilter')?.addEventListener('change', renderAgentsTable);
document.getElementById('pipelineTimeframe')?.addEventListener('change', renderExtendedPipeline);

// Update your renderAll function to include these
function renderAll(){
  renderLeads();
  renderDealsTable();
  renderPipeline();
  renderBuyersTable();
  renderAgentsTable();
  renderExtendedPipeline();
  renderDashboard();  // ADD THIS LINE
  updateKPI();
  loadSettingsUI();
  renderSevenDaySprint();
}

  document.addEventListener('DOMContentLoaded', () => {
      //setupCSVImport();
      //setupPrivyBulkImport();
      //setupEventListeners();
      renderAll();
  // Initialize Lucide icons if available
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    });
    
    // ========= ANALYZE DEAL FUNCTION =========
    function analyzeDeal(deal) {
      // Calculate key metrics
      const purchasePrice = deal.listPrice || 0;
      const arv = deal.arv || 0;
      const repairs = deal.repairs || 0;
      const commission = (deal.commission || 3) / 100;
      
      // Calculate using 70% rule
      const seventyPercentARV = arv * 0.7;
      const maxAllowableOffer = seventyPercentARV - repairs;
      
      // Calculate potential profits for different strategies
      const wholesaleFee = 10000; // Typical wholesale fee
      const wholesaleProfit = maxAllowableOffer - purchasePrice;
      
      // Fix & Flip calculations
      const holdingCosts = purchasePrice * 0.06; // 6% for 6 months typical
      const closingCosts = arv * 0.03; // 3% closing costs
      const sellingCosts = arv * commission; // Agent commission
      const flipProfit = arv - purchasePrice - repairs - holdingCosts - closingCosts - sellingCosts;
      
      // ROI calculations
      const totalInvestment = purchasePrice + repairs;
      const flipROI = totalInvestment > 0 ? (flipProfit / totalInvestment * 100) : 0;
      const wholesaleROI = purchasePrice > 0 ? (wholesaleFee / purchasePrice * 100) : 0;
      
      // Determine deal quality
      const dealQuality = purchasePrice <= maxAllowableOffer ? 'good' : 'risky';
      const dealIcon = dealQuality === 'good' ? 'âœ…' : 'âš ï¸';
      
      // Create modal overlay
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.style.backdropFilter = 'blur(4px)';
      
      // Create modal content
      const modalContent = document.createElement('div');
      modalContent.className = 'bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto animate-slideIn';
      modalContent.style.animation = 'slideIn 0.3s ease-out';
      
      modalContent.innerHTML = `
        <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-2xl">
          <div class="flex justify-between items-start">
            <div>
              <h2 class="text-2xl font-bold mb-2">Deal Analysis ${dealIcon}</h2>
              <p class="text-blue-100">${deal.address}</p>
            </div>
            <button class="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition-colors" id="closeModal">
              <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 6l12 12M18 6l-12 12"/>
              </svg>
            </button>
          </div>
        </div>
        
        <div class="p-6 space-y-4">
          <!-- Input Summary -->
          <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4">
            <h3 class="font-semibold text-gray-700 dark:text-gray-200 mb-3 flex items-center">
              <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-2">1</span>
              Input Numbers
            </h3>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">List Price:</span>
                <span class="font-medium">${money(purchasePrice)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">ARV:</span>
                <span class="font-medium">${money(arv)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Est. Repairs:</span>
                <span class="font-medium">${money(repairs)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Commission:</span>
                <span class="font-medium">${(commission * 100).toFixed(1)}%</span>
              </div>
            </div>
          </div>
          
          <!-- 70% Rule Analysis -->
          <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-xl p-4">
            <h3 class="font-semibold text-gray-700 dark:text-gray-200 mb-3 flex items-center">
              <span class="bg-yellow-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-2">2</span>
              70% Rule Analysis
            </h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between items-center">
                <span class="text-gray-600 dark:text-gray-400">70% of ARV:</span>
                <span class="font-medium">${money(seventyPercentARV)}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-600 dark:text-gray-400">Less Repairs:</span>
                <span class="font-medium text-red-600">-${money(repairs)}</span>
              </div>
              <div class="border-t pt-2 mt-2">
                <div class="flex justify-between items-center">
                  <span class="font-semibold">Max Allowable Offer:</span>
                  <span class="font-bold text-lg ${dealQuality === 'good' ? 'text-green-600' : 'text-orange-600'}">
                    ${money(maxAllowableOffer)}
                  </span>
                </div>
                <div class="mt-2 p-2 rounded-lg ${dealQuality === 'good' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                  ${dealQuality === 'good' 
                    ? `âœ… Deal meets 70% rule (${money(maxAllowableOffer - purchasePrice)} under MAO)`
                    : `âš ï¸ Deal exceeds 70% rule by ${money(purchasePrice - maxAllowableOffer)}`}
                </div>
              </div>
            </div>
          </div>
          
          <!-- Strategy Comparison -->
          <div class="grid md:grid-cols-2 gap-4">
            <!-- Wholesale Strategy -->
            <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl p-4">
              <h3 class="font-semibold text-gray-700 dark:text-gray-200 mb-3 flex items-center">
                <span class="bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-2">3</span>
                Wholesale Strategy
              </h3>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Purchase:</span>
                  <span>${money(purchasePrice)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Sell to Investor:</span>
                  <span>${money(maxAllowableOffer)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Assignment Fee:</span>
                  <span>${money(wholesaleFee)}</span>
                </div>
                <div class="border-t pt-2 mt-2">
                  <div class="flex justify-between items-center">
                    <span class="font-semibold">Profit:</span>
                    <span class="font-bold text-green-600">${money(wholesaleProfit)}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="font-semibold">ROI:</span>
                    <span class="font-bold">${wholesaleROI.toFixed(1)}%</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Fix & Flip Strategy -->
            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl p-4">
              <h3 class="font-semibold text-gray-700 dark:text-gray-200 mb-3 flex items-center">
                <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-2">4</span>
                Fix & Flip Strategy
              </h3>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Purchase:</span>
                  <span>${money(purchasePrice)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Repairs:</span>
                  <span>${money(repairs)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Holding (6mo):</span>
                  <span>${money(holdingCosts)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Closing:</span>
                  <span>${money(closingCosts)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Selling:</span>
                  <span>${money(sellingCosts)}</span>
                </div>
                <div class="border-t pt-2 mt-2">
                  <div class="flex justify-between items-center">
                    <span class="font-semibold">Profit:</span>
                    <span class="font-bold text-blue-600">${money(flipProfit)}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="font-semibold">ROI:</span>
                    <span class="font-bold">${flipROI.toFixed(1)}%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Recommendation -->
          <div class="bg-gradient-to-r ${flipProfit > wholesaleFee ? 'from-blue-500 to-blue-600' : 'from-green-500 to-green-600'} text-white rounded-xl p-4">
            <h3 class="font-semibold mb-2">ðŸ’¡ Recommendation</h3>
            <p class="text-sm">
              ${flipProfit > wholesaleFee 
                ? `Fix & Flip offers ${money(flipProfit - wholesaleFee)} more profit than wholesaling. With ${flipROI.toFixed(1)}% ROI, this property has strong flip potential if you have the capital and time.`
                : `Wholesale this deal for a quick ${money(wholesaleFee)} profit. The margins are too thin for flipping, but it's perfect for a cash buyer looking for a rental.`}
            </p>
          </div>
          
          <!-- Action Buttons -->
          <div class="flex gap-3 pt-2">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 py-2 px-4 rounded-lg transition-colors">
              Close
            </button>
            <button onclick="editExtendedDeal('${deal.id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors">
              Edit Deal
            </button>
            <button onclick="window.print()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg transition-colors">
              Print Analysis
            </button>
          </div>
        </div>
      `;
      
      // Add animation styles if not already present
      if (!document.getElementById('analyzeModalStyles')) {
        const style = document.createElement('style');
        style.id = 'analyzeModalStyles';
        style.textContent = `
          @keyframes slideIn {
            from {
              opacity: 0;
              transform: translateY(-20px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
        `;
        document.head.appendChild(style);
      }
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      // Event listeners
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
      
      modalContent.querySelector('#closeModal').addEventListener('click', () => {
        modal.remove();
      });
      
      // Keyboard escape to close
      const escapeHandler = (e) => {
        if (e.key === 'Escape') {
          modal.remove();
          document.removeEventListener('keydown', escapeHandler);
        }
      };
      document.addEventListener('keydown', escapeHandler);
    }
    
    // ========= EDIT EXTENDED DEAL FUNCTION =========
    function editExtendedDeal(dealId) {
      // Close the modal if it's open
      document.querySelector('.fixed')?.remove();
      
      const deal = state.extendedDeals.find(d => d.id === dealId);
      if (!deal) return;
      
      const newAddress = prompt('Property Address:', deal.address);
      if (newAddress === null) return;
      
      const newListPrice = prompt('List Price:', deal.listPrice);
      const newARV = prompt('ARV:', deal.arv);
      const newRepairs = prompt('Repair Costs:', deal.repairs);
      const newTimeline = prompt('Timeline (days):', deal.timeline);
      const newCommission = prompt('Commission %:', deal.commission || 3);
      
      deal.address = newAddress || deal.address;
      deal.listPrice = Number(newListPrice) || deal.listPrice;
      deal.arv = Number(newARV) || deal.arv;
      deal.repairs = Number(newRepairs) || deal.repairs;
      deal.timeline = Number(newTimeline) || deal.timeline;
      deal.commission = Number(newCommission) || deal.commission;
      
      save('extendedDeals', state.extendedDeals);
      renderExtendedPipeline();
      
      // Re-open the analysis with updated data
      analyzeDeal(deal);
    }
    
  </script>

<!-- =======================================================================
MBPS Deal Sprint â€” v1.3 FULL PATCH
Adds:
 - Status bar + Sync to S3 (merge load/save)
 - Offline Outbox for uploads
 - Property Analyzer (with Set Offer Price)
 - Photo & File uploads, Gallery + Lightbox
 - Health modal (API, Bucket, SW, storage)
 - Install App prompt helper
 - Dynamic Users (owner control + optional PIN)
 - Restore Versions modal (list via /listVersions; fallback by VersionId)
Notes:
 - Keeps your existing manifest, service worker, and icons.
 - Uses your deployed API: https://pocy3byloc.execute-api.us-east-1.amazonaws.com/prod
 - Uses dynamic userId from localStorage 'mbpsCurrentUser' (defaults to 'owner')
======================================================================== -->
<style>
/* -------- Toolbar helpers -------- */
.btn { display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border:1px solid rgba(148,163,184,.4); border-radius:10px; background:#fff; cursor:pointer; }
.btn.primary { background:#00a8ff; color:#fff; border-color:#00a8ff; }
.btn.brand { background:#10b981; color:#fff; border-color:#10b981; }
.btn:disabled { opacity:.55; cursor:not-allowed; }

.card { border:1px solid rgba(148,163,184,.35); border-radius:12px; padding:12px; background:#fff; }
.field label { display:block; font-size:12px; color:#6b7280; margin-bottom:4px; }
.tag { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid rgba(148,163,184,.4); }

.grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
.grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; }

.muted { color:#6b7280; }
.danger { color:#b91c1c; }

.right { text-align:right; }

/* -------- Status bar -------- */
.mbps-statusbar { position:sticky; top:0; z-index:20; padding:6px 12px; background:rgba(0,168,255,.08);
  border-bottom:1px solid rgba(0,168,255,.25); display:flex; gap:12px; align-items:center; flex-wrap:wrap }
.mbps-statusbar .badge { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid rgba(148,163,184,.4) }
.mbps-status-ok { color:#065f46; border-color:#34d399; background:#d1fae5 }
.mbps-status-warn { color:#92400e; border-color:#fbbf24; background:#fffbeb }
.mbps-outbox-pill { color:#1f2937; border-color:#a7f3d0; background:#ecfccb }

/* -------- Gallery -------- */
.mbps-gallery-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:10px; align-items:start; }
.mbps-gallery-item { border:1px solid rgba(148,163,184,.25); border-radius:10px; padding:6px; background:#fff; }
.mbps-gallery-item img { width:100%; height:120px; object-fit:cover; border-radius:6px; display:block; }
.mbps-gallery-item figcaption { font-size:12px; color:#6b7280; margin-top:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

/* -------- Lightbox -------- */
#mbpsLightbox { border:0; background:transparent; }
#mbpsLightbox .inner { background:#000; padding:0; max-width:94vw; max-height:90vh; overflow:auto; border-radius:12px; }
#mbpsLightbox img { display:block; max-width:94vw; max-height:88vh; }

/* -------- Responsive polish -------- */
@media (max-width:900px){
  table td, table th { white-space:normal; word-break:break-word; }
  .btn{ min-height:44px; }
}
</style>

<div id="mbpsStatus" class="mbps-statusbar" role="status" aria-live="polite" hidden>
  <span id="mbpsSyncState" class="badge">Sync</span>
  <span id="mbpsSyncTime" class="badge">â€”</span>
  <span id="mbpsOutboxBadge" class="badge mbps-outbox-pill" hidden>Outbox: 0</span>
</div>

<script>
(function(){
  // ======================================================================
  // CONFIG & CONSTANTS
  // ======================================================================
  const API_BASE = "https://pocy3byloc.execute-api.us-east-1.amazonaws.com/prod";
  const BUCKET   = "mbps-deal-sprint-sync-1756585879";

  // Users are dynamic; default to 'owner' if not set
  const LS_USERS = 'mbpsUsers';
  const LS_CURR  = 'mbpsCurrentUser';
  const LS_OWNER_PIN = 'mbpsOwnerPin';

  function getUsers(){
    try{
      const arr = JSON.parse(localStorage.getItem(LS_USERS)||'["owner"]');
      if(!Array.isArray(arr) || !arr.includes('owner')) return ['owner'];
      return arr;
    }catch(_){ return ['owner']; }
  }
  function saveUsers(list){ localStorage.setItem(LS_USERS, JSON.stringify(Array.from(new Set(['owner', ...list])))); }
  function getCurrentUser(){ return localStorage.getItem(LS_CURR) || 'owner'; }
  function setCurrentUser(u){ localStorage.setItem(LS_CURR, u || 'owner'); }

  const USER_ID = getCurrentUser();

  // Local storage keys
  const LS_DEALS     = 'mbpsDeals';
  const LS_SYNCED_AT = 'mbpsSyncedAt';
  const LS_OUTBOX    = 'mbpsOutbox'; // array of queued uploads for offline

  // Analyzer state
  let CURRENT_ANALYZE_DEAL_ID = null;

  // ======================================================================
  // UTILITIES
  // ======================================================================
  function getDeals(){
    try { return JSON.parse(localStorage.getItem(LS_DEALS)||'[]'); }
    catch(_){ return []; }
  }
  function saveDeals(deals){
    localStorage.setItem(LS_DEALS, JSON.stringify(deals));
  }
  function fmt(n){
    if(n===null||n===undefined||isNaN(n)) return '-';
    return Number(n).toLocaleString();
  }
  function fmtMoney(n){
    const v = Number(n||0);
    return v.toLocaleString(undefined, { minimumFractionDigits: 0 });
  }
  function dedupe(arr){ return Array.from(new Set(arr)); }
  function pickNewer(a,b){ return (+a.updatedAt||0) >= (+b.updatedAt||0) ? a : b; }

  // ======================================================================
  // STATUS BAR & CONNECTIVITY
  // ======================================================================
  const statusEl = document.getElementById('mbpsStatus');
  const stateEl  = document.getElementById('mbpsSyncState');
  const timeEl   = document.getElementById('mbpsSyncTime');
  const outboxEl = document.getElementById('mbpsOutboxBadge');

  function setStatus(ok, msg){
    statusEl.hidden = false;
    stateEl.className = 'badge ' + (ok ? 'mbps-status-ok' : 'mbps-status-warn');
    stateEl.textContent = ok ? 'ðŸŸ¢ ' + (msg||'Online') : 'ðŸ”´ ' + (msg||'Offline');
  }
  function setSyncedAt(ts){
    if(!ts){ timeEl.textContent='â€”'; return; }
    timeEl.textContent = 'Last synced: ' + new Date(Number(ts)||ts).toLocaleString();
  }

  window.addEventListener('online', ()=>{ setStatus(true,'Online'); retryOutbox(); });
  window.addEventListener('offline', ()=> setStatus(false,'Offline'));

  // ======================================================================
  // OUTBOX (OFFLINE UPLOADS QUEUE)
  // ======================================================================
  function getOutbox(){
    try { return JSON.parse(localStorage.getItem(LS_OUTBOX)||'[]'); }
    catch(_){ return []; }
  }
  function saveOutbox(list){
    localStorage.setItem(LS_OUTBOX, JSON.stringify(list));
    refreshOutboxBadge();
  }
  function refreshOutboxBadge(){
    const q = getOutbox();
    if(q.length){ outboxEl.hidden = false; outboxEl.textContent = 'Outbox: ' + q.length; }
    else { outboxEl.hidden = true; }
  }
  async function retryOutbox(){
    const list = getOutbox();
    if(!list.length) return;
    const remaining = [];
    for(const item of list){
      try{
        if(!item.dataUrl){ remaining.push(item); continue; }
        const blob = await (await fetch(item.dataUrl)).blob();
        await uploadBlobWithKey(item.key, blob.type||item.mime||'application/octet-stream', blob);
      }catch(e){
        remaining.push(item);
      }
    }
    saveOutbox(remaining);
  }

// ======================================================================
// UNIFIED S3 SYNC SYSTEM - INSERT THIS ENTIRE BLOCK
// ======================================================================
const S3Sync = {
  API_BASE: "https://pocy3byloc.execute-api.us-east-1.amazonaws.com/prod",
  USER_ID: localStorage.getItem('mbpsCurrentUser') || 'owner',
  SYNC_INTERVAL: 5 * 60 * 1000, // 5 minutes
  
  isDirty: false,
  lastSync: parseInt(localStorage.getItem('lastS3Sync') || '0'),
  syncTimer: null,
  
  async getPresignedUrl(action = 'get') {
    const endpoint = action === 'get' ? '/getUrl' : '/putUrl';
    const url = `${this.API_BASE}${endpoint}?userId=${this.USER_ID}&file=deals.json`;
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      return data.url;
    } catch (error) {
      console.error('Presigned URL error:', error);
      throw error;
    }
  },
  
  markDirty() {
    this.isDirty = true;
    localStorage.setItem('hasUnsyncedChanges', 'true');
    this.updateIndicator();
  },
  
  async push() {
    if (!this.isDirty) return true;
    
    try {
      const url = await this.getPresignedUrl('put');
      
      const fullData = {
        deals: state.deals || [],
        leads: state.leads || [],
        buyers: state.buyers || [],
        agents: state.agents || [],
        contracts: state.contracts || [],
        extendedDeals: state.extendedDeals || [],
        sprintTasks: state.sprintTasks || [],
        settings: state.settings || {},
        goals: state.goals || {},
        timestamp: Date.now()
      };
      
      const response = await fetch(url, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(fullData)
      });
      
      if (response.ok) {
        this.isDirty = false;
        this.lastSync = Date.now();
        localStorage.setItem('lastS3Sync', this.lastSync);
        localStorage.removeItem('hasUnsyncedChanges');
        console.log('âœ… Synced to S3');
        this.updateIndicator();
      }
      
      return response.ok;
    } catch (error) {
      console.error('S3 sync error:', error);
      return false;
    }
  },
  
  async pull() {
    try {
      const url = await this.getPresignedUrl('get');
      const response = await fetch(url);
      
      if (response.status === 404) {
        console.log('No remote data yet');
        return null;
      }
      
      const remoteData = await response.json();
      return remoteData;
    } catch (error) {
      console.error('S3 pull error:', error);
      return null;
    }
  },
  
  updateIndicator() {
    const badge = document.getElementById('mbpsOutboxBadge');
    if (badge) {
      badge.textContent = this.isDirty ? 'Unsaved' : 'Synced';
      badge.className = this.isDirty ? 
        'badge mbps-outbox-pill mbps-status-warn' : 
        'badge mbps-outbox-pill mbps-status-ok';
      badge.hidden = false;
    }
  },
  
  init() {
    this.syncTimer = setInterval(() => {
      if (this.isDirty) this.push();
    }, this.SYNC_INTERVAL);
    
    window.addEventListener('beforeunload', () => {
      if (this.isDirty) this.push();
    });
    
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && this.isDirty) this.push();
    });
    
    if (localStorage.getItem('hasUnsyncedChanges') === 'true') {
      this.isDirty = true;
      setTimeout(() => this.push(), 3000);
    }
  }
};

// Replace ALL save() calls with saveWithSync()
function saveWithSync(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
  S3Sync.markDirty();
}

  // ======================================================================
  // UPLOADS: PHOTOS + ANY FILES
  // ======================================================================
 async function uploadBlobWithKey(key, mime, blob){
    // Define constants locally to avoid dependency issues
    const API_BASE = "https://pocy3byloc.execute-api.us-east-1.amazonaws.com/prod";
    const userId = localStorage.getItem('mbpsCurrentUser') || 'owner';
    
    try {
        // Get presigned URL for upload
        const presignResponse = await fetch(`${API_BASE}/putUrl?userId=${userId}&file=${encodeURIComponent(key)}`);
        if (!presignResponse.ok) throw new Error(`Failed to get presigned URL: ${presignResponse.status}`);
        const presignData = await presignResponse.json();
        const putUrl = presignData.url;
        
        // Upload the blob
        const uploadResponse = await fetch(putUrl, { 
            method: 'PUT', 
            headers: {'content-type': mime}, 
            body: blob 
        });
        if(!uploadResponse.ok) throw new Error('Upload failed');
    } catch(error) {
        console.error('Upload error:', error);
        throw error;
    }
}
  async function uploadDealPhoto(dealId){
    const input = document.createElement('input');
    input.type='file'; input.accept='image/*'; input.click();
    input.onchange = async () => {
      const file = input.files?.[0]; if(!file) return;
      const ext = (file.type && file.type.split('/')[1]) || 'jpg';
      const key = `deals/${dealId}/photos/${crypto.randomUUID()}.${ext}`;
      try{
        await uploadBlobWithKey(key, file.type||'image/jpeg', file);
        upsertAttachmentKey(dealId, key);
        const gal = document.querySelector(`[data-gallery="{dealId}"]`.replace('{dealId}', dealId));
        if (gal) renderDealGallery(dealId, gal);
        alert('Photo uploaded');
      }catch(e){
        if(file.size <= 2*1024*1024){
          const reader = new FileReader();
          reader.onload = () => {
            const list = getOutbox();
            list.push({dealId, key, mime: file.type||'image/jpeg', size: file.size, dataUrl: reader.result, ts: Date.now()});
            saveOutbox(list);
            upsertAttachmentKey(dealId, key);
            const gal = document.querySelector(`[data-gallery="{dealId}"]`.replace('{dealId}', dealId));
            if (gal) renderDealGallery(dealId, gal);
            alert('Offline â€” queued photo for retry');
          };
          reader.readAsDataURL(file);
        }else{
          alert('Upload failed and file too large to queue offline (2MB limit). Try again when online.');
        }
      }
    };
  }

  async function pickAndUploadFile(dealId){
    const input = document.createElement('input');
    input.type='file'; input.accept='*/*'; input.click();
    input.onchange = async () => {
      const file = input.files?.[0]; if(!file) return;
      const safeName = (file.name||'file').replace(/[^a-zA-Z0-9_.-]/g,'_');
      const key = `deals/${dealId}/files/${Date.now()}-${safeName}`;
      try{
        await uploadBlobWithKey(key, file.type||'application/octet-stream', file);
        upsertAttachmentKey(dealId, key);
        const deals = getDeals();
        const d = deals.find(x=>x._id===dealId);
        if(d){ ensureMeta(d); d.attachmentsMeta[key] = { mime:file.type||'application/octet-stream', size:file.size||0, name:safeName, ts: Date.now() }; saveDeals(deals); }
        const gal = document.querySelector(`[data-gallery="{dealId}"]`.replace('{dealId}', dealId));
        if (gal) renderDealGallery(dealId, gal);
        alert('File uploaded');
      }catch(e){ alert('Upload failed: ' + e.message); }
    };
  }

  function isImageKey(k){ return /\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(k); }

  async function renderDealGallery(dealId, container){
    const deals = getDeals();
    const d = deals.find(x=>x._id===dealId);
    const keys = (d && d.attachments)||[];
    if(!keys.length){ container.innerHTML = '<div style="color:#6b7280">No files yet.</div>'; return; }
    container.innerHTML = '';
    const grid = document.createElement('div'); grid.className='mbps-gallery-grid';
    container.append(grid);

    const LIMIT = 12;
    let shown = 0;
    async function renderChunk(){
      const end = Math.min(shown + LIMIT, keys.length);
      const slice = keys.slice(shown, end);
      for(const key of slice){
        const fig = document.createElement('figure'); fig.className='mbps-gallery-item';
        try{
          if(isImageKey(key)){
            const API_BASE = "https://pocy3byloc.execute-api.us-east-1.amazonaws.com/prod";
            const userId = localStorage.getItem('mbpsCurrentUser') || 'owner';
            const presignResponse = await fetch(`${API_BASE}/getUrl?userId=${userId}&file=${encodeURIComponent(key)}`);
            if (!presignResponse.ok) throw new Error('Failed to get URL');
            const presignData = await presignResponse.json();
            const url = presignData.url;
            const img = new Image();
            img.loading='lazy'; img.decoding='async'; img.src=url; img.alt=dealId+' file';
            img.addEventListener('click', ()=> openLightbox(url));
            const cap = document.createElement('figcaption'); cap.textContent = key.split('/').slice(-1)[0];
            fig.append(img, cap);
          }else{
          const ext = key.split('.').pop().toUpperCase();
        const chip = document.createElement('div'); chip.className='doc-chip';
        chip.textContent = ext + ' ';
        const a = document.createElement('a'); a.href='#'; a.textContent = key.split('/').slice(-1)[0];
        a.addEventListener('click', async (e)=>{ 
        e.preventDefault(); 
        const API_BASE = "https://pocy3byloc.execute-api.us-east-1.amazonaws.com/prod";
        const userId = localStorage.getItem('mbpsCurrentUser') || 'owner';
        const presignResponse = await fetch(`${API_BASE}/getUrl?userId=${userId}&file=${encodeURIComponent(key)}`);
        if (!presignResponse.ok) throw new Error('Failed to get URL');
        const presignData = await presignResponse.json();
        const url = presignData.url;
        window.open(url, '_blank');
    });
    const wrap = document.createElement('div'); wrap.style.padding='8px';
    wrap.append(chip, a);
    fig.append(wrap);
}
        }catch(e){
          fig.innerHTML = '<div style="color:#ef4444;padding:8px">Failed to load item</div>';
        }
        grid.append(fig);
      }
      shown = end;
    }

    await renderChunk();
    if(keys.length > shown){
      const showMore = document.createElement('button');
      showMore.className = 'btn'; showMore.textContent = 'Load moreâ€¦ ('+(keys.length - shown)+')';
      container.append(showMore);
      showMore.addEventListener('click', async ()=>{
        await renderChunk();
        if(keys.length <= shown) showMore.remove();
        else showMore.textContent = 'Load moreâ€¦ ('+(keys.length - shown)+')';
      });
    }
  }
  window.renderDealGallery = window.renderDealGallery || renderDealGallery;

  // ======================================================================
  // LIGHTBOX
  // ======================================================================
  document.addEventListener('DOMContentLoaded', ()=>{
      // Initialize S3 Sync
      S3Sync.init();
    
    if(!document.getElementById('mbpsLightbox')){
      const dlg = document.createElement('dialog');
      dlg.id = 'mbpsLightbox';
      dlg.innerHTML = '<div class="inner"><img alt="Preview"/></div>';
      document.body.appendChild(dlg);
      dlg.addEventListener('click', ()=> dlg.close());
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') dlg.close(); });
    }
  });
  function openLightbox(src){
    const dlg = document.getElementById('mbpsLightbox');
    const img = dlg.querySelector('img');
    img.src = src;
    dlg.showModal();
  }

  // ======================================================================
  // ANALYZER (with Set Offer Price)
  // ======================================================================
  function analyze(inputs){
    const arv = +inputs.arv||0, repairs = +inputs.repairs||0, fee= +inputs.fee||0;
    const holdPct = (+inputs.holdPct||10)/100;
    const rent = +inputs.rent||0, piti = +inputs.piti||0;
    const maxOfferWholesale = Math.max(0, arv*0.7 - repairs - fee);
    const carrying = arv * holdPct;
    const cashflow = rent - piti;
    let strat = 'Wholesale';
    if (cashflow >= 300) strat = 'Buy & Hold';
    if (piti>0 && cashflow>0 && maxOfferWholesale<=0) strat = 'Subject-To';
    return { maxOfferWholesale, carrying, cashflow, strat };
  }
  function setOfferOnCurrentDeal(val){
    if(!CURRENT_ANALYZE_DEAL_ID) return;
    const deals = getDeals();
    const d = deals.find(x=>x._id===CURRENT_ANALYZE_DEAL_ID);
    if(!d) return;
    d.offerPrice = Math.round(+val||0);
    d.updatedAt = Date.now();
    saveDeals(deals);
    if (window.renderDealsTable) try { window.renderDealsTable(); } catch(_){}
    alert('Offer updated on deal');
  }

  // Professional Wholesale Calculator - ADD AFTER existing analyze function (around line 4010)
function analyzeWholesalePro(inputs) {
  const arv = Number(inputs.arv || 0);
  const repairs = Number(inputs.repairs || 0);
  const fee = Number(inputs.fee || inputs.wholesaleFee || 10000);
  const marketing = Number(inputs.marketingCost || 0);
  
  // Professional wholesale formulas
  const maxOffer = (arv * 0.70) - repairs - fee;
  const cashBuyerPrice = (arv * 0.70) - repairs;
  const spread = cashBuyerPrice - maxOffer;
  const roi = marketing > 0 ? ((fee - marketing) / marketing * 100) : 0;
  
  // Deal strength analysis
  let dealStrength = 'Weak';
  let strengthClass = 'text-red-600';
  if (spread >= 15000) {
    dealStrength = 'Strong';
    strengthClass = 'text-green-600';
  } else if (spread >= 8000) {
    dealStrength = 'Moderate';
    strengthClass = 'text-yellow-600';
  }
  
  // Negotiation ranges
  const minAcceptable = maxOffer * 0.85;
  const walkAway = maxOffer * 0.75;
  
  return {
    maxOffer,
    cashBuyerPrice,
    spread,
    dealStrength,
    strengthClass,
    roi,
    minAcceptable,
    walkAway,
    recommendation: spread >= 10000 ? 'PROCEED' : 'PASS'
  };
}

// Also add this helper function for live calculations on the lead form
function updateLiveAnalysis() {
  const arv = Number(document.getElementById('leadARV')?.value || 0);
  const repairs = Number(document.getElementById('leadRepairs')?.value || 0);
  const ask = Number(document.getElementById('leadAsk')?.value || 0);
  
  const result = analyzeWholesalePro({ arv, repairs, fee: 10000 });
  
  // Update the display values
  const maoEl = document.getElementById('maoVal');
  const cashEl = document.getElementById('cashOfferVal'); 
  const spreadEl = document.getElementById('spreadVal');
  const strengthEl = document.getElementById('dealStrengthVal');
  
  if (maoEl) maoEl.textContent = money(result.maxOffer);
  if (cashEl) cashEl.textContent = money(result.minAcceptable);
  if (spreadEl) spreadEl.textContent = money(result.spread);
  if (strengthEl) {
    strengthEl.textContent = result.dealStrength;
    strengthEl.className = 'font-bold ' + result.strengthClass;
  }
}

  document.addEventListener('DOMContentLoaded', ()=>{
    if(!document.getElementById('analyzer')){
      const tpl = document.createElement('template');
      tpl.innerHTML = `
<dialog id="analyzer" style="border:0;border-radius:18px;padding:0;width:min(960px,94vw);">
  <div style="padding:14px 16px;border-bottom:1px solid rgba(148,163,184,.25);display:flex;justify-content:space-between;align-items:center;">
    <strong>Deal Analyzer</strong>
    <button id="closeAnalyzer" class="btn">Close</button>
  </div>
  <div style="padding:16px;max-height:70vh;overflow:auto;">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
      <div class="card">
        <h4>Inputs</h4>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;">
          <div class="field"><label>ARV</label><input id="anArv" type="number" placeholder="220000" /></div>
          <div class="field"><label>Repairs</label><input id="anRepairs" type="number" placeholder="35000" /></div>
          <div class="field"><label>Assignment Fee</label><input id="anFee" type="number" placeholder="10000" value="10000" /></div>
          <div class="field"><label>Holding %</label><input id="anHoldPct" type="number" placeholder="10" value="10" /></div>
          <div class="field"><label>Buy & Hold Rent</label><input id="anRent" type="number" placeholder="1800" /></div>
          <div class="field"><label>Sub2 PITI</label><input id="anPITI" type="number" placeholder="1350" /></div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="runAnalyze" class="btn">Analyze</button>
          <button id="setOfferBtn" class="btn primary" disabled>Set Offer Price</button>
        </div>
      </div>
      <div class="card">
        <h4>Results</h4>
        <div id="anResults" style="color:#64748b">Enter inputs and click Analyze.</div>
      </div>
    </div>
  </div>
</dialog>`;
      document.body.appendChild(tpl.content);
    }
    function openAnalyzerPrefill(d){
      CURRENT_ANALYZE_DEAL_ID = d && d._id;
      document.getElementById('anArv').value = d?.arv || '';
      document.getElementById('anRepairs').value = d?.repairs || '';
      document.getElementById('anFee').value = 10000;
      document.getElementById('anHoldPct').value = 10;
      document.getElementById('anRent').value = d?.estimatedRent || '';
      document.getElementById('anPITI').value = d?.piti || '';
      document.getElementById('setOfferBtn').disabled = true;
      document.getElementById('analyzer').showModal();
    }
    window.mbpsOpenAnalyzerPrefill = openAnalyzerPrefill;

    document.getElementById('closeAnalyzer')?.addEventListener('click', ()=> document.getElementById('analyzer').close());
    document.getElementById('runAnalyze')?.addEventListener('click', ()=>{
      const vals = {
        arv: document.getElementById('anArv').value,
        repairs: document.getElementById('anRepairs').value,
        fee: document.getElementById('anFee').value,
        holdPct: document.getElementById('anHoldPct').value,
        rent: document.getElementById('anRent').value,
        piti: document.getElementById('anPITI').value
      };
      const r = analyze(vals);
      document.getElementById('anResults').innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;">
          <div class="field"><label>Max Offer (Wholesale)</label><div class="tag">$ ${fmtMoney(r.maxOfferWholesale)}</div></div>
          <div class="field"><label>Carrying Reserve</label><div class="tag">$ ${fmtMoney(r.carrying)}</div></div>
          <div class="field"><label>Cashflow (rent - PITI)</label><div class="tag">$ ${fmtMoney(r.cashflow)}</div></div>
        </div>
        <div style="margin-top:12px"><strong>Suggested Strategy:</strong> ${r.strat}</div>`;
      const setBtn = document.getElementById('setOfferBtn');
      setBtn.disabled = false;
      setBtn.onclick = ()=> setOfferOnCurrentDeal(r.maxOfferWholesale);
    });
  });

  // ======================================================================
  // TOOLBAR BUTTONS (Sync, Property Evaluation, Analyze, Users, Restore, Health, Install)
  // ======================================================================
  document.addEventListener('DOMContentLoaded', ()=>{
    const toolbar = document.querySelector('.toolbar') || document.body;
    function addBtn(id, label, onClick, cls='btn'){
      if(document.getElementById(id)) return;
      const b = document.createElement('button');
      b.id=id; b.className=cls; b.type='button'; b.textContent=label; b.style.marginLeft='6px';
      b.addEventListener('click', onClick);
      toolbar.appendChild(b);
    }
    addBtn('syncBtn', 'Sync (S3)', async ()=>{
      const save = confirm('OK = Save to S3, Cancel = Load & Merge from S3');
      try { save ? await syncSave() : await syncLoad(); } catch(e){ alert(e.message); }
    });
    addBtn('evalBtn', 'Property Evaluation', ()=>{ document.getElementById('analyzer')?.showModal(); }, 'btn primary');
    addBtn('analyzeBtn', 'Analyze Deal', ()=>{ document.getElementById('analyzer')?.showModal(); }, 'btn brand');
    addBtn('mbpsHealthBtn', 'Health', ()=> document.getElementById('mbpsHealth').showModal(), 'btn');

    if(!document.getElementById('mbpsUserBtn')){
      addBtn('mbpsUserBtn','Users', ()=> document.getElementById('mbpsUsersModal').showModal(), 'btn');
    }
    if(!document.getElementById('mbpsRestoreBtn')){
      addBtn('mbpsRestoreBtn','Restore', ()=> openRestoreModal(), 'btn');
    }

    setStatus(navigator.onLine, navigator.onLine?'Online':'Offline');
    setSyncedAt(localStorage.getItem(LS_SYNCED_AT));
    refreshOutboxBadge();
  });

  // ======================================================================
  // HEALTH MODAL
  // ======================================================================
  document.addEventListener('DOMContentLoaded', async ()=>{
    if(!document.getElementById('mbpsHealth')){
      const tpl = document.createElement('template');
      tpl.innerHTML = `
<dialog id="mbpsHealth" style="border:0;border-radius:14px;padding:0;width:min(720px,94vw);">
  <div style="padding:12px 14px;border-bottom:1px solid rgba(148,163,184,.3);display:flex;justify-content:space-between;align-items:center;">
    <strong>System Health</strong>
    <button class="btn" onclick="document.getElementById('mbpsHealth').close()">Close</button>
  </div>
  <div style="padding:14px;">
    <div class="grid-2">
      <div class="card">
        <h4>Backend</h4>
        <div class="field"><label>API Base</label><div class="tag">https://pocy3byloc.execute-api.us-east-1.amazonaws.com/prod</div></div>
        <div class="field"><label>Bucket</label><div class="tag">mbps-deal-sprint-sync-1756585879</div></div>
        <div class="field"><label>Service Worker</label><div id="swStat" class="tag">â€”</div></div>
      </div>
      <div class="card">
        <h4>Local</h4>
        <div class="field"><label>Current User</label><div id="curUserTag" class="tag">â€”</div></div>
        <div class="field"><label>Last Synced</label><div id="lastSyncTag" class="tag">â€”</div></div>
        <div class="field"><label>Storage</label><div id="storTag" class="tag">â€”</div></div>
      </div>
    </div>
  </div>
</dialog>`;
      document.body.appendChild(tpl.content);
    }
    const sw = navigator.serviceWorker && navigator.serviceWorker.controller ? 'Active' : 'Not controlling';
    const swEl = document.getElementById('swStat'); if(swEl) swEl.textContent = sw;
    const last = localStorage.getItem(LS_SYNCED_AT);
    const lsEl = document.getElementById('lastSyncTag'); if(lsEl) lsEl.textContent = last ? new Date(Number(last)||last).toLocaleString() : 'â€”';
    const cuEl = document.getElementById('curUserTag'); if(cuEl) cuEl.textContent = USER_ID;
    if(navigator.storage && navigator.storage.estimate){
      try{
        const est = await navigator.storage.estimate();
        const used = Math.round((est.usage||0)/1024/1024);
        const quota= Math.round((est.quota||0)/1024/1024);
        const sEl = document.getElementById('storTag'); if(sEl) sEl.textContent = used + ' MB / ' + quota + ' MB';
      }catch(_){}
    }
  });

  // ======================================================================
  // INSTALL BUTTON (simple helper; native prompt handled by browser)
  // ======================================================================
  let deferredPrompt = null;
  function isiOS(){ return /iphone|ipad|ipod/i.test(navigator.userAgent); }
  function isSafari(){ return /^((?!chrome|android).)*safari/i.test(navigator.userAgent); }
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault();
    deferredPrompt = e;
    showInstallButton();
  });
  function showInstallButton(){
    if(document.getElementById('mbpsInstallBtn')) return;
    const toolbar = document.querySelector('.toolbar') || document.body;
    const b = document.createElement('button');
    b.id='mbpsInstallBtn'; b.className='btn'; b.textContent='Install App';
    toolbar.appendChild(b);
    b.addEventListener('click', async ()=>{
      if(deferredPrompt){
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
      }else if(isiOS() && isSafari()){
        alert('On iOS Safari: Share â–¶ Add to Home Screen');
      }else{
        alert('Your browser may not support one-click install. Try Chrome on Android or Edge/Chrome on desktop.');
      }
    });
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    if(isiOS() && isSafari()){ showInstallButton(); }
  });

  // ======================================================================
  // USERS MODAL (Owner control + optional PIN) + RESTORE MODAL
  // ======================================================================
  function isOwner(){
    return getCurrentUser()==='owner' && verifyOwnerPinSilent();
  }
  function setOwnerPin(pin){
    if(!pin){ localStorage.removeItem(LS_OWNER_PIN); return; }
    localStorage.setItem(LS_OWNER_PIN, pin);
  }
  function verifyOwnerPinSilent(){
    const pin = localStorage.getItem(LS_OWNER_PIN);
    if(!pin) return true; // no pin set => pass
    if(sessionStorage.getItem('mbpsOwnerOk')==='1') return true;
    const entered = prompt('Enter owner PIN to manage users (set in Users modal):') || '';
    const ok = (entered === pin);
    if(ok) sessionStorage.setItem('mbpsOwnerOk','1');
    return ok;
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    if(!document.getElementById('mbpsUsersModal')){
      const tpl = document.createElement('template');
      tpl.innerHTML = `
<dialog id="mbpsUsersModal" style="border:0;border-radius:14px;padding:0;width:min(720px,94vw)">
  <div style="padding:12px 14px;border-bottom:1px solid rgba(148,163,184,.3);display:flex;justify-content:space-between;align-items:center;">
    <strong>Users & Profiles</strong>
    <button class="btn" onclick="document.getElementById('mbpsUsersModal').close()">Close</button>
  </div>
  <div style="padding:14px" id="mbpsUsersBody"></div>
</dialog>`;
      document.body.appendChild(tpl.content);
    }
    if(!document.getElementById('mbpsRestoreModal')){
      const tpl = document.createElement('template');
      tpl.innerHTML = `
<dialog id="mbpsRestoreModal" style="border:0;border-radius:14px;padding:0;width:min(860px,96vw)">
  <div style="padding:12px 14px;border-bottom:1px solid rgba(148,163,184,.3);display:flex;justify-content:space-between;align-items:center;">
    <strong>Restore Previous Version</strong>
    <button class="btn" onclick="document.getElementById('mbpsRestoreModal').close()">Close</button>
  </div>
  <div style="padding:14px" id="mbpsRestoreBody">
    <div class="muted">Fetching versionsâ€¦</div>
  </div>
</dialog>`;
      document.body.appendChild(tpl.content);
    }
    ensureUserToolbar();
    renderUsersBody();
  });

  function ensureUserToolbar(){
    const bar = document.querySelector('.toolbar') || document.body;
    if(!document.getElementById('mbpsUserBtn')){
      const btn = document.createElement('button');
      btn.id='mbpsUserBtn'; btn.className='btn'; btn.textContent='Users';
      btn.addEventListener('click', ()=> document.getElementById('mbpsUsersModal').showModal());
      bar.appendChild(btn);
    }
    if(!document.getElementById('mbpsRestoreBtn')){
      const btn = document.createElement('button');
      btn.id='mbpsRestoreBtn'; btn.className='btn'; btn.textContent='Restore';
      btn.addEventListener('click', ()=> openRestoreModal());
      bar.appendChild(btn);
    }
  }

  function renderUsersBody(){
    const body = document.getElementById('mbpsUsersBody');
    const users = getUsers();
    const current = getCurrentUser();
    body.innerHTML = '';
    const wrap = document.createElement('div'); wrap.className='grid-2';

    const left = document.createElement('div'); left.className='card';
    left.innerHTML = '<h4>Profiles</h4>';
    users.forEach(u=>{
      const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.margin='8px 0';
      const name = document.createElement('div');
      name.innerHTML = '<strong>'+u+'</strong>' + (u==='owner' ? ' <span class="muted">(owner)</span>' : '');
      const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
      const switchBtn = document.createElement('button'); switchBtn.className='btn'; switchBtn.textContent = (u===current?'Current':'Switch');
      switchBtn.disabled = (u===current);
      switchBtn.addEventListener('click', ()=>{ setCurrentUser(u); document.getElementById('mbpsUsersModal').close(); location.reload(); });
      actions.appendChild(switchBtn);
      if(u!=='owner'){
        const del = document.createElement('button'); del.className='btn'; del.textContent='Remove';
        del.addEventListener('click', ()=>{
          if(!isOwner()) return;
          if(confirm('Remove user '+u+'? Their S3 folder remains intact.')){
            saveUsers(users.filter(x=>x!==u)); renderUsersBody();
          }
        });
        actions.appendChild(del);
      }
      row.append(name, actions); left.appendChild(row);
    });

    const addRow = document.createElement('div'); addRow.style.marginTop='10px';
    const input = document.createElement('input'); input.placeholder='new-user-id (a-z0-9-_)'; input.pattern='[a-zA-Z0-9_-]+';
    const addBtn = document.createElement('button'); addBtn.className='btn'; addBtn.textContent='Add User';
    addBtn.addEventListener('click', ()=>{
      if(!isOwner()) return;
      const v = input.value.trim();
      if(!v) return alert('Enter a user id');
      const list = getUsers();
      if(list.includes(v)) return alert('User exists');
      list.push(v); saveUsers(list); input.value=''; renderUsersBody();
    });
    addRow.append(input, addBtn);
    left.appendChild(addRow);

    const right = document.createElement('div'); right.className='card';
    right.innerHTML = '<h4>Owner Controls</h4>';
    const pinWrap = document.createElement('div');
    pinWrap.innerHTML = '<div class="field"><label>Owner PIN (optional)</label><input type="password" id="mbpsPin" placeholder="set or change PIN"/></div>';
    const setBtn = document.createElement('button'); setBtn.className='btn'; setBtn.textContent='Save PIN';
    setBtn.addEventListener('click', ()=>{
      if(getCurrentUser()!=='owner'){ alert('Switch to owner to change PIN.'); return; }
      const pin = document.getElementById('mbpsPin').value;
      setOwnerPin(pin);
      alert(pin ? 'PIN set.' : 'PIN cleared.');
    });
    right.append(pinWrap, setBtn);

    wrap.append(left, right);
    body.appendChild(wrap);
  }

  // ======================================================================
  // RESTORE VERSIONS (List via API, or fallback by VersionId input)
  // ======================================================================
  async function listVersions(file='deals.json', max=10){
    const userId = getCurrentUser();
    const url = API_BASE + "/listVersions?userId=" + encodeURIComponent(userId) + "&file=" + encodeURIComponent(file) + "&max=" + max;
    const r = await fetch(url);
    if(!r.ok) throw new Error('listVersions not available (update stack)');
    return r.json();
  }

  async function getPresignedGetForVersion(file, versionId){
    const userId = getCurrentUser();
    const url = API_BASE + "/getUrl?userId=" + encodeURIComponent(userId) + "&file=" + encodeURIComponent(file) + "&versionId=" + encodeURIComponent(versionId);
    const r = await fetch(url);
    if(!r.ok) throw new Error('getUrl for version failed');
    const j = await r.json();
    return j.url;
  }

  async function openRestoreModal(){
    const dlg = document.getElementById('mbpsRestoreModal');
    const body = document.getElementById('mbpsRestoreBody');
    dlg.showModal();
    body.innerHTML = '<div class="muted">Fetching versionsâ€¦</div>';
    try{
      const items = await listVersions('deals.json', 15);
      if(!Array.isArray(items) || !items.length){
        body.innerHTML = '<div>No versions found.</div>';
        return;
      }
      const tbl = document.createElement('table'); tbl.style.width='100%';
      const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Date</th><th>Size</th><th>Storage</th><th>Latest</th><th>Actions</th></tr>';
      const tbody = document.createElement('tbody');
      items.forEach(v=>{
        const tr = document.createElement('tr');
        const date = new Date(v.LastModified||v.LastModifiedISO||Date.now()).toLocaleString();
        tr.innerHTML = `<td>${date}</td><td>${(v.Size||0).toLocaleString()} B</td><td>${v.StorageClass||'-'}</td><td>${v.IsLatest?'Yes':'No'}</td>`;
        const act = document.createElement('td');
        const restore = document.createElement('button'); restore.className='btn'; restore.textContent='Restore';
        restore.addEventListener('click', async ()=>{
          if(!confirm('Replace local deals with this version?')) return;
          try{
            const getUrl = await getPresignedGetForVersion('deals.json', v.VersionId);
            const res = await fetch(getUrl); const deals = await res.json();
            localStorage.setItem('mbpsDeals', JSON.stringify(deals));
            if(window.renderDealsTable) try{ window.renderDealsTable(); }catch(_){}
            alert('Restored from version ' + v.VersionId);
          }catch(e){ alert('Restore failed: '+e.message); }
        });
        const dl = document.createElement('button'); dl.className='btn'; dl.textContent='Download';
        dl.addEventListener('click', async ()=>{
          try{
            const getUrl = await getPresignedGetForVersion('deals.json', v.VersionId);
            window.open(getUrl, '_blank');
          }catch(e){ alert('Download failed: '+e.message); }
        });
        act.append(restore, dl);
        tr.appendChild(act);
        tbody.appendChild(tr);
      });
      tbl.append(thead, tbody);
      body.innerHTML = '';
      body.append(tbl);
    }catch(e){
      body.innerHTML = `<div class="danger">Version listing not available (update backend). You can still paste a VersionId to restore:</div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <input id="mbpsVid" placeholder="VersionId..." style="min-width:280px">
          <button id="mbpsVidRestore" class="btn">Restore by VersionId</button>
        </div>`;
      document.getElementById('mbpsVidRestore').addEventListener('click', async ()=>{
        const vid = document.getElementById('mbpsVid').value.trim();
        if(!vid) return;
        try{
          const getUrl = await getPresignedGetForVersion('deals.json', vid);
          const res = await fetch(getUrl); const deals = await res.json();
          localStorage.setItem('mbpsDeals', JSON.stringify(deals));
          if(window.renderDealsTable) try{ window.renderDealsTable(); }catch(_){}
          alert('Restored from version.');
        }catch(ex){ alert('Restore failed: '+ex.message); }
      });
    }
  }

  window.MBPS_USER = { getUsers, saveUsers, getCurrentUser, setCurrentUser, isOwner };
  window.MBPS_RESTORE = { openRestoreModal };

  // ======================================================================
  // GUARDED TABLE RENDERER (prevents 'undefined cls' crash)
  // ======================================================================
  (function(){
    const orig = window.renderDealsTable;
    window.renderDealsTable = function(...args){
      try{
        if(typeof orig === 'function') return orig.apply(this, args);
      }catch(e){
        console.warn('[renderDealsTable] guarded fallback:', e);
      }
      const deals = getDeals();
      const tbody = document.querySelector('#dealsTbody') || document.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML='';
      deals.forEach(d=>{
        const tr = document.createElement('tr');
        const tdAddr = document.createElement('td');
        tdAddr.innerHTML = `<div>${d.address||'-'}</div><div style="color:#6b7280">${d._id||''}</div>`;
        const mkR = (v)=>{ const td=document.createElement('td'); td.className='right'; td.textContent='$ '+fmtMoney(v); return td; };
        tr.append(
          tdAddr, mkR(d.offerPrice), mkR(d.arv), mkR(d.repairs),
          Object.assign(document.createElement('td'),{textContent: d.stage||'Lead'}),
          (function(){ const td=document.createElement('td'); const gal=document.createElement('div'); gal.setAttribute('data-gallery', d._id); td.append(gal); return td; })(),
          (function(){ const td=document.createElement('td'); const b1=document.createElement('button'); b1.className='btn'; b1.textContent='Upload Photo'; b1.onclick=()=>uploadDealPhoto(d._id);
                       const b2=document.createElement('button'); b2.className='btn'; b2.textContent='Add File'; b2.onclick=()=>pickAndUploadFile(d._id);
                       const b3=document.createElement('button'); b3.className='btn'; b3.textContent='Analyze'; b3.onclick=()=>window.mbpsOpenAnalyzerPrefill && window.mbpsOpenAnalyzerPrefill(d);
                       td.append(b1,b2,b3); return td; })()
        );
        tbody.append(tr);
        const cont = tr.querySelector(`[data-gallery="{{id}}"]`.replace('{{id}}', d._id));
        renderDealGallery(d._id, tr.querySelector(`[data-gallery="{dealId}"]`.replace('{dealId}', d._id)) || cont);
      });
    };
  })();
})();
</script>
<!-- ============================== /END v1.3 FULL PATCH ============================== -->


<!-- ===================== MBPS: Property Evaluation (Replaced) ===================== -->
<style>
  #propertyEvaluation { border-top:1px solid rgba(148,163,184,.35); padding:16px; margin-top:16px; background:#fff;border-radius:14px;}
  #propertyEvaluation h3 { margin:0 0 12px 0; }
  .pe-tabs { display:flex; gap:8px; margin:8px 0 16px 0; flex-wrap:wrap; }
  .pe-tabs .tab { padding:8px 12px; border:1px solid rgba(148,163,184,.4); border-radius:999px; cursor:pointer; }
  .pe-tabs .tab.active { background:#00a8ff; color:#fff; border-color:#00a8ff; }
  .pe-grid { display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; }
  .pe-card { border:1px solid rgba(148,163,184,.35); border-radius:12px; padding:12px; background:#fff; }
  .pe-field label { display:block; font-size:12px; color:#6b7280; margin-bottom:4px; }
  .pe-field input { width:100%; padding:8px; border:1px solid rgba(148,163,184,.5); border-radius:8px; }
  .pe-actions { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
  .btn { display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border:1px solid rgba(148,163,184,.4); border-radius:10px; background:#fff; cursor:pointer; }
  .btn.primary { background:#00a8ff; color:#fff; border-color:#00a8ff; }
  .tag { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid rgba(148,163,184,.4); }
  @media (max-width:900px){ .pe-grid { grid-template-columns:1fr; } }
</style>

<script>
(function(){
  // Remove/hide any previous Property Evaluation blocks
  document.addEventListener('DOMContentLoaded', () => {
    const old = [
      document.getElementById('property-evaluation'),
      document.querySelector('#propertyEvaluationOld'),
      document.querySelector('.property-evaluation')
    ].filter(Boolean);
    old.forEach(n => n.remove());
  });
  
  // Helpers to use or safely polyfill app storage hooks
  function getDeals(){ try{return JSON.parse(localStorage.getItem('mbpsDeals')||'[]')}catch(_){return[]} }
  function saveDeals(d){ localStorage.setItem('mbpsDeals', JSON.stringify(d)); }
  function refreshTable(){ if (window.renderDealsTable) try{ window.renderDealsTable(); }catch(_){} }
  function currentDealId(){
    return (window.CURRENT_ANALYZE_DEAL_ID) || (window.currentDealId) || null;
  }
})();
</script>

<script id="mbps-durable-showtab">
(function(){
  function safeActivate(id){
    try{
      const panels = document.querySelectorAll('[data-tab-panel], .tab-panel, section.tab-panel');
      panels.forEach(p => { 
        try{ 
          if(p) p.hidden = true;
        }catch(_){} 
      });
      const target = document.getElementById(id) || document.querySelector(`[data-tab-panel="${id}"]`) || null;
      if (!target) { 
        console.warn('[showTab] target not found:', id); 
        return; 
      }
      target.hidden = false;
      const tabs = document.querySelectorAll('[data-tab], .tab, [role="tab"]');
      tabs.forEach(btn => {
        if (!btn) return;
        const match = (btn.getAttribute('data-tab') === id) ||
                      (btn.getAttribute('href') === `#${id}`) ||
                      (btn.id && btn.id === id);
        btn.classList.toggle('active', !!match);
      });
    }catch(e){ 
      console.warn('[showTab] safeActivate error:', e); 
    }
  }
  
  window.showTab = function(id){ 
    safeActivate(id); 
  };
})();

(function(){
  // Helper functions that were missing
  function getDeals(){ 
    try{ return JSON.parse(localStorage.getItem('deals')||'[]'); }
    catch(_){ return []; }
  }
  
  function saveDeals(d){ 
    localStorage.setItem('deals', JSON.stringify(d)); 
  }
  
  function refreshTable(){ 
    if (window.renderDealsTable) {
      try{ window.renderDealsTable(); }catch(_){} 
    }
  }
  
  function currentDealId(){
    return window.CURRENT_ANALYZE_DEAL_ID || null;
  }

  // ---------- Single-family (MAO) ----------
  function analyzeSF(){
    const arv = +document.getElementById('sfArv').value||0;
    const repairs = +document.getElementById('sfRepairs').value||0;
    const fee = +document.getElementById('sfFee').value||0;
    const holdPct = (+document.getElementById('sfHoldPct').value||10)/100;
    const rent = +document.getElementById('sfRent').value||0;
    const piti = +document.getElementById('sfPiti').value||0;

    const maxOfferWholesale = Math.max(0, arv*0.7 - repairs - fee);
    const carrying = Math.round(arv * holdPct);
    const cashflow = Math.round(rent - piti);
    let strat = 'Wholesale';
    if (cashflow >= 300) strat = 'Buy & Hold';
    if (piti>0 && cashflow>0 && maxOfferWholesale<=0) strat = 'Subject-To';

    const r = document.getElementById('sfResults');
    if (r) {
      r.innerHTML = `
        <div class="pe-grid">
          <div class="pe-field"><label>Max Offer (Wholesale)</label><div class="tag">$ ${maxOfferWholesale.toLocaleString()}</div></div>
          <div class="pe-field"><label>Carrying Reserve</label><div class="tag">$ ${carrying.toLocaleString()}</div></div>
          <div class="pe-field"><label>Cashflow (rent - PITI)</label><div class="tag">$ ${cashflow.toLocaleString()}</div></div>
        </div>
        <div style="margin-top:8px"><strong>Suggested Strategy:</strong> ${strat}</div>`;
    }

    const sfSetOfferBtn = document.getElementById('sfSetOffer');
    if (sfSetOfferBtn) sfSetOfferBtn.disabled = false;
    
    return { maxOfferWholesale, carrying, cashflow, strat };
  }

  // ---------- Multifamily ----------
  function pmt(rate, nper, pv){
    const i = rate/12;
    return (pv*i) / (1 - Math.pow(1+i, -nper));
  }
  
  function analyzeMF(){
    const units = +document.getElementById('mfUnits').value||0;
    const rentU = +document.getElementById('mfRent').value||0;
    const other = +document.getElementById('mfOther').value||0;
    const vac = (+document.getElementById('mfVacancy').value||5)/100;
    const opexPct = (+document.getElementById('mfOpexPct').value||40)/100;
    const price = +document.getElementById('mfPrice').value||0;
    const downPct = (+document.getElementById('mfDownPct').value||25)/100;
    const rate = (+document.getElementById('mfRate').value||6.5)/100;
    const amort = +document.getElementById('mfAmort').value||25;

    const grossSched = units * rentU * 12 + other*12;
    const egi = grossSched * (1 - vac);
    const opex = egi * opexPct;
    const noi = egi - opex;

    const loanAmt = price * (1 - downPct);
    const annualDebt = pmt(rate, amort*12, loanAmt) * 12;
    const dscr = (annualDebt>0)? (noi / annualDebt): 0;
    const capRate = (price>0)? (noi / price) : 0;
    const cashNeeded = price * downPct;
    const cashFlow = noi - annualDebt;
    const coc = (cashNeeded>0)? (cashFlow / cashNeeded) : 0;

    const r = document.getElementById('mfResults');
    if (r) {
      r.innerHTML = `
        <div class="pe-grid">
          <div class="pe-field"><label>NOI</label><div class="tag">$ ${(Math.round(noi)).toLocaleString()}</div></div>
          <div class="pe-field"><label>Cap Rate</label><div class="tag">${(capRate*100).toFixed(2)}%</div></div>
          <div class="pe-field"><label>DSCR</label><div class="tag">${dscr.toFixed(2)}</div></div>
          <div class="pe-field"><label>Annual Debt Service</label><div class="tag">$ ${(Math.round(annualDebt)).toLocaleString()}</div></div>
          <div class="pe-field"><label>Annual Cash Flow</label><div class="tag">$ ${(Math.round(cashFlow)).toLocaleString()}</div></div>
          <div class="pe-field"><label>Cash-on-Cash</label><div class="tag">${(coc*100).toFixed(1)}%</div></div>
        </div>
        <div style="margin-top:8px" class="tag">${dscr>=1.25?'âœ… DSCR lender-safe (â‰¥1.25)':'âš ï¸ DSCR below 1.25 â€” risk for lenders'}</div>`;
    }

    const mfSaveBtn = document.getElementById('mfSave');
    if (mfSaveBtn) mfSaveBtn.disabled = false;
    
    return { noi, capRate, dscr, annualDebt, cashFlow, coc };
  }

  // ---------- Airbnb Arbitrage ----------
  function analyzeAB(){
    const rent = +document.getElementById('abRent').value||0;
    const adr = +document.getElementById('abAdr').value||0;
    const occ = (+document.getElementById('abOcc').value||70)/100;
    const utils = +document.getElementById('abUtils').value||0;
    const clean = +document.getElementById('abClean').value||0;
    const nightsPerStay = +document.getElementById('abNightsPerStay').value||3;
    const feePct = (+document.getElementById('abFeePct').value||3)/100;
    const furnish = +document.getElementById('abFurnish').value||0;
    const other = +document.getElementById('abOther').value||0;

    const nights = 30 * occ;
    const stays = nightsPerStay>0 ? (nights / nightsPerStay) : 0;
    const revenue = adr * nights;
    const platformFees = revenue * feePct;
    const cleaning = stays * clean;
    const expenses = rent + utils + platformFees + cleaning + other;
    const profit = revenue - expenses;
    const roi = furnish>0 ? ((profit*12)/furnish) : 0;
    const breakEvenNights = adr>0 ? ((rent + utils + platformFees + other)/adr) : 0;

    const r = document.getElementById('abResults');
    if (r) {
      r.innerHTML = `
        <div class="pe-grid">
          <div class="pe-field"><label>Monthly Revenue</label><div class="tag">$ ${(Math.round(revenue)).toLocaleString()}</div></div>
          <div class="pe-field"><label>Monthly Expenses</label><div class="tag">$ ${(Math.round(expenses)).toLocaleString()}</div></div>
          <div class="pe-field"><label>Monthly Profit</label><div class="tag">$ ${(Math.round(profit)).toLocaleString()}</div></div>
          <div class="pe-field"><label>Break-even Nights</label><div class="tag">${breakEvenNights.toFixed(1)}</div></div>
          <div class="pe-field"><label>Annualized ROI (on furnishings)</label><div class="tag">${(roi*100).toFixed(1)}%</div></div>
        </div>
        <div style="margin-top:8px" class="tag">${breakEvenNights<=15?'âœ… Break-even â‰¤ 15 nights':'âš ï¸ Break-even high â€” consider different ADR/market'}</div>`;
    }

    const abSaveBtn = document.getElementById('abSave');
    if (abSaveBtn) abSaveBtn.disabled = false;
    
    return { revenue, expenses, profit, breakEvenNights, roi };
  }

  // Wire up event listeners after DOM loads
  document.addEventListener('DOMContentLoaded', () => {
    // Single Family
    const sfAnalyzeBtn = document.getElementById('sfAnalyze');
    if (sfAnalyzeBtn) {
      sfAnalyzeBtn.addEventListener('click', analyzeSF);
    }
    
    const sfSetOfferBtn = document.getElementById('sfSetOffer');
    if (sfSetOfferBtn) {
      sfSetOfferBtn.addEventListener('click', () => {
        const out = analyzeSF();
        const dealId = currentDealId();
        const addr = (document.getElementById('peAddress')?.value||'').trim();
        if (!dealId) { alert('Open a deal via Analyze, or select a deal first.'); return; }
        const deals = getDeals();
        const d = deals.find(x => x && x._id === dealId);
        if (!d) { alert('Deal not found.'); return; }
        d.offerPrice = Math.round(out.maxOfferWholesale);
        if (addr) d.address = d.propertyAddress = addr;
        d.updatedAt = Date.now();
        saveDeals(deals);
        refreshTable();
        alert('Offer price set on deal.');
      });
    }

    // Multifamily
    const mfAnalyzeBtn = document.getElementById('mfAnalyze');
    if (mfAnalyzeBtn) {
      mfAnalyzeBtn.addEventListener('click', analyzeMF);
    }
    
    const mfSaveBtn = document.getElementById('mfSave');
    if (mfSaveBtn) {
      mfSaveBtn.addEventListener('click', () => {
        const out = analyzeMF();
        const dealId = currentDealId();
        const addr = (document.getElementById('peAddress')?.value||'').trim();
        if (!dealId) { alert('Open a deal via Analyze, or select a deal first.'); return; }
        const deals = getDeals();
        const d = deals.find(x => x && x._id === dealId);
        if (!d) { alert('Deal not found.'); return; }
        d.multi = { ...out };
        if (addr) d.address = d.propertyAddress = addr;
        d.strategy = 'Multifamily';
        d.updatedAt = Date.now();
        saveDeals(deals);
        refreshTable();
        alert('Multifamily analysis saved to deal.');
      });
    }

    // Airbnb
    const abAnalyzeBtn = document.getElementById('abAnalyze');
    if (abAnalyzeBtn) {
      abAnalyzeBtn.addEventListener('click', analyzeAB);
    }
    
    const abSaveBtn = document.getElementById('abSave');
    if (abSaveBtn) {
      abSaveBtn.addEventListener('click', () => {
        const out = analyzeAB();
        const dealId = currentDealId();
        const addr = (document.getElementById('peAddress')?.value||'').trim();
        if (!dealId) { alert('Open a deal via Analyze, or select a deal first.'); return; }
        const deals = getDeals();
        const d = deals.find(x => x && x._id === dealId);
        if (!d) { alert('Deal not found.'); return; }
        d.arbitrage = { ...out };
        if (addr) d.address = d.propertyAddress = addr;
        d.strategy = 'Airbnb Arbitrage';
        d.updatedAt = Date.now();
        saveDeals(deals);
        refreshTable();
        alert('Airbnb arbitrage analysis saved to deal.');
      });
    }
  });

  // Make functions globally available
  window.analyzeSF = analyzeSF;
  window.analyzeMF = analyzeMF;
  window.analyzeAB = analyzeAB;
})();
</script>
<!-- =================== /MBPS: Property Evaluation (Replaced) =================== -->


<style>
  /* Collapse Property Evaluation by default */
  #propertyEvaluation { display:none; }
  #propertyEvaluation.open { display:block; animation: fadeIn 0.3s ease-in-out; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
</style>

<script>
(function(){
  document.addEventListener('DOMContentLoaded', () => {
    // Try to find a top control bar; fall back to body if none.
    const controlBar = document.querySelector('.toolbar, #controls, .top-controls, .actions-bar') || document.body;

    // Add the toggle button once
    if(controlBar && !document.getElementById('togglePEBtn')){
      const btn = document.createElement('button');
      btn.id = 'togglePEBtn';
      btn.className = 'btn';
      btn.style.marginLeft = '8px';
      btn.textContent = 'Property Evaluation';
      controlBar.appendChild(btn);
    }

    const pe = document.getElementById('propertyEvaluation');
    const toggle = document.getElementById('togglePEBtn');

    if(toggle && pe){
      toggle.addEventListener('click', () => {
        pe.classList.toggle('open');
        if(pe.classList.contains('open')){
          pe.scrollIntoView({behavior:'smooth', block:'start'});
        }
      });
    }

    // Optional: hide Property Evaluation when switching other app tabs
    document.querySelectorAll('[data-tab]').forEach(tab => {
      tab.addEventListener('click', () => {
        if(pe) pe.classList.remove('open');
      });
    });
  });
})();
</script>


<!-- ===== Property Evaluation Modal (Expanded) ===== -->
<style>
  #propertyEvalModal { border:0; border-radius:18px; padding:0; width:min(980px,96vw); }
  #propertyEvalModal .hd { padding:12px 16px; border-bottom:1px solid rgba(148,163,184,.25); display:flex; align-items:center; justify-content:space-between; }
  #propertyEvalModal .bd { padding:14px; max-height:72vh; overflow:auto; }
  .pe-tabs { display:flex; gap:8px; margin:8px 0 16px 0; flex-wrap:wrap; }
  .pe-tabs .tab { padding:8px 12px; border:1px solid rgba(148,163,184,.4); border-radius:999px; cursor:pointer; background:#fff; }
  .pe-tabs .tab.active { background:#00a8ff; color:#fff; border-color:#00a8ff; }
  .pe-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
  .pe-card { border:1px solid rgba(148,163,184,.35); border-radius:12px; padding:12px; background:#fff; }
  .pe-field label { display:block; font-size:12px; color:#6b7280; margin-bottom:4px; }
  .pe-field input { width:100%; padding:8px; border:1px solid rgba(148,163,184,.5); border-radius:8px; }
  .pe-actions { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
  .btn { display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border:1px solid rgba(148,163,184,.4); border-radius:10px; background:#fff; cursor:pointer; }
  .btn.primary { background:#00a8ff; color:#fff; border-color:#00a8ff; }
  .tag { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid rgba(148,163,184,.4); }
  @media (max-width:900px){ .pe-grid { grid-template-columns:1fr; } }
</style>

<dialog id="propertyEvalModal">
  <div class="hd">
    <strong>Property Evaluation</strong>
    <div style="display:flex; gap:8px;">
      <button id="peClose" class="btn">Close</button>
    </div>
  </div>
  <div class="bd">
    <div class="pe-field" style="margin-bottom:12px;">
      <label>Property Address</label>
      <input id="peAddress" type="text" placeholder="123 Main St, City, ST 00000" />
    </div>

    <div class="pe-tabs" role="tablist">
      <button class="tab active" data-tab="single" role="tab" aria-selected="true">Single-Family</button>
      <button class="tab" data-tab="multi" role="tab" aria-selected="false">Apartments (Multifamily)</button>
      <button class="tab" data-tab="airbnb" role="tab" aria-selected="false">Airbnb Arbitrage</button>
    </div>

    <div class="pe-pane" id="pe-single">
      <div class="pe-grid">
        <div class="pe-field"><label>ARV</label><input id="sfArv" type="number" placeholder="220000"></div>
        <div class="pe-field"><label>Repairs</label><input id="sfRepairs" type="number" placeholder="35000"></div>
        <div class="pe-field"><label>Assignment / Margin</label><input id="sfFee" type="number" placeholder="10000" value="10000"></div>
        <div class="pe-field"><label>Holding %</label><input id="sfHoldPct" type="number" placeholder="10" value="10"></div>
        <div class="pe-field"><label>Rent (if BRRR/hold)</label><input id="sfRent" type="number" placeholder="1800"></div>
        <div class="pe-field"><label>PITI (if Sub2)</label><input id="sfPiti" type="number" placeholder="1350"></div>
      </div>
      <div class="pe-actions">
        <button id="sfAnalyze" class="btn">Analyze</button>
        <button id="sfSetOffer" class="btn primary" disabled>Set Offer Price</button>
      </div>
      <div id="sfResults" class="pe-card" style="margin-top:10px;color:#64748b">Enter inputs and Analyze.</div>
    </div>

    <div class="pe-pane" id="pe-multi" hidden>
      <div class="pe-grid">
        <div class="pe-field"><label>Units</label><input id="mfUnits" type="number" placeholder="12"></div>
        <div class="pe-field"><label>Avg Rent / Unit</label><input id="mfRent" type="number" placeholder="1200"></div>
        <div class="pe-field"><label>Other Income (mo)</label><input id="mfOther" type="number" placeholder="0"></div>
        <div class="pe-field"><label>Vacancy %</label><input id="mfVacancy" type="number" placeholder="5" value="5"></div>
        <div class="pe-field"><label>OpEx % of EGI</label><input id="mfOpexPct" type="number" placeholder="40" value="40"></div>
        <div class="pe-field"><label>Purchase Price</label><input id="mfPrice" type="number" placeholder="1500000"></div>
        <div class="pe-field"><label>Down Payment %</label><input id="mfDownPct" type="number" placeholder="25" value="25"></div>
        <div class="pe-field"><label>Interest %</label><input id="mfRate" type="number" step="0.01" placeholder="6.5" value="6.5"></div>
        <div class="pe-field"><label>Amortization (yrs)</label><input id="mfAmort" type="number" placeholder="25" value="25"></div>
      </div>
      <div class="pe-actions">
        <button id="mfAnalyze" class="btn">Analyze</button>
        <button id="mfSave" class="btn primary" disabled>Save to Deal</button>
      </div>
      <div id="mfResults" class="pe-card" style="margin-top:10px;color:#64748b">Enter inputs and Analyze.</div>
    </div>

    <div class="pe-pane" id="pe-airbnb" hidden>
      <div class="pe-grid">
        <div class="pe-field"><label>Monthly Rent</label><input id="abRent" type="number" placeholder="2000"></div>
        <div class="pe-field"><label>Average Daily Rate (ADR)</label><input id="abAdr" type="number" placeholder="175"></div>
        <div class="pe-field"><label>Occupancy %</label><input id="abOcc" type="number" placeholder="70" value="70"></div>
        <div class="pe-field"><label>Monthly Utilities</label><input id="abUtils" type="number" placeholder="250"></div>
        <div class="pe-field"><label>Cleaning / Turnover per Stay</label><input id="abClean" type="number" placeholder="50"></div>
        <div class="pe-field"><label>Avg Nights per Stay</label><input id="abNightsPerStay" type="number" placeholder="3" value="3"></div>
        <div class="pe-field"><label>Airbnb Fee %</label><input id="abFeePct" type="number" placeholder="3" value="3"></div>
        <div class="pe-field"><label>Furnishing (one-time)</label><input id="abFurnish" type="number" placeholder="5000"></div>
        <div class="pe-field"><label>Other Monthly Costs</label><input id="abOther" type="number" placeholder="0"></div>
      </div>
      <div class="pe-actions">
        <button id="abAnalyze" class="btn">Analyze</button>
        <button id="abSave" class="btn primary" disabled>Save to Deal</button>
      </div>
      <div id="abResults" class="pe-card" style="margin-top:10px;color:#64748b">Enter inputs and Analyze.</div>
    </div>
  </div>
</dialog>

<script>
(function(){
  // Wire existing blue Property Evaluation button (id=evalBtn) to open modal.
  // If not present, create it next to Analyze Deal.
  document.addEventListener('DOMContentLoaded', () => {
    const toolbar = document.querySelector('.toolbar') || document.body;

    // Remove old toggle button if our prior patch added it
    const oldToggle = document.getElementById('togglePEBtn');
    if (oldToggle) oldToggle.remove();

    let evalBtn = document.getElementById('evalBtn');
    if (!evalBtn) {
      // Try to place it visually near Analyze Deal
      evalBtn = document.createElement('button');
      evalBtn.id = 'evalBtn';
      evalBtn.className = 'btn primary';
      evalBtn.textContent = 'Property Evaluation';
      toolbar.appendChild(evalBtn);
    }
    evalBtn.addEventListener('click', () => {
      document.getElementById('propertyEvalModal').showModal();
    });

    document.getElementById('peClose').addEventListener('click', () => {
      document.getElementById('propertyEvalModal').close();
    });
  });

  function getDeals(){ try{return JSON.parse(localStorage.getItem('mbpsDeals')||'[]')}catch(_){return[]} }
  function saveDeals(d){ localStorage.setItem('mbpsDeals', JSON.stringify(d)); }
  function refreshTable(){ if (window.renderDealsTable) try{ window.renderDealsTable(); }catch(_){} }
  function currentDealId(){ return (window.CURRENT_ANALYZE_DEAL_ID) || (window.currentDealId) || null; }

  // Tabs
  function showTab(name){
    document.querySelectorAll('#propertyEvalModal .pe-pane').forEach(p=>p.hidden=true);
    const active = document.getElementById('pe-'+name); if(active) active.hidden=false;
    document.querySelectorAll('#propertyEvalModal .pe-tabs .tab').forEach(b=>{
      b.classList.toggle('active', b.dataset.tab===name);
      b.setAttribute('aria-selected', b.dataset.tab===name ? 'true' : 'false');
    });
  }
  document.addEventListener('click', (e)=>{
    const tab = e.target.closest('#propertyEvalModal .pe-tabs .tab');
    if(!tab) return;
    showTab(tab.dataset.tab);
  });
  document.addEventListener('DOMContentLoaded', ()=> showTab('single'));

  // Single-family analyzer
  function analyzeSF(){
    const arv = +document.getElementById('sfArv').value||0;
    const repairs = +document.getElementById('sfRepairs').value||0;
    const fee = +document.getElementById('sfFee').value||0;
    const holdPct = (+document.getElementById('sfHoldPct').value||10)/100;
    const rent = +document.getElementById('sfRent').value||0;
    const piti = +document.getElementById('sfPiti').value||0;

    const maxOfferWholesale = Math.max(0, arv*0.7 - repairs - fee);
    const carrying = Math.round(arv * holdPct);
    const cashflow = Math.round(rent - piti);
    let strat = 'Wholesale';
    if (cashflow >= 300) strat = 'Buy & Hold';
    if (piti>0 && cashflow>0 && maxOfferWholesale<=0) strat = 'Subject-To';

    const r = document.getElementById('sfResults');
    r.innerHTML = `
      <div class="pe-grid">
        <div class="pe-field"><label>Max Offer (Wholesale)</label><div class="tag">$ ${(Math.round(maxOfferWholesale)).toLocaleString()}</div></div>
        <div class="pe-field"><label>Carrying Reserve</label><div class="tag">$ ${(Math.round(carrying)).toLocaleString()}</div></div>
        <div class="pe-field"><label>Cashflow (rent - PITI)</label><div class="tag">$ ${(Math.round(cashflow)).toLocaleString()}</div></div>
      </div>
      <div style="margin-top:8px"><strong>Suggested Strategy:</strong> ${strat}</div>`;

    document.getElementById('sfSetOffer').disabled = false;
    return { maxOfferWholesale, carrying, cashflow, strat };
  }
  document.addEventListener('click', (e)=>{
    if(e.target.id==='sfAnalyze') analyzeSF();
    if(e.target.id==='sfSetOffer'){
      const out = analyzeSF();
      const dealId = currentDealId();
      const addr = (document.getElementById('peAddress').value||'').trim();
      if (!dealId) { alert('Open a deal via Analyze, or select a deal first.'); return; }
      const deals = getDeals();
      const d = deals.find(x=>x && x._id===dealId);
      if (!d) { alert('Deal not found.'); return; }
      d.offerPrice = Math.round(out.maxOfferWholesale);
      if (addr) d.address = d.propertyAddress = addr;
      d.updatedAt = Date.now();
      saveDeals(deals);
      refreshTable();
      alert('Offer price set on deal.');
    }
  });

  // Multifamily analyzer
  function pmt(rate, nper, pv){ const i = rate/12; return (pv*i) / (1 - Math.pow(1+i, -nper)); }
  function analyzeMF(){
    const units = +document.getElementById('mfUnits').value||0;
    const rentU = +document.getElementById('mfRent').value||0;
    const other = +document.getElementById('mfOther').value||0;
    const vac = (+document.getElementById('mfVacancy').value||5)/100;
    const opexPct = (+document.getElementById('mfOpexPct').value||40)/100;
    const price = +document.getElementById('mfPrice').value||0;
    const downPct = (+document.getElementById('mfDownPct').value||25)/100;
    const rate = (+document.getElementById('mfRate').value||6.5)/100;
    const amort = +document.getElementById('mfAmort').value||25;

    const grossSched = units * rentU * 12 + other*12;
    const egi = grossSched * (1 - vac);
    const opex = egi * opexPct;
    const noi = egi - opex;

    const loanAmt = price * (1 - downPct);
    const annualDebt = pmt(rate, amort*12, loanAmt) * 12;
    const dscr = (annualDebt>0)? (noi / annualDebt): 0;
    const capRate = (price>0)? (noi / price) : 0;
    const cashNeeded = price * downPct;
    const cashFlow = noi - annualDebt;
    const coc = (cashNeeded>0)? (cashFlow / cashNeeded) : 0;

    const r = document.getElementById('mfResults');
    r.innerHTML = `
      <div class="pe-grid">
        <div class="pe-field"><label>NOI</label><div class="tag">$ ${(Math.round(noi)).toLocaleString()}</div></div>
        <div class="pe-field"><label>Cap Rate</label><div class="tag">${(capRate*100).toFixed(2)}%</div></div>
        <div class="pe-field"><label>DSCR</label><div class="tag">${dscr.toFixed(2)}</div></div>
        <div class="pe-field"><label>Annual Debt Service</label><div class="tag">$ ${(Math.round(annualDebt)).toLocaleString()}</div></div>
        <div class="pe-field"><label>Annual Cash Flow</label><div class="tag">$ ${(Math.round(cashFlow)).toLocaleString()}</div></div>
        <div class="pe-field"><label>Cash-on-Cash</label><div class="tag">${(coc*100).toFixed(1)}%</div></div>
      </div>
      <div style="margin-top:8px" class="tag">${dscr>=1.25?'âœ… DSCR lender-safe (â‰¥1.25)':'âš ï¸ DSCR below 1.25 â€” risk for lenders'}</div>`;

    document.getElementById('mfSave').disabled = false;
    return { noi, capRate, dscr, annualDebt, cashFlow, coc };
  }
  document.addEventListener('click', (e)=>{
    if(e.target.id==='mfAnalyze') analyzeMF();
    if(e.target.id==='mfSave'){
      const out = analyzeMF();
      const dealId = currentDealId();
      const addr = (document.getElementById('peAddress').value||'').trim();
      if (!dealId) { alert('Open a deal via Analyze, or select a deal first.'); return; }
      const deals = getDeals();
      const d = deals.find(x=>x && x._id===dealId);
      if (!d) { alert('Deal not found.'); return; }
      d.multi = { ...out };
      if (addr) d.address = d.propertyAddress = addr;
      d.strategy = 'Multifamily';
      d.updatedAt = Date.now();
      saveDeals(deals);
      refreshTable();
      alert('Multifamily analysis saved to deal.');
    }
  });

  // Airbnb arbitrage analyzer
  function analyzeAB(){
    const rent = +document.getElementById('abRent').value||0;
    const adr = +document.getElementById('abAdr').value||0;
    const occ = (+document.getElementById('abOcc').value||70)/100;
    const utils = +document.getElementById('abUtils').value||0;
    const clean = +document.getElementById('abClean').value||0;
    const nightsPerStay = +document.getElementById('abNightsPerStay').value||3;
    const feePct = (+document.getElementById('abFeePct').value||3)/100;
    const furnish = +document.getElementById('abFurnish').value||0;
    const other = +document.getElementById('abOther').value||0;

    const nights = 30 * occ;
    const stays = nightsPerStay>0 ? (nights / nightsPerStay) : 0;
    const revenue = adr * nights;
    const platformFees = revenue * feePct;
    const cleaning = stays * clean;
    const expenses = rent + utils + platformFees + cleaning + other;
    const profit = revenue - expenses;
    const roi = furnish>0 ? ((profit*12)/furnish) : 0;
    const breakEvenNights = adr>0 ? ((rent + utils + platformFees + other)/adr) : 0;

    const r = document.getElementById('abResults');
    r.innerHTML = `
      <div class="pe-grid">
        <div class="pe-field"><label>Monthly Revenue</label><div class="tag">$ ${(Math.round(revenue)).toLocaleString()}</div></div>
        <div class="pe-field"><label>Monthly Expenses</label><div class="tag">$ ${(Math.round(expenses)).toLocaleString()}</div></div>
        <div class="pe-field"><label>Monthly Profit</label><div class="tag">$ ${(Math.round(profit)).toLocaleString()}</div></div>
        <div class="pe-field"><label>Break-even Nights</label><div class="tag">${breakEvenNights.toFixed(1)}</div></div>
        <div class="pe-field"><label>Annualized ROI (on furnishings)</label><div class="tag">${(roi*100).toFixed(1)}%</div></div>
      </div>
      <div style="margin-top:8px" class="tag">${breakEvenNights<=15?'âœ… Break-even â‰¤ 15 nights':'âš ï¸ Break-even high â€” consider different ADR/market'}</div>`;

    document.getElementById('abSave').disabled = false;
    return { revenue, expenses, profit, breakEvenNights, roi };
  }
  document.addEventListener('click', (e)=>{
    if(e.target.id==='abAnalyze') analyzeAB();
    if(e.target.id==='abSave'){
      const out = analyzeAB();
      const dealId = currentDealId();
      const addr = (document.getElementById('peAddress').value||'').trim();
      if (!dealId) { alert('Open a deal via Analyze, or select a deal first.'); return; }
      const deals = getDeals();
      const d = deals.find(x=>x && x._id===dealId);
      if (!d) { alert('Deal not found.'); return; }
      d.arbitrage = { ...out };
      if (addr) d.address = d.propertyAddress = addr;
      d.strategy = 'Airbnb Arbitrage';
      d.updatedAt = Date.now();
      saveDeals(deals);
      refreshTable();
      alert('Airbnb arbitrage analysis saved to deal.');
    }
  });
})();
</script>
<script>
/* ========= MBPS Sync + Kanban (S3 + DnD) ========= */
(function(){
  const API_BASE = "https://pocy3byloc.execute-api.us-east-1.amazonaws.com/prod";
  let USER_ID = (localStorage.getItem('mbpsUserId') || 'owner').trim() || 'owner';

  function emptyState(){
    return { deals: [], agents: [], buyers: [], properties: [], contracts: [], meta: { updatedAt: Date.now() } };
  }
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const money = (n) => (isFinite(n)? Math.round(n) : 0).toLocaleString();
  const debounce = (fn, wait=600) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); } };
  function toast(msg, ok=true){ try{ console[ok?'log':'warn'](msg);}catch(_){} }

  const STAGES = ["New Lead","Warm","Hot","Offer Sent","Under Contract","Assigning","Closed / Dead"];
  const FILE_NAME = "deals.json";

  window.setUserId = function(newId){
    const USER_ID = (newId||'').trim() || 'owner';
    localStorage.setItem('mbpsUserId', USER_ID);
    localStorage.setItem('mbpsCurrentUser', USER_ID);
    
    if (typeof renderKanban === 'function') {
        renderKanban();
    }
    location.reload();
  };

  function renderKanban() {
    const board = document.getElementById('kanbanBoard') || document.querySelector('.kanban');
    if (!board) return;
    
    const deals = JSON.parse(localStorage.getItem('deals') || '[]');
    
    board.innerHTML = STAGES.map(s => `
      <div class="kb-col" data-stage="${s}">
        <div class="kb-hd"><span>${s}</span><span class="kb-count">${deals.filter(d=> (d.stage||'New Lead')===s).length}</span></div>
        <div class="kb-list" data-drop="${s}"></div>
      </div>
    `).join("");

    STAGES.forEach(stage => {
      const list = board.querySelector(`.kb-list[data-drop="${stage}"]`);
      if (!list) return;
      
      deals.filter(d=> (d.stage||'New Lead')===stage).forEach(d => {
        const card = document.createElement('div');
        card.className = 'kb-card';
        card.draggable = true;
        card.dataset.id = d._id;
        const badges = [];
        if (d.offerPrice) badges.push(`<span class="kb-badge">$${isFinite(d.offerPrice)? Math.round(d.offerPrice).toLocaleString() : d.offerPrice}</span>`);
        if (d.arv) badges.push(`<span class="kb-badge">ARV $${isFinite(d.arv)? Math.round(d.arv).toLocaleString() : d.arv}</span>`);
        if (d.multi?.dscr) badges.push(`<span class="kb-badge">DSCR ${Number(d.multi.dscr).toFixed(2)}</span>`);
        if (d.arbitrage?.profit) badges.push(`<span class="kb-badge">Profit $${isFinite(d.arbitrage.profit)? Math.round(d.arbitrage.profit).toLocaleString() : d.arbitrage.profit}</span>`);
        const nextDt = d.nextActionDate ? new Date(d.nextActionDate).toLocaleDateString() : '';
        card.innerHTML = `
          <div class="kb-title"><div class="kb-pri">${d.title || d.address || d.propertyAddress || 'Untitled'}</div><div class="kb-next">${nextDt}</div></div>
          <div class="kb-addr">${d.address || d.propertyAddress || ''}</div>
          <div class="kb-meta">${badges.join(' ')}</div>
          <div class="kb-actions">
            <button class="btn kb-call" data-id="${d._id}">Call</button>
            <button class="btn kb-sms" data-id="${d._id}">Text</button>
            <button class="btn kb-nextaction" data-id="${d._id}">${d.nextAction || 'Next Action'}</button>
          </div>
          <div class="kb-gloss"><strong>Helper:</strong> ARV=After Repair Value Â· MAO=Max Allowable Offer Â· NOI=Net Operating Income Â· Cap=Cap Rate Â· DSCR=Debt Service Coverage Ratio Â· CoC=Cash-on-Cash Return Â· ADR=Avg Daily Rate Â· PITI=Principal+Interest+Taxes+Insurance Â· EGI=Effective Gross Income Â· LTV=Loan-to-Value.</div>
        `;
        card.addEventListener('dragstart', e => { card.classList.add('dragging'); e.dataTransfer.setData('text/plain', d._id); });
        card.addEventListener('dragend', ()=> card.classList.remove('dragging'));
        list.appendChild(card);
      });
    });

    // THIS SECTION WAS OUTSIDE THE FUNCTION - IT NEEDS TO BE INSIDE
    board.querySelectorAll('.kb-list').forEach(zone => {
      zone.addEventListener('dragover', e => { e.preventDefault(); zone.style.background='#f8fafc'; });
      zone.addEventListener('dragleave', () => { zone.style.background=''; });
      zone.addEventListener('drop', e => {
        e.preventDefault(); zone.style.background='';
        const id = e.dataTransfer.getData('text/plain');
        const stage = zone.getAttribute('data-drop');
        const deals = JSON.parse(localStorage.getItem('deals') || '[]');
        const idx = deals.findIndex(x => x && x._id === id);
        if (idx >= 0){
          deals[idx].stage = stage;
          deals[idx].updatedAt = Date.now();
          localStorage.setItem('deals', JSON.stringify(deals));
          if (window.renderDealsTable) { try{ window.renderDealsTable(); }catch(_){ } }
        }
      });
    });

    board.querySelectorAll('.kb-call').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.dataset.id;
        const deals = JSON.parse(localStorage.getItem('deals') || '[]');
        const d = deals.find(x => x && x._id===id);
        if (d && d.phone) location.href = `tel:${d.phone}`; else alert('No phone on this deal.');
      });
    });
    
    board.querySelectorAll('.kb-sms').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.dataset.id;
        const deals = JSON.parse(localStorage.getItem('deals') || '[]');
        const d = deals.find(x => x && x._id===id);
        if (d && d.phone) location.href = `sms:${d.phone}`; else alert('No phone on this deal.');
      });
    });
    
    board.querySelectorAll('.kb-nextaction').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.dataset.id;
        const deals = JSON.parse(localStorage.getItem('deals') || '[]');
        const d = deals.find(x => x && x._id===id);
        if (!d) return;
        const action = prompt('Next Action (e.g., Call, Send Offer, Follow-up):', d.nextAction || '');
        if (action===null) return;
        const when = prompt('Next Action Date (YYYY-MM-DD):', d.nextActionDate ? new Date(d.nextActionDate).toISOString().slice(0,10) : '');
        d.nextAction = (action||'').trim();
        if (when) d.nextActionDate = new Date(when).getTime();
        d.updatedAt = Date.now();
        localStorage.setItem('deals', JSON.stringify(deals));
      });
    });
  } // THIS IS WHERE renderKanban SHOULD CLOSE

  document.addEventListener('DOMContentLoaded', async ()=>{
    if (typeof S3Sync !== 'undefined') {
      S3Sync.init();
    }
    
    if (typeof renderDashboard === 'function') {
      renderDashboard();
    }
    
    if (typeof renderKanban === 'function') {
      renderKanban();
    }
    
    setTimeout(() => {
      const dashboardTab = document.querySelector('[data-tab="dashboard"]');
      if (dashboardTab) dashboardTab.click();
    }, 100);
  });
})();
</script>
 <script> 
(function(){
  document.addEventListener('DOMContentLoaded', () => {
    // 1) Safe showTab wrapper (prevents null .hidden errors)
    try {
      const prevShowTab = window.showTab;
      window.showTab = function(id){
        try {
          const panels = document.querySelectorAll('[data-tab-panel], .tab-panel, section.tab-panel');
          panels.forEach(p => { if (p) p.hidden = true; });
          const target = document.getElementById(id) || document.querySelector(`[data-tab-panel="${id}"]`) || document.querySelector(id);
          if (!target) { console.warn('[showTab] target not found:', id); return; }
          target.hidden = false;
          const tabs = document.querySelectorAll('[data-tab], .tab');
          tabs.forEach(btn => {
            const matches = (btn.getAttribute('data-tab') === id) || (btn.getAttribute('href') === `#${id}`);
            btn.classList.toggle('active', !!matches);
          });
        } catch (e) {
          console.warn('[showTab] guarded fallback:', e);
        }
      };
    } catch(_) {}

    // 2) Property Evaluation double-close fix + modal focus (one-at-a-time)
    try {
      const peModal = document.getElementById('peModal') || document.getElementById('propertyEvalModal');
      const evalBtn = document.getElementById('evalBtn') || document.querySelector("button#evalBtn, .btn.eval, button[aria-controls='property-evaluation']");
      function closeOthersExcept(dialog){
        document.querySelectorAll('dialog[open]').forEach(d => { if (d !== dialog) { try { d.close(); } catch(_){} } });
      }
      if (peModal && typeof peModal.showModal === 'function' && !peModal.dataset._wrapped) {
        const _show = peModal.showModal.bind(peModal);
        peModal.showModal = function(){
          closeOthersExcept(peModal);
          return _show();
        };
        peModal.dataset._wrapped = '1';
      }
      if (evalBtn && peModal) {
        evalBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopImmediatePropagation();
          e.stopPropagation();
          closeOthersExcept(peModal);
          peModal.showModal();
        }, true);
      }
      const peClose = document.getElementById('peClose') || document.querySelector("#peModal .btn.close, #propertyEvalModal .btn.close");
      if (peClose && peModal){
        peClose.addEventListener('click', (e)=>{ e.preventDefault(); try{ peModal.close(); }catch(_){} });
      }
    } catch(_) {}

    // 3) Fix blank "Extended Pipeline" tab label or orphan tabs
    try {
      const candidates = [
        "[data-tab='extended']",
        "#extendedTab",
        "button[aria-controls='extended-pipeline']",
        "a[href='#extended-pipeline']",
        "a[href='#extendedPipeline']"
      ];
      for (const sel of candidates) {
        const el = document.querySelector(sel);
        if (el && !(el.textContent||'').trim()) el.textContent = "Extended Pipeline";
      }
      // remove ghost tabs pointing to nowhere
      document.querySelectorAll('.tab, [role="tab"]').forEach(t => {
        const href = t.getAttribute('href');
        const targetId = href && href.startsWith('#') ? href.slice(1) : (t.getAttribute('data-tab') || "");
        if (href && href.startsWith('#') && targetId && !document.getElementById(targetId)) {
          // If it points to no panel and has no text, hide it
          if (!(t.textContent||'').trim()) t.style.display = 'none';
        }
      });
    } catch(_) {}

    // 4) Harden renderDealsTable (cls/tHead guards)
    try {
      if (window.renderDealsTable) {
        const orig = window.renderDealsTable;
        window.renderDealsTable = function(){
          try {
            const tbl = document.getElementById('dealsTable') || document.querySelector('table#dealsTable, .deals-table');
            if (tbl && !tbl.tHead) tbl.createTHead();
            if (window.dealColumns && Array.isArray(window.dealColumns)) {
              window.dealColumns = window.dealColumns.map(c => {
                if (c && typeof c === 'object' && !('cls' in c)) c.cls = '';
                return c;
              });
            }
            return orig.apply(this, arguments);
          } catch (e) {
            console.warn('[renderDealsTable] guarded fallback:', e);
          }
        };
      }
    } catch(_) {}
  });
})();
</script>
<script id="mbps-late-guards">
(function(){
  try {
    const tryWrap = ()=>{
      if (!window.renderDealsTable) return false;
      if (window.renderDealsTable._wrapped) return true;
      const orig = window.renderDealsTable;
      window.renderDealsTable = function(){
        try {
          const tbl = document.getElementById('dealsTable') || document.querySelector('table#dealsTable, .deals-table');
          if (tbl && !tbl.tHead) try{ tbl.createTHead(); }catch(_){}
          if (Array.isArray(window.dealColumns)) {
            window.dealColumns = window.dealColumns.filter(Boolean).map(c => {
              if (typeof c !== 'object') return { key:String(c), title:String(c), cls:'' };
              if (!('cls' in c)) c.cls = '';
              if (!('key' in c) && c.title) c.key = String(c.title).toLowerCase().replace(/\s+/g,'_');
              return c;
            });
          }
          return orig.apply(this, arguments);
        } catch (e) {
          console.warn('[renderDealsTable] guarded fallback:', e);
        }
      };
      window.renderDealsTable._wrapped = true;
      return true;
    };
    if (!tryWrap()) { document.addEventListener('DOMContentLoaded', tryWrap); }
  } catch(_) {}
})();
</script>


<script id="mbps-ui-hotfix-PE-and-agent-search">
(function(){
  document.addEventListener('DOMContentLoaded', () => {
    // -------- Wire/label the blank button to Property Evaluation --------
    const peModal = document.getElementById('peModal') || document.getElementById('propertyEvalModal');
    function openPE(){
      if (!peModal || !peModal.showModal) return alert('Property Evaluation panel not found.');
      // close any open dialogs first
      document.querySelectorAll('dialog[open]').forEach(d => { if (d !== peModal) try{ d.close(); }catch(_){} });
      peModal.showModal();
    }
    // Find any blank button sitting next to "Analyze Deal" and "Schedule Follow-up"
    const analyzeLabels = ['Analyze Deal','Analyze','Analyze Property','Analyze This Deal'];
    const followLabels  = ['Schedule Follow-up','Follow-up','Schedule'];
    const btns = Array.from(document.querySelectorAll('.btn, button')).filter(b => (b.textContent||'').trim() === '');
    btns.forEach(b => {
      const sibs = Array.from(b.parentElement ? b.parentElement.querySelectorAll('button,.btn') : [])
                       .map(x => (x.textContent||'').trim());
      const hasAnalyze = sibs.some(t => analyzeLabels.includes(t));
      const hasFollow  = sibs.some(t => followLabels.includes(t));
      if (hasAnalyze && hasFollow) {
        b.textContent = 'Property Evaluation';
        b.id = b.id || 'btnPropertyEvaluation';
        b.addEventListener('click', (e)=>{ e.preventDefault(); openPE(); }, { once:false });
      }
    });
    // Also catch any explicit placeholder buttons by aria-label or data-action
    document.querySelectorAll('button[aria-label="property-evaluation"], button[data-action="property-evaluation"]').forEach(b=>{
      if (!(b.textContent||'').trim()) b.textContent = 'Property Evaluation';
      b.addEventListener('click', (e)=>{ e.preventDefault(); openPE(); }, { once:false });
    });

    // -------- Agent Network search input alignment --------
    // Try to style the search input with a consistent class and width
    const agentScope = document.getElementById('agentNetwork') || document.querySelector('#agentNetworkTab, [data-tab-panel="agents"], #agents');
    if (agentScope){
      // Heuristically find a search input in the agent header area
      const searchInput = agentScope.querySelector('input[placeholder*="Search agent"], input[placeholder*="Search"]') ||
                          agentScope.querySelector('input[type="search"]');
      if (searchInput){
        searchInput.classList.add('agent-search-input');
      }
    }
  });
})();
</script>


<script id="mbps-blank-button-killer">
(function(){
  function getPEModal(){
    return document.getElementById('peModal')
        || document.getElementById('propertyEvalModal')
        || document.querySelector('dialog#property-valuation, dialog[property-evaluation]')
        || null;
  }
  function openPE(){
    const pe = getPEModal();
    if (pe && typeof pe.showModal === 'function'){
      document.querySelectorAll('dialog[open]').forEach(d => { if (d!==pe) { try{ d.close(); }catch(_){}}});
      pe.showModal();
      return true;
    }
    // fall back to tab panel if modal not present
    const tab = document.getElementById('property-valuation') || document.querySelector('[data-tab-panel="property-valuation"]');
    if (tab){
      if (typeof window.showTab === 'function') try{ window.showTab('property-valuation'); }catch(_){}
      tab.scrollIntoView({behavior:'smooth', block:'start'});
      return true;
    }
    alert('Property Evaluation panel not found.');
    return false;
  }

  function labelAndWire(btn){
    if (!btn) return;
    const txt = (btn.textContent||'').trim();
    if (!txt){
      btn.textContent = 'Property Evaluation';
    }
    btn.id = btn.id || 'btnPropertyEvaluation';
    // add primary/blue class if your CSS has it
    if (btn.classList) {
      if (!Array.from(btn.classList).some(c => /primary|blue/i.test(c))) {
        btn.classList.add('blue'); // adjust if your primary class is different
      }
    }
    btn.addEventListener('click', function(ev){
      ev.preventDefault(); ev.stopPropagation();
      openPE();
    }, { once:false });
  }

  function scanOnce(root=document){
    // Heuristic: a blank button in the same group as Analyze Deal and Schedule Follow-up
    const groups = root.querySelectorAll('.btn-group, .actions, .action-row, .deal-actions, .flex, .grid');
    groups.forEach(g => {
      const labels = Array.from(g.querySelectorAll('button,.btn,a')).map(x => (x.textContent||'').trim());
      const hasAnalyze = labels.some(t => /^analyze/i.test(t));
      const hasFollow  = labels.some(t => /follow[- ]?up/i.test(t));
      if (hasAnalyze && hasFollow){
        Array.from(g.querySelectorAll('button,.btn')).forEach(b => {
          if (!(b.textContent||'').trim()) labelAndWire(b);
        });
      }
    });

    // Also wire explicit placeholders
    document.querySelectorAll('button[aria-label="property-evaluation"], button[data-action="property-evaluation"]').forEach(labelAndWire);

    // If there is an anchor/tab with no text that points to property valuation, fix it
    document.querySelectorAll('a[href="#property-valuation"], [data-tab="property-valuation"]').forEach(el => {
      if (!(el.textContent||'').trim()) el.textContent = 'Property Evaluation';
    });
  }

  // Initial scan
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', () => { scanOnce(); });
  } else {
    scanOnce();
  }

  // MutationObserver to catch late-rendered buttons
  const mo = new MutationObserver(muts => {
    let needs = false;
    for (const m of muts){
      if (m.addedNodes && m.addedNodes.length) { needs = true; break; }
    }
    if (needs) scanOnce();
  });
  mo.observe(document.documentElement, { childList: true, subtree: true });
})();
</script>

<script id="mbps-renderDealsTable-guard">
(function(){
  function wrap(){
    if (!window.renderDealsTable || window.renderDealsTable._wrapped) return;
    const orig = window.renderDealsTable;
    window.renderDealsTable = function(){
      try{
        const tbl = document.getElementById('dealsTable') || document.querySelector('table#dealsTable, .deals-table');
        if (tbl && !tbl.tHead) try{ tbl.createTHead(); }catch(_){}
        if (Array.isArray(window.dealColumns)){
          window.dealColumns = window.dealColumns.filter(Boolean).map(c => {
            if (typeof c !== 'object') return { key:String(c), title:String(c), cls:'' };
            if (!('cls' in c)) c.cls = '';
            if (!('key' in c) && c.title) c.key = String(c.title).toLowerCase().replace(/\s+/g,'_');
            return c;
          });
        }
        return orig.apply(this, arguments);
      }catch(e){ console.warn('[renderDealsTable] guarded:', e); }
    };
    window.renderDealsTable._wrapped = true;
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', wrap); else wrap();
})();
</script>
  <!-- ... existing scripts ... -->

<!-- Add this right before </body> -->
<script id="fix-missing-button-text-v2">
(function() {
  function fixAllButtons() {
    // Extended Pipeline buttons - check by ID directly
    const analyzeBtn = document.getElementById('analyzeExtDealBtn');
    if (analyzeBtn && !analyzeBtn.textContent.trim()) {
      analyzeBtn.textContent = 'Analyze Deal';
      analyzeBtn.classList.add('btn', 'btn-outline');
    }
    
    const scheduleBtn = document.getElementById('scheduleFollowUpBtn');
    if (scheduleBtn && !scheduleBtn.textContent.trim()) {
      scheduleBtn.textContent = 'Schedule Follow-up';
      scheduleBtn.classList.add('btn', 'btn-outline');
    }
    
    // Also check for button without specific ID but in the right context
    const extForm = document.getElementById('extendedDealForm');
    if (extForm) {
      const allButtons = extForm.querySelectorAll('button');
      allButtons.forEach((btn, index) => {
        if (!btn.textContent.trim()) {
          // Based on position in form
          if (btn.type === 'submit') {
            btn.textContent = 'Add to Extended Pipeline';
          } else if (index === 1) {
            btn.textContent = 'Analyze Deal';
          } else if (index === 2) {
            btn.textContent = 'Schedule Follow-up';
          }
        }
      });
    }
  }
  
  // Strategy 1: Run immediately
  fixAllButtons();
  
  // Strategy 2: Run on DOM ready
  if (document.readyState !== 'loading') {
    fixAllButtons();
  } else {
    document.addEventListener('DOMContentLoaded', fixAllButtons);
  }
  
  // Strategy 3: Run multiple times with delays
  [100, 250, 500, 1000, 2000].forEach(delay => {
    setTimeout(fixAllButtons, delay);
  });
  
  // Strategy 4: Run when tab changes
  document.addEventListener('click', function(e) {
    if (e.target.closest('.tab, [data-tab]')) {
      setTimeout(fixAllButtons, 100);
    }
  });
  
  // Strategy 5: Mutation observer to catch dynamic changes
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.addedNodes.length) {
        fixAllButtons();
      }
    });
  });
  
  // Start observing
  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
  
  // Stop observer after 10 seconds to prevent performance issues
  setTimeout(() => observer.disconnect(), 10000);
})();
</script>
  <script id="rei-enhancements-complete">
// ========= REI STACK ENHANCEMENTS =========
// This runs alongside your existing code without interfering
(function() {
  'use strict';
  
  // Check if enhancements already loaded
  if (window.REIEnhancements) return;
  
  // Create enhancement namespace
  window.REIEnhancements = {
    version: '1.0.0',
    initialized: false
  };
  
  // ========= SAFE DASHBOARD RENDERER =========
  function renderEnhancedDashboard() {
    try {
      // Get data safely
      const deals = JSON.parse(localStorage.getItem('deals') || '[]');
      const leads = JSON.parse(localStorage.getItem('leads') || '[]');
      
      // Active deals count
      const activeDeals = deals.filter(d => 
        d.status !== 'closed' && d.status !== 'dead'
      ).length;
      
      // Monthly profit (closed this month)
      const thisMonth = new Date();
      thisMonth.setDate(1);
      const monthStart = thisMonth.getTime();
      
      const monthlyProfit = deals
        .filter(d => d.status === 'closed' && d.closedDate >= monthStart)
        .reduce((sum, d) => sum + (Number(d.profit) || 0), 0);
      
      // Hot leads (score 70+)
      const hotLeads = leads.filter(l => {
        const score = typeof window.scoreLead === 'function' ? 
          window.scoreLead(l) : 50;
        return score >= 70;
      });
      
      // Conversion rate
      const totalLeads = leads.length;
      const convertedDeals = deals.length;
      const conversionRate = totalLeads > 0 ? 
        ((convertedDeals / totalLeads) * 100).toFixed(1) : 0;
      
      // Update displays safely
      const updateElement = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      };
      
      updateElement('activeDealsCount', activeDeals);
      updateElement('monthlyProfit', '$' + monthlyProfit.toLocaleString());
      updateElement('hotLeadsCount', hotLeads.length);
      updateElement('conversionRate', conversionRate + '%');
      
      // Hot deals list
      const hotDealsList = document.getElementById('hotDealsList');
      if (hotDealsList) {
        if (hotLeads.length === 0) {
          hotDealsList.innerHTML = '<div class="text-gray-500">No hot deals yet</div>';
        } else {
          hotDealsList.innerHTML = hotLeads.slice(0, 5).map(lead => `
            <div class="p-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800">
              <div class="font-semibold">${lead.address || 'No address'}</div>
              <div class="text-sm text-gray-600">
                Score: ${typeof window.scoreLead === 'function' ? window.scoreLead(lead) : 'N/A'} | 
                ${lead.seller || 'Unknown seller'}
              </div>
            </div>
          `).join('');
        }
      }
      
      // Today's tasks
      const today = new Date();
      today.setHours(0,0,0,0);
      const todayTime = today.getTime();
      const tomorrow = todayTime + 86400000;
      
      const todayTasks = deals.filter(d => 
        d.nextActionDate >= todayTime && d.nextActionDate < tomorrow
      );
      
      updateElement('todayCount', todayTasks.length);
      
      const todayTasksList = document.getElementById('todayTasksList');
      if (todayTasksList) {
        if (todayTasks.length === 0) {
          todayTasksList.innerHTML = '<div class="text-gray-500">No tasks today</div>';
        } else {
          todayTasksList.innerHTML = todayTasks.map(task => `
            <div class="p-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800">
              <div class="font-semibold">${task.address || task.title || 'No address'}</div>
              <div class="text-sm text-gray-600">
                ${task.nextAction || 'Follow up'}
              </div>
            </div>
          `).join('');
        }
      }
      
    } catch (error) {
      console.log('Dashboard render error (non-critical):', error);
    }
  }
  
  // ========= ANALYZER FUNCTIONS =========
  function analyzeWholesale() {
    try {
      const arv = Number(document.getElementById('wsARV')?.value || 0);
      const repairs = Number(document.getElementById('wsRepairs')?.value || 0);
      const ask = Number(document.getElementById('wsAsk')?.value || 0);
      const fee = Number(document.getElementById('wsFee')?.value || 10000);
      
      const mao = (arv * 0.70) - repairs - fee;
      const spread = mao - ask;
      const roi = ask > 0 ? ((spread / ask) * 100) : 0;
      
      let strength = 'Pass';
      let strengthColor = '#ef4444';
      if (spread > 20000) {
        strength = 'Strong';
        strengthColor = '#22c55e';
      } else if (spread > 10000) {
        strength = 'Good';
        strengthColor = '#06b6d4';
      } else if (spread > 5000) {
        strength = 'Marginal';
        strengthColor = '#f59e0b';
      }
      
      const updateEl = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      };
      
      updateEl('wsMAO', '$' + mao.toLocaleString());
      updateEl('wsSpread', '$' + spread.toLocaleString());
      updateEl('wsROI', roi.toFixed(1) + '%');
      
      const strengthEl = document.getElementById('wsStrength');
      if (strengthEl) {
        strengthEl.textContent = strength;
        strengthEl.style.color = strengthColor;
      }
    } catch (e) {
      console.log('Wholesale analyzer error:', e);
    }
  }
  
  function analyzeSubjectTo() {
    try {
      const arv = Number(document.getElementById('stARV')?.value || 0);
      const mortgage = Number(document.getElementById('stMortgage')?.value || 0);
      const payment = Number(document.getElementById('stPayment')?.value || 0);
      const rent = Number(document.getElementById('stRent')?.value || 0);
      
      const equity = arv - mortgage;
      const cashflow = rent - payment;
      const ltv = arv > 0 ? ((mortgage / arv) * 100) : 0;
      
      let risk = 'Low';
      let riskColor = '#22c55e';
      if (ltv > 80) {
        risk = 'High';
        riskColor = '#ef4444';
      } else if (ltv > 65) {
        risk = 'Medium';
        riskColor = '#f59e0b';
      }
      
      const updateEl = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      };
      
      updateEl('stEquity', '$' + equity.toLocaleString());
      updateEl('stCashflow', '$' + cashflow.toLocaleString());
      updateEl('stLTV', ltv.toFixed(1) + '%');
      
      const riskEl = document.getElementById('stRisk');
      if (riskEl) {
        riskEl.textContent = risk;
        riskEl.style.color = riskColor;
      }
    } catch (e) {
      console.log('SubjectTo analyzer error:', e);
    }
  }
  
  function analyzeFixFlip() {
    try {
      const purchase = Number(document.getElementById('ffPurchase')?.value || 0);
      const arv = Number(document.getElementById('ffARV')?.value || 0);
      const repairs = Number(document.getElementById('ffRepairs')?.value || 0);
      const months = Number(document.getElementById('ffHoldMonths')?.value || 6);
      const holdCosts = Number(document.getElementById('ffHoldCosts')?.value || 2500);
      const sellPct = Number(document.getElementById('ffSellCosts')?.value || 8) / 100;
      
      const totalHold = holdCosts * months;
      const sellCosts = arv * sellPct;
      const totalInvest = purchase + repairs + totalHold + sellCosts;
      const profit = arv - totalInvest;
      const roi = totalInvest > 0 ? ((profit / totalInvest) * 100) : 0;
      const margin = arv > 0 ? ((profit / arv) * 100) : 0;
      
      let risk = 'Low';
      let riskColor = '#22c55e';
      if (margin < 10) {
        risk = 'High';
        riskColor = '#ef4444';
      } else if (margin < 20) {
        risk = 'Medium';
        riskColor = '#f59e0b';
      }
      
      const updateEl = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      };
      
      updateEl('ffProfit', '$' + profit.toLocaleString());
      updateEl('ffROI', roi.toFixed(1) + '%');
      updateEl('ffMargin', margin.toFixed(1) + '%');
      
      const riskEl = document.getElementById('ffRisk');
      if (riskEl) {
        riskEl.textContent = risk;
        riskEl.style.color = riskColor;
      }
    } catch (e) {
      console.log('Fix/flip analyzer error:', e);
    }
  }
  
  function analyzeAirbnb() {
    try {
      const purchase = Number(document.getElementById('abPurchase')?.value || 0);
      const rehab = Number(document.getElementById('abRehab')?.value || 0);
      const nightly = Number(document.getElementById('abNightlyRate')?.value || 0);
      const occupancy = Number(document.getElementById('abOccupancy')?.value || 65) / 100;
      const expenses = Number(document.getElementById('abExpenses')?.value || 0);
      const downPct = Number(document.getElementById('abDownPayment')?.value || 25) / 100;
      
      const monthlyRevenue = nightly * 30 * occupancy;
      const cashflow = monthlyRevenue - expenses;
      const totalCash = (purchase * downPct) + rehab;
      const annualCashflow = cashflow * 12;
      const roi = totalCash > 0 ? ((annualCashflow / totalCash) * 100) : 0;
      const payback = annualCashflow > 0 ? (totalCash / annualCashflow) : 0;
      
      const updateEl = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      };
      
      updateEl('abRevenue', '$' + Math.round(monthlyRevenue).toLocaleString());
      updateEl('abCashflow', '$' + Math.round(cashflow).toLocaleString());
      updateEl('abROI', roi.toFixed(1) + '%');
      updateEl('abPayback', payback > 0 ? payback.toFixed(1) + ' years' : 'â€”');
    } catch (e) {
      console.log('Airbnb analyzer error:', e);
    }
  }
  
  // ========= INITIALIZATION =========
  function initEnhancements() {
    if (REIEnhancements.initialized) return;
    
    // Wire up analyzer inputs
    const analyzerInputs = [
      { ids: ['wsARV', 'wsRepairs', 'wsAsk', 'wsFee'], fn: analyzeWholesale },
      { ids: ['stARV', 'stMortgage', 'stPayment', 'stRent'], fn: analyzeSubjectTo },
      { ids: ['ffPurchase', 'ffARV', 'ffRepairs', 'ffHoldMonths', 'ffHoldCosts', 'ffSellCosts'], fn: analyzeFixFlip },
      { ids: ['abPurchase', 'abRehab', 'abNightlyRate', 'abOccupancy', 'abExpenses', 'abDownPayment'], fn: analyzeAirbnb }
    ];
    
    analyzerInputs.forEach(group => {
      group.ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', group.fn);
        }
      });
    });
    
    // Make dashboard function available globally
    window.renderEnhancedDashboard = renderEnhancedDashboard;
    
    // Run dashboard on tab click
    document.querySelectorAll('[data-tab="dashboard"]').forEach(tab => {
      tab.addEventListener('click', () => {
        setTimeout(renderEnhancedDashboard, 100);
      });
    });
    
    // Initial dashboard render if on dashboard tab
    if (!document.getElementById('dashboard')?.classList.contains('hidden')) {
      renderEnhancedDashboard();
    }
    
    REIEnhancements.initialized = true;
    console.log('REI Enhancements loaded successfully');
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initEnhancements);
  } else {
    initEnhancements();
  }
})();
</script>
  <script id="fix-all-empty-buttons-final">
// Comprehensive button text fix - runs multiple times to catch everything
(function() {
  function fixAllButtonText() {
    // Extended Pipeline buttons
    const extButtons = {
      'analyzeExtDealBtn': 'Analyze Deal',
      'scheduleFollowUpBtn': 'Schedule Follow-up'
    };
    
    Object.keys(extButtons).forEach(id => {
      const btn = document.getElementById(id);
      if (btn && !btn.textContent.trim()) {
        btn.textContent = extButtons[id];
      }
    });
    
    // Extended Pipeline submit button
    const extForm = document.getElementById('extendedDealForm');
    if (extForm) {
      const submitBtn = extForm.querySelector('button[type="submit"]');
      if (submitBtn && !submitBtn.textContent.trim()) {
        submitBtn.textContent = 'Add to Extended Pipeline';
      }
    }
    
    // Buyers tab button
    const buyerBtn = document.getElementById('addBuyerBtn');
    if (buyerBtn && !buyerBtn.textContent.trim()) {
      buyerBtn.textContent = 'Add Buyer';
    }
    
    // Agent Network buttons
    const agentBtn = document.getElementById('addAgentBtn');
    if (agentBtn && !agentBtn.textContent.trim()) {
      agentBtn.textContent = 'Add Agent';
    }
    
    // Agent outreach search button
    const agentSection = document.querySelector('#tab-agent-outreach');
    if (agentSection) {
      const searchBtn = agentSection.querySelector('button:not([id])');
      if (searchBtn && !searchBtn.textContent.trim()) {
        searchBtn.textContent = 'Search';
      }
    }
    
    // Property Evaluation buttons
    const peButtons = {
      'sfAnalyze': 'Analyze',
      'sfSetOffer': 'Set Offer', 
      'mfAnalyze': 'Analyze',
      'mfSave': 'Save to Deal',
      'abAnalyze': 'Analyze',
      'abSave': 'Save to Deal'
    };
    
    Object.keys(peButtons).forEach(id => {
      const btn = document.getElementById(id);
      if (btn && !btn.textContent.trim()) {
        btn.textContent = peButtons[id];
      }
    });
    
    // Any other blank buttons - give them generic text
    document.querySelectorAll('button').forEach(btn => {
      if (!btn.textContent.trim() && !btn.querySelector('i')) {
        if (btn.type === 'submit') {
          btn.textContent = 'Submit';
        } else if (btn.id && btn.id.includes('add')) {
          btn.textContent = 'Add';
        } else if (btn.id && btn.id.includes('save')) {
          btn.textContent = 'Save';
        } else if (btn.id && btn.id.includes('analyze')) {
          btn.textContent = 'Analyze';
        }
      }
    });
  }
  
  // Run immediately
  fixAllButtonText();
  
  // Run on DOM ready
  if (document.readyState !== 'loading') {
    fixAllButtonText();
  } else {
    document.addEventListener('DOMContentLoaded', fixAllButtonText);
  }
  
  // Run multiple times to catch dynamic content
  setTimeout(fixAllButtonText, 100);
  setTimeout(fixAllButtonText, 500);
  setTimeout(fixAllButtonText, 1000);
  setTimeout(fixAllButtonText, 2000);
  
  // Run when any tab is clicked
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('tab')) {
      setTimeout(fixAllButtonText, 100);
    }
  });
  
  // Override Lucide to preserve button text
  if (window.lucide) {
    const originalCreate = lucide.createIcons;
    lucide.createIcons = function() {
      const result = originalCreate.apply(this, arguments);
      setTimeout(fixAllButtonText, 10);
      return result;
    };
  }
})();
</script>
</body>
</html>

