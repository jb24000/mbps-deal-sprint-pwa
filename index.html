<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>REI Stack — MBPS Deal Sprint + DealDesk CRM</title>
  <meta name="theme-color" content="#0ea5e9" />
  <!-- Add favicon to prevent 404 error -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 64 64%22><rect width=%2264%22 height=%2264%22 rx=%2210%22 fill=%22%2306b6d4%22/><text x=%2232%22 y=%2239%22 font-size=%2230%22 text-anchor=%22middle%22 fill=%22white%22 font-family=%22Arial%22>REI</text></svg>">
  <!-- Fonts for typed signature styles -->
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Dancing+Script:wght@600&family=Pacifico&family=Satisfy&display=swap" rel="stylesheet">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand:{50:'#ecfeff',100:'#cffafe',200:'#a5f3fc',300:'#67e8f9',400:'#22d3ee',500:'#06b6d4',600:'#0891b2',700:'#0e7490',800:'#155e75',900:'#164e63'},
            accent:{50:'#fdf4ff',100:'#fae8ff',200:'#f5d0fe',300:'#f0abfc',400:'#e879f9',500:'#d946ef',600:'#c026d3',700:'#a21caf',800:'#86198f',900:'#701a75'}
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css"/>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --ring: 0 0 0 3px rgb(14 165 233 / .25); }
    html, body { height: 100%; }
    .card { background:white; border-radius:1rem; box-shadow:0 10px 30px rgba(2,132,199,.08); padding:1rem; border:1px solid #e2e8f0; }
    .btn { display:inline-flex; align-items:center; gap:.5rem; padding:.75rem 1rem; border-radius:.9rem; border:1px solid #e2e8f0; font-size:.95rem; font-weight:600; -webkit-tap-highlight-color: transparent; }
    .btn:active { transform:scale(.98) }
    .btn-primary { background:#06b6d4; color:white; border-color:#0e7490; }
    .btn-outline { background:white; color:#0e7490; border-color:#7dd3fc; }
    .btn-accent { background:#d946ef; color:white; border-color:#a21caf; }
    .badge { display:inline-flex; align-items:center; padding:.125rem .6rem; border-radius:999px; font-size:.8rem; font-weight:700; }
    .badge-lead{background:#e5e7eb;color:#111827}.badge-offer{background:#e0f2fe;color:#075985}.badge-pending{background:#fef9c3;color:#854d0e}
    .badge-sent{background:#dbeafe;color:#1e40af}.badge-signed{background:#dcfce7;color:#166534}.badge-attorney{background:#efe7ff;color:#6b21a8}.badge-closed{background:#bbf7d0;color:#065f46}
    .dropzone { display:flex; align-items:center; justify-content:center; min-height:140px; width:100%; border:2px dashed #bae6fd; border-radius:1rem; background:#f0f9ff; color:#0c4a6e; user-select:none; }
    .dropzone.dragover { outline: 3px solid rgba(14,165,233,.25); }
    .kanban-col { background:linear-gradient(180deg,#f8fafc,#eef2ff); border-radius:1rem; padding:.75rem; min-height:220px; }
    .tab { border-bottom:2px solid transparent; padding:.5rem .75rem; border-radius:.5rem .5rem 0 0; }
    .tab.active { border-color:#06b6d4; background:#cffafe; color:#0e7490; }
    canvas.sig { touch-action:none; }
    .draggable { cursor:grab; }
    .draggable:active { cursor:grabbing; }
    .meter { height:10px; border-radius:999px; background:#e5e7eb; overflow:hidden; }
    .meter > i { display:block; height:100%; background:#06b6d4; }
    .sticky-topbar { position: sticky; top: 0; z-index: 40; }
    @media (max-width: 640px){
      .btn { padding:.95rem 1.05rem; font-size:1rem; }
      .mobile-only { display:block !important; }
      .desktop-only { display:none !important; }
      input, select, textarea { font-size:16px; }
      .sticky-tabs { position: sticky; top: 56px; z-index: 30; background: rgba(255,255,255,.9); backdrop-filter: blur(6px); }
    }
    @media (min-width: 641px){
      .mobile-only { display:none !important; }
      .desktop-only { display:block !important; }
    }
    #pdfContainer canvas { width: 100% !important; height: auto !important; }
    /* Dark theme */
    .dark body { background: linear-gradient(135deg,#0b1220,#111827 40%,#0a1224); color:#e5e7eb; }
    .dark .card { background:#0f172a; border-color:#1f2937; box-shadow:none; }
    .dark .btn { border-color:#334155; color:#e5e7eb; background:#0b1322; }
    .dark .btn-outline { background:#0b1322; }
    .dark .btn-primary { background:#06b6d4; color:#031b22; border-color:#0891b2; }
    .dark .btn-accent { background:#d946ef; color:#2b0a2b; border-color:#a21caf; }
    .dark .badge-lead{background:#374151;color:#e5e7eb}
    .dark .badge-offer{background:#0b3b4a;color:#67e8f9}
    .dark .badge-pending{background:#3a3005;color:#fde68a}
    .dark .badge-sent{background:#14213d;color:#93c5fd}
    .dark .badge-signed{background:#0f3d2e;color:#bbf7d0}
    .dark .badge-attorney{background:#2d1b3f;color:#f5d0fe}
    .dark .badge-closed{background:#064e3b;color:#bbf7d0}
    .dark .dropzone { background:#0b1322; border-color:#1e293b; color:#7dd3fc; }
    .dark input, .dark select, .dark textarea { background:#0b1322; color:#e5e7eb; border-color:#334155; }
    .dark table thead { color:#93a3b8; }
    .dark #pdfContainer { background:#0b1322; border-color:#1f2937; }
    .dark .sticky-tabs { background: rgba(3,8,23,.7); backdrop-filter: blur(6px); }
    /* One Metric bar */
    .meter { height:10px; border-radius:999px; background:#e5e7eb; overflow:hidden; }
    .meter > i { display:block; height:100%; background:#06b6d4; }
    .sticky-topbar { position: sticky; top: 0; z-index: 40; }
  </style>
</head>
<body class="bg-gradient-to-br from-brand-50 via-white to-accent-50 text-gray-800 min-h-screen">
  <!-- ONE-METRIC BAR -->
  <div class="sticky-topbar w-full bg-white/90 dark:bg-[#0b1322]/70 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-2 flex items-center justify-between gap-3">
      <div class="flex items-center gap-2 text-sm">
        <span class="font-semibold">One Metric:</span>
        <span class="text-gray-600 dark:text-gray-300">Conversations this week</span>
      </div>
      <div class="flex items-center gap-3 min-w-[180px]">
        <div id="omValue" class="text-lg font-bold">0</div>
        <div class="meter w-40 rounded-full"><i id="omMeter" style="width:0%"></i></div>
        <div id="omTarget" class="text-xs text-gray-500">Goal 50</div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto p-4 md:p-8">
    <!-- HEADER -->
    <header class="flex flex-wrap items-center justify-between gap-3 mb-6">
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-2xl bg-gradient-to-br from-brand-500 to-accent-500 grid place-content-center text-white font-bold shadow">REI</div>
        <div>
          <h1 class="text-2xl font-semibold">REI Stack — Millionaire Wholesaler Mode</h1>
          <p class="text-xs text-gray-600 dark:text-gray-300">Leads → Offers (Cash & Terms) → Contracts → Dispo → Closings</p>
        </div>
      </div>
      <div class="flex gap-2 items-center">
        <button id="exportCsvBtn" class="btn btn-outline"><i data-lucide="file-down"></i>Export CSV</button>
        <button id="backupBtn" class="btn btn-outline"><i data-lucide="database"></i>Backup</button>
        <input id="restoreInput" type="file" accept="application/json" class="hidden" />
        <button id="restoreBtn" class="btn btn-outline"><i data-lucide="rotate-ccw"></i>Restore</button>
        <button id="themeToggle" class="btn btn-outline" title="Toggle dark mode"><i data-lucide="moon"></i><span class="hidden sm:inline">Dark</span></button>
      </div>
    </header>

    <!-- NAV TABS -->
    <nav class="sticky-tabs flex flex-wrap gap-2 mb-4 rounded-xl p-1 bg-white/80 dark:bg-[#0b1322]/70">
      <button class="tab active" data-tab="sprint">Sprint</button>
      <button class="tab" data-tab="contracts">Contracts</button>
      <button class="tab" data-tab="pipeline">Pipeline</button>
      <button class="tab" data-tab="signer">Sign</button>
      <button class="tab" data-tab="buyers">Buyers</button>
      <button class="tab" data-tab="kpi">KPI</button>
      <button class="tab" data-tab="settings">Settings</button>
    </nav>

    <!-- SPRINT -->
    <section id="tab-sprint" class="grid lg:grid-cols-3 gap-6">
      <!-- Lead intake + calculators -->
      <section class="lg:col-span-1 card">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Add Lead (Expired • Agent • FSBO)</h2>
          <div class="flex items-center gap-2">
            <label class="text-xs flex items-center gap-1"><input id="agentMode" type="checkbox" class="accent-brand-500"> Agent Mode</label>
            <span class="text-xs text-gray-500">Saved locally</span>
          </div>
        </div>
        <form id="leadForm" class="grid grid-cols-1 gap-3">
          <div>
            <label class="text-sm font-medium">Source</label>
            <select id="leadSource" class="w-full rounded-xl border-gray-200">
              <option>Privy-Distressed</option>
              <option>Privy-HighEquity</option>
              <option>Privy-Absentee</option>
              <option>Privy-PreForeclosure</option>
              <option>Privy-Probate</option>
              <option>Privy-TaxLien</option>
              <option>Expired</option>
              <option>Agent</option>
              <option>FSBO</option>
              <option>Referral</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium">Property Address</label>
            <input id="leadAddress" class="w-full rounded-xl border-gray-200" placeholder="123 Main St, City ST" required />
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="text-sm font-medium">Seller / Contact</label>
              <input id="leadSeller" class="w-full rounded-xl border-gray-200" placeholder="Name" />
            </div>
            <div>
              <label class="text-sm font-medium">Agent (if any)</label>
              <input id="leadAgent" class="w-full rounded-xl border-gray-200" placeholder="Agent Name" />
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <input id="leadPhone" class="w-full rounded-xl border-gray-200" placeholder="Phone" />
            <input id="leadEmail" class="w-full rounded-xl border-gray-200" placeholder="Email" />
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <input id="leadARV" type="number" class="w-full rounded-xl border-gray-200" placeholder="ARV $" />
            <input id="leadRepairs" type="number" class="w-full rounded-xl border-gray-200" placeholder="Repairs $" />
            <input id="leadAsk" type="number" class="w-full rounded-xl border-gray-200" placeholder="Ask/List $" />
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <input id="leadMortgage" type="number" class="w-full rounded-xl border-gray-200" placeholder="Mortgage Bal $" />
            <input id="leadDOM" type="number" class="w-full rounded-xl border-gray-200" placeholder="Days on Market" />
            <select id="leadPropertyType" class="w-full rounded-xl border-gray-200">
              <option value="">Property Type</option>
              <option>SFH</option>
              <option>Townhome</option>
              <option>Condo</option>
              <option>Multi-Family</option>
              <option>Land</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="p-3 rounded-xl border bg-white dark:bg-[#0b1322]">
              <div class="text-gray-500">MAO (70% Rule)</div>
              <div id="maoVal" class="text-lg font-semibold">$0</div>
            </div>
            <div class="p-3 rounded-xl border bg-white dark:bg-[#0b1322]">
              <div class="text-gray-500">Cash Offer Anchor</div>
              <div id="anchorVal" class="text-lg font-semibold">$0</div>
            </div>
          </div>
          <div>
            <label class="text-sm font-medium">Notes</label>
            <textarea id="leadNotes" rows="2" class="w-full rounded-xl border-gray-200" placeholder="Condition, timeline, motivation, mortgage, terms…"></textarea>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <button type="submit" class="btn btn-primary"><i data-lucide="plus"></i>Add Lead</button>
            <button id="importLeadsBtn" type="button" class="btn btn-outline"><i data-lucide="file-up"></i>Import CSV</button>
            <input id="importLeadsInput" type="file" accept=".csv" class="hidden" />
          </div>
          <button id="privyBulkImportBtn" type="button" class="btn btn-accent w-full mt-2"><i data-lucide="upload-cloud"></i>Bulk Import from Privy</button>
          <p class="text-xs text-gray-500">CSV headers: address, seller, phone, email, agent, arv, repairs, ask, notes, source</p>
        </form>
      </section>

      <!-- Sprint queue -->
      <section class="lg:col-span-1 card">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Today's Sprint (Top 20 by Score & Due)</h2>
          <div class="text-sm text-gray-500" id="sprintCount"></div>
        </div>
        <div class="flex flex-wrap gap-2 mb-2">
          <input id="leadSearch" class="rounded-xl border-gray-200 w-full" placeholder="Search address / contact" />
          <select id="leadFilter" class="rounded-xl border-gray-200">
            <option value="">All</option><option>New</option><option>Contacted</option><option>Follow-Up</option><option>Offer Out</option><option>Dead</option>
          </select>
        </div>
        <div id="leadList" class="space-y-3 max-h-[70vh] overflow-auto"></div>
      </section>

      <!-- Scripts & quick actions -->
      <section class="lg:col-span-1 card">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold">Pro Scripts</h2>
          <label class="text-xs flex items-center gap-1"><input id="agentScriptMode" type="checkbox" class="accent-brand-500"> Agent Mode</label>
        </div>
        <div class="space-y-3 text-sm">
          <details class="border rounded-xl p-3 bg-white dark:bg-[#0b1322]" open>
            <summary class="font-semibold cursor-pointer">Expired Listing (Agent)</summary>
            <p class="mt-2" id="scriptExpiredAgent">Hey {{agent}}, this is {{me}}. I saw {{address}} came off the market. I buy a few homes a month in {{city}} — quick and hassle-free. Two options: clean cash close or we keep the existing financing in place and pay on time. Which nets your seller more if speed isn't the only goal?</p>
            <div class="flex gap-2 mt-2"><button class="btn btn-outline text-xs" data-script-copy>Copy</button></div>
          </details>
          <details class="border rounded-xl p-3 bg-white dark:bg-[#0b1322]">
            <summary class="font-semibold cursor-pointer">Seller — Subject-To Opener</summary>
            <p class="mt-2" id="scriptSubjectTo">If I cover your payments — taxes, insurance, maintenance — so you can move on with no stress, what would you need to feel good today? I'll show exact numbers & timing in writing.</p>
            <div class="flex gap-2 mt-2"><button class="btn btn-outline text-xs" data-script-copy>Copy</button></div>
          </details>
          <details class="border rounded-xl p-3 bg-white dark:bg-[#0b1322]">
            <summary class="font-semibold cursor-pointer">Follow-Up Text</summary>
            <p class="mt-2" id="scriptFollowUp">Hey {{name}}, it's {{me}} about {{address}} — still open to a quick offer? I can make the process easy. Want a simple cash number or a terms option that could net you more?</p>
            <div class="flex gap-2 mt-2"><button class="btn btn-outline text-xs" data-script-copy>Copy</button></div>
          </details>

          <!-- Offer Versioning -->
          <div class="border rounded-xl p-3 bg-white dark:bg-[#0b1322]">
            <div class="font-semibold mb-2">Offer Versioning (Cash & Terms)</div>
            <div class="grid gap-2">
              <input id="offerEmailTo" class="rounded-xl border-gray-200" placeholder="To (agent or seller)" />
              <div class="grid sm:grid-cols-2 gap-2">
                <label class="text-xs">Cash % of MAO: <input id="offerCashPct" type="number" value="100" min="50" max="110" class="w-20 rounded-xl border-gray-200 ml-1"></label>
                <label class="text-xs">Terms Down (% ARV): <input id="offerTermsDownPct" type="number" value="5" min="0" max="30" class="w-20 rounded-xl border-gray-200 ml-1"></label>
              </div>
              <div class="grid sm:grid-cols-2 gap-2">
                <label class="text-xs">Interest: <input id="offerTermsRate" type="number" value="4.5" step="0.1" class="w-24 rounded-xl border-gray-200 ml-1">%</label>
                <label class="text-xs">Amort (yrs): <input id="offerTermsAmort" type="number" value="30" class="w-20 rounded-xl border-gray-200 ml-1"></label>
              </div>
              <div class="grid sm:grid-cols-2 gap-2">
                <button id="sendCashOfferBtn" class="btn btn-primary"><i data-lucide="send"></i>Cash Offer</button>
                <button id="sendTermsOfferBtn" class="btn btn-outline"><i data-lucide="send"></i>Terms Offer</button>
              </div>
              <button id="sendBothOffersBtn" class="btn btn-accent"><i data-lucide="sparkles"></i>Send Both</button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Uses EmailJS + Supabase link uploads. Configure in Settings once.</p>
          </div>
        </div>
      </section>
    </section>

    <!-- CONTRACTS -->
    <section id="tab-contracts" class="hidden grid lg:grid-cols-3 gap-6">
      <section class="lg:col-span-2 card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Create Contract</h2>
          <div class="text-xs text-gray-500">Data saved locally</div>
        </div>
        <form id="dealForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Business Name</label>
            <input class="w-full rounded-xl border-gray-200 focus:outline-none focus:ring-[var(--ring)]" id="bizName" placeholder="Your LLC Name" required />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Business Address</label>
            <input class="w-full rounded-xl border-gray-200" id="bizAddress" placeholder="123 Main St, City, ST 00000" required />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Property Address</label>
            <input class="w-full rounded-xl border-gray-200" id="propertyAddress" placeholder="456 Elm St, City, ST 00000" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Seller Name(s)</label>
            <input class="w-full rounded-xl border-gray-200" id="sellerNames" placeholder="First Last; First Last" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Purchase Price ($)</label>
            <input type="number" class="w-full rounded-xl border-gray-200" id="purchasePrice" placeholder="250000" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Assignment Fee ($)</label>
            <input type="number" class="w-full rounded-xl border-gray-200" id="assignmentFee" placeholder="0" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Deal Specifics / Terms</label>
            <textarea class="w-full rounded-xl border-gray-200" id="dealTerms" rows="3" placeholder="Inspection days, earnest money, subject-to details, closing timeline, concessions, etc."></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Contract Template</label>
            <select id="contractTemplate" class="w-full rounded-xl border-gray-200">
              <option value="standard">Standard Purchase</option>
              <option value="subject_to">Subject-To Addendum</option>
              <option value="assignment">Assignment Agreement</option>
              <option value="jv">JV Agreement</option>
              <option value="authorization">Authorization to Release</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Pipeline Status</label>
            <select id="status" class="w-full rounded-xl border-gray-200">
              <option value="lead">Lead</option><option value="offer">Offer Out</option><option value="pending">Pending Signature</option>
              <option value="sent">Sent to Seller</option><option value="signed">Signed</option><option value="attorney">To Attorney / Title</option><option value="closed">Closed</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Property Photo</label>
            <div id="photoDrop" class="dropzone">Tap to upload (or drop)</div>
            <input type="file" id="photoInput" accept="image/*" class="hidden" />
            <div id="photoPreview" class="mt-2 hidden"><img id="photoImg" class="w-full h-36 object-cover rounded-xl border"/></div>
          </div>
          <div class="md:col-span-2 grid grid-cols-2 sm:grid-cols-4 gap-3 mt-2">
            <button type="button" id="genPdfBtn" class="btn btn-outline"><i data-lucide="file-text"></i>PDF</button>
            <button type="submit" class="btn btn-primary"><i data-lucide="save"></i>Save</button>
            <button type="button" id="dealFromLeadBtn" class="btn btn-accent"><i data-lucide="arrow-right"></i>Pre-fill from Selected Lead</button>
            <button type="button" id="openAttachBtn" class="btn btn-outline"><i data-lucide="paperclip"></i>Attachments</button>
          </div>
          <div class="md:col-span-2">
            <div class="mt-6 p-3 rounded-xl border">
              <div class="font-medium mb-2">Email Contract (Supabase Link)</div>
              <div class="grid md:grid-cols-3 gap-3">
                <input class="rounded-xl border-gray-200" id="emailTo" placeholder="Seller Email" />
                <input class="rounded-xl border-gray-200" id="emailjsService" placeholder="EmailJS Service ID" />
                <input class="rounded-xl border-gray-200" id="emailjsTemplate" placeholder="EmailJS Template ID" />
                <input class="rounded-xl border-gray-200 md:col-span-2" id="emailjsPublic" placeholder="EmailJS Public Key" />
                <button id="sendEmailBtn" type="button" class="btn btn-outline"><i data-lucide="send"></i>Send Email (Link)</button>
              </div>
              <p class="text-xs text-gray-500 mt-2">Set Supabase URL/Key in Settings once.</p>
            </div>
          </div>
        </form>
      </section>

      <!-- Deals Table + Dispo Blast -->
      <section class="card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Deals</h2>
          <div class="flex items-center gap-2">
            <input id="search" class="rounded-xl border-gray-200" placeholder="Search address/seller" />
            <select id="filterStatus" class="rounded-xl border-gray-200">
              <option value="">All</option><option value="lead">Lead</option><option value="offer">Offer</option><option value="pending">Pending</option>
              <option value="sent">Sent</option><option value="signed">Signed</option><option value="attorney">Attorney</option><option value="closed">Closed</option>
            </select>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="text-left text-gray-500">
              <tr><th class="py-2 pr-4">Property</th><th class="py-2 pr-4">Seller(s)</th><th class="py-2 pr-4">Price</th><th class="py-2 pr-4">Fee</th><th class="py-2 pr-4">Status</th><th class="py-2 pr-4">Actions</th></tr>
            </thead>
            <tbody id="dealRows"></tbody>
          </table>
        </div>
        <div class="mt-6 border-t pt-4">
          <h3 class="font-semibold mb-2">Dispo Blast</h3>
          <div class="grid gap-2">
            <input id="dispoTags" class="rounded-xl border-gray-200" placeholder="Buyer tags (e.g. 30318; <200k; rehab)" />
            <textarea id="dispoBody" rows="3" class="rounded-xl border-gray-200" placeholder="Short deal description + link..."></textarea>
            <button id="dispoSendBtn" class="btn btn-primary"><i data-lucide="megaphone"></i>Send to Matching Buyers</button>
            <p class="text-xs text-gray-500">Matches buyers whose criteria include any of the tags (semicolon or comma separated).</p>
          </div>
        </div>
      </section>
    </section>

    <!-- PIPELINE -->
    <section id="tab-pipeline" class="hidden">
      <aside class="card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Pipeline Board</h2>
          <div class="text-sm text-gray-500" id="dealCount"></div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          <div><div class="text-xs font-semibold mb-2">Lead</div><div id="col-lead" class="kanban-col" data-status="lead"></div></div>
          <div><div class="text-xs font-semibold mb-2">Offer</div><div id="col-offer" class="kanban-col" data-status="offer"></div></div>
          <div><div class="text-xs font-semibold mb-2">Pending</div><div id="col-pending" class="kanban-col" data-status="pending"></div></div>
          <div><div class="text-xs font-semibold mb-2">Sent</div><div id="col-sent" class="kanban-col" data-status="sent"></div></div>
          <div><div class="text-xs font-semibold mb-2">Signed</div><div id="col-signed" class="kanban-col" data-status="signed"></div></div>
          <div><div class="text-xs font-semibold mb-2">Attorney</div><div id="col-attorney" class="kanban-col" data-status="attorney"></div></div>
          <div class="sm:col-span-2 lg:col-span-3"><div class="text-xs font-semibold mb-2">Closed</div><div id="col-closed" class="kanban-col" data-status="closed"></div></div>
        </div>
      </aside>
    </section>

    <!-- SIGNER -->
    <section id="tab-signer" class="hidden">
      <div class="grid lg:grid-cols-3 gap-6">
        <section class="card lg:col-span-2">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Sign Documents</h2>
            <div class="text-xs text-gray-500">Upload PDF → place fields → finalize</div>
          </div>
          <div class="flex flex-wrap items-center gap-2 mb-3">
            <input id="pdfFile" type="file" accept="application/pdf" class="hidden" />
            <label for="pdfFile" class="btn btn-outline"><i data-lucide="file-up"></i>Upload PDF</label>
            <button id="addSigBtn" class="btn btn-accent" disabled><i data-lucide="pen-line"></i>Signature</button>
            <button id="addInitBtn" class="btn btn-outline" disabled><i data-lucide="signature"></i>Initials</button>
            <button id="finishBtn" class="btn btn-primary" disabled><i data-lucide="check-circle-2"></i>Finalize</button>
          </div>

          <!-- Typed signature/initials controls -->
          <div class="grid md:grid-cols-2 gap-3 mb-3">
            <div class="border rounded-xl p-3 bg-white dark:bg-[#0b1322]">
              <div class="font-semibold text-sm mb-2">Typed Signature (Adobe-style)</div>
              <div class="flex gap-2 mb-2">
                <input id="typedSigInput" class="rounded-xl border-gray-200 w-full" placeholder="Type your full name" />
                <select id="typedSigFont" class="rounded-xl border-gray-200">
                  <option value="'Great Vibes', cursive">Great Vibes</option>
                  <option value="'Dancing Script', cursive">Dancing Script</option>
                  <option value="'Pacifico', cursive">Pacifico</option>
                  <option value="'Satisfy', cursive">Satisfy</option>
                </select>
              </div>
              <button id="typedSigGenerate" class="btn btn-outline text-xs"><i data-lucide="wand-2"></i>Generate Signature</button>
            </div>
            <div class="border rounded-xl p-3 bg-white dark:bg-[#0b1322]">
              <div class="font-semibold text-sm mb-2">Typed Initials</div>
              <div class="flex gap-2 mb-2">
                <input id="typedInitInput" class="rounded-xl border-gray-200 w-full" placeholder="Type your initials" />
                <select id="typedInitFont" class="rounded-xl border-gray-200">
                  <option value="'Great Vibes', cursive">Great Vibes</option>
                  <option value="'Dancing Script', cursive">Dancing Script</option>
                  <option value="'Pacifico', cursive">Pacifico</option>
                  <option value="'Satisfy', cursive">Satisfy</option>
                </select>
              </div>
              <button id="typedInitGenerate" class="btn btn-outline text-xs"><i data-lucide="wand-2"></i>Generate Initials</button>
            </div>
          </div>
          <div id="pdfContainer" class="pdf-pages space-y-4 max-h-[70vh] overflow-auto bg-white dark:bg-[#0b1322] rounded-xl p-3 border"></div>
        </section>
        <aside class="card">
          <h3 class="font-semibold mb-2">Signer (Draw if you prefer)</h3>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">Draw once, then tap pages to place. Or use the typed options on the left.</p>
          <div class="space-y-3">
            <div>
              <label class="text-xs font-semibold">Signature (draw)</label>
              <canvas id="sigPad" class="sig w-full h-40 bg-white border rounded-xl"></canvas>
              <div class="flex gap-2 mt-2">
                <button id="sigClear" class="btn btn-outline text-xs">Clear</button>
                <button id="sigSave" class="btn btn-primary text-xs">Save Signature</button>
              </div>
            </div>
            <div>
              <label class="text-xs font-semibold">Initials (draw)</label>
              <canvas id="initPad" class="sig w-full h-24 bg-white border rounded-xl"></canvas>
              <div class="flex gap-2 mt-2">
                <button id="initClear" class="btn btn-outline text-xs">Clear</button>
                <button id="initSave" class="btn btn-primary text-xs">Save Initials</button>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <!-- BUYERS -->
    <section id="tab-buyers" class="hidden">
      <div class="card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Buyers CRM</h2>
          <button id="addBuyerBtn" class="btn btn-primary"><i data-lucide="user-plus"></i>Add Buyer</button>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="text-left text-gray-500">
              <tr><th class="py-2 pr-4">Buyer</th><th class="py-2 pr-4">Email</th><th class="py-2 pr-4">Phone</th><th class="py-2 pr-4">Criteria/Tags</th><th class="py-2 pr-4">Notes</th><th class="py-2 pr-4">Actions</th></tr>
            </thead>
            <tbody id="buyerRows"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- KPI -->
    <section id="tab-kpi" class="hidden">
      <div class="grid lg:grid-cols-3 gap-6">
        <section class="card lg:col-span-2">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">KPI Dashboard</h2>
            <span class="text-xs text-gray-500">Auto-calculated</span>
          </div>
          <div class="grid sm:grid-cols-2 gap-4">
            <div class="p-4 rounded-xl border bg-white dark:bg-[#0b1322]">
              <div class="text-gray-500 text-sm">Conversations this week</div>
              <div class="flex items-center justify-between"><div id="kpiConvos" class="text-2xl font-semibold">0</div><div id="kpiConvosTarget" class="text-gray-500"></div></div>
              <div class="meter mt-2"><i id="kpiConvosMeter" style="width:0%"></i></div>
            </div>
            <div class="p-4 rounded-xl border bg-white dark:bg-[#0b1322]">
              <div class="text-gray-500 text-sm">Offers sent this week</div>
              <div class="flex items-center justify-between"><div id="kpiOffers" class="text-2xl font-semibold">0</div><div id="kpiOffersTarget" class="text-gray-500"></div></div>
              <div class="meter mt-2"><i id="kpiOffersMeter" style="width:0%"></i></div>
            </div>
            <div class="p-4 rounded-xl border bg-white dark:bg-[#0b1322]">
              <div class="text-gray-500 text-sm">Contracts this month</div>
              <div class="flex items-center justify-between"><div id="kpiContracts" class="text-2xl font-semibold">0</div><div id="kpiContractsTarget" class="text-gray-500"></div></div>
              <div class="meter mt-2"><i id="kpiContractsMeter" style="width:0%"></i></div>
            </div>
            <div class="p-4 rounded-xl border bg-white dark:bg-[#0b1322]">
              <div class="text-gray-500 text-sm">Assignment $ this month</div>
              <div class="flex items-center justify-between"><div id="kpiFees" class="text-2xl font-semibold">$0</div><div class="text-gray-500">Goal: $35,000/mo</div></div>
              <div class="meter mt-2"><i id="kpiFeesMeter" style="width:0%"></i></div>
            </div>
          </div>
          
          <!-- Daily Activity Tracker -->
          <div class="mt-6 p-4 rounded-xl border bg-white dark:bg-[#0b1322]">
            <h3 class="font-semibold mb-3">Daily Activity Tracker</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
              <div class="border rounded-lg p-2">
                <div class="text-xs text-gray-500">Privy Searches Today</div>
                <div id="privySearchesToday" class="text-lg font-semibold">0</div>
              </div>
              <div class="border rounded-lg p-2">
                <div class="text-xs text-gray-500">Offers Sent Today</div>
                <div id="offersSentToday" class="text-lg font-semibold">0</div>
              </div>
              <div class="border rounded-lg p-2">
                <div class="text-xs text-gray-500">Follow-ups Today</div>
                <div id="followUpsToday" class="text-lg font-semibold">0</div>
              </div>
              <div class="border rounded-lg p-2">
                <div class="text-xs text-gray-500">Response Rate</div>
                <div id="responseRate" class="text-lg font-semibold">0%</div>
              </div>
            </div>
            
            <!-- Weekly Conversion Funnel -->
            <div class="mt-4">
              <h4 class="font-medium text-sm mb-2">Weekly Conversion Funnel</h4>
              <div class="space-y-2">
                <div class="flex items-center justify-between">
                  <span class="text-xs">Searches → Offers</span>
                  <span id="searchToOfferRate" class="text-xs font-semibold">0%</span>
                </div>
                <div class="meter"><i id="searchToOfferMeter" style="width:0%"></i></div>
                <div class="flex items-center justify-between">
                  <span class="text-xs">Offers → Contracts</span>
                  <span id="offerToContractRate" class="text-xs font-semibold">0%</span>
                </div>
                <div class="meter"><i id="offerToContractMeter" style="width:0%"></i></div>
              </div>
            </div>
            
            <!-- Pace to Goal -->
            <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
              <div class="text-sm font-medium">Monthly Pace</div>
              <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                <div>Target: 3-5 deals/month = $35,000</div>
                <div id="monthlyPace" class="mt-1"></div>
                <div id="paceRecommendation" class="mt-1 text-blue-700 dark:text-blue-300"></div>
              </div>
            </div>
          </div>
        </section>
        <aside class="card">
          <h3 class="font-semibold mb-3">Targets</h3>
          <div class="grid gap-3 text-sm">
            <div><label>Weekly Conversations</label><input id="goalConvos" type="number" class="w-full rounded-xl border-gray-200" value="50" /></div>
            <div><label>Weekly Offers</label><input id="goalOffers" type="number" class="w-full rounded-xl border-gray-200" value="10" /></div>
            <div><label>Monthly Contracts</label><input id="goalContracts" type="number" class="w-full rounded-xl border-gray-200" value="5" /></div>
            <button id="saveGoalsBtn" class="btn btn-primary">Save Goals</button>
            <p class="text-xs text-gray-500">Rule: 50 quality convos → 10 offers → 3–5 contracts.</p>
          </div>
          
          <!-- Quick Actions -->
          <div class="mt-6 pt-6 border-t">
            <h3 class="font-semibold mb-3">Quick Actions</h3>
            <div class="grid gap-2">
              <button id="logPrivySearchBtn" class="btn btn-outline text-sm"><i data-lucide="search"></i>Log Privy Search</button>
              <button id="markOfferSentBtn" class="btn btn-outline text-sm"><i data-lucide="send"></i>Mark Offer Sent</button>
              <button id="viewActivityLogBtn" class="btn btn-outline text-sm"><i data-lucide="bar-chart-2"></i>Activity Log</button>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="hidden">
      <div class="grid lg:grid-cols-2 gap-6">
        <section class="card">
          <h2 class="text-lg font-semibold mb-3">Supabase Storage</h2>
          <div class="grid gap-3">
            <input id="sbUrl" class="rounded-xl border-gray-200" placeholder="https://YOUR-PROJECT.supabase.co" />
            <input id="sbAnon" class="rounded-xl border-gray-200" placeholder="ANON PUBLIC KEY" />
            <input id="sbBucket" class="rounded-xl border-gray-200" placeholder="Bucket (contracts)" value="contracts" />
            <button id="saveSbBtn" class="btn btn-primary">Save Supabase</button>
            <p class="text-xs text-gray-500">Create a public bucket in Supabase Storage.</p>
          </div>
        </section>
        <section class="card">
          <h2 class="text-lg font-semibold mb-3">EmailJS</h2>
          <div class="grid gap-3">
            <input id="ejService" class="rounded-xl border-gray-200" placeholder="Service ID" />
            <input id="ejTemplate" class="rounded-xl border-gray-200" placeholder="Template ID" />
            <input id="ejPublic" class="rounded-xl border-gray-200" placeholder="Public Key" />
            <button id="saveEjBtn" class="btn btn-primary">Save EmailJS</button>
            <p class="text-xs text-gray-500">Template can use {{bizName}}, {{sellerNames}}, {{propertyAddress}}, {{link}}, etc.</p>
          </div>
        </section>
      </div>
    </section>
  </div>

  <!-- Bulk Import Modal -->
  <div id="bulkImportModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-[#0b1322] rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-auto p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">Bulk Import from Privy</h2>
        <button id="closeBulkImport" class="btn btn-outline text-sm"><i data-lucide="x"></i></button>
      </div>
      
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Step 1: Upload Privy Export</label>
        <input id="privyFileInput" type="file" accept=".csv" class="hidden" />
        <button id="selectPrivyFile" class="btn btn-outline"><i data-lucide="file-up"></i>Select CSV File</button>
        <span id="privyFileName" class="ml-3 text-sm text-gray-500"></span>
      </div>
      
      <div id="fieldMappingSection" class="hidden mb-4">
        <label class="block text-sm font-medium mb-2">Step 2: Map Fields</label>
        <p class="text-xs text-gray-500 mb-3">Match your Privy columns to the system fields</p>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div class="flex items-center justify-between">
            <span>Property Address:</span>
            <select id="mapAddress" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Owner Name:</span>
            <select id="mapOwner" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Mailing Address:</span>
            <select id="mapMailing" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Phone:</span>
            <select id="mapPhone" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Email:</span>
            <select id="mapEmail" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Est. Value/ARV:</span>
            <select id="mapARV" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Mortgage Balance:</span>
            <select id="mapMortgage" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Est. Equity:</span>
            <select id="mapEquity" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Property Type:</span>
            <select id="mapType" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Days on Market:</span>
            <select id="mapDOM" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>List Price:</span>
            <select id="mapListPrice" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
          <div class="flex items-center justify-between">
            <span>Status/Notes:</span>
            <select id="mapStatus" class="rounded-lg border-gray-200 text-xs"></select>
          </div>
        </div>
        
        <div class="mt-4">
          <label class="block text-sm font-medium mb-2">Import Settings</label>
          <div class="space-y-2">
            <label class="flex items-center gap-2 text-sm">
              <input id="skipDuplicates" type="checkbox" checked class="accent-brand-500">
              Skip duplicate addresses
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input id="autoCalcRepairs" type="checkbox" checked class="accent-brand-500">
              Auto-calculate repairs (25% of ARV for distressed)
            </label>
            <div class="flex items-center gap-2">
              <label class="text-sm">Default Source:</label>
              <select id="defaultSource" class="rounded-lg border-gray-200 text-sm">
                <option>Privy-Distressed</option>
                <option>Privy-HighEquity</option>
                <option>Privy-Absentee</option>
                <option>Privy-PreForeclosure</option>
                <option>Privy-Probate</option>
                <option>Privy-TaxLien</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <div id="previewSection" class="hidden mb-4">
        <label class="block text-sm font-medium mb-2">Step 3: Preview Import</label>
        <div class="border rounded-lg p-3 bg-gray-50 dark:bg-gray-900 max-h-60 overflow-auto">
          <div id="importPreview" class="text-xs space-y-2"></div>
        </div>
        <div class="mt-2 text-sm">
          <span>Total rows: <span id="totalRows" class="font-semibold">0</span></span>
          <span class="ml-4">Valid leads: <span id="validLeads" class="font-semibold text-green-600">0</span></span>
          <span class="ml-4">Duplicates: <span id="duplicateCount" class="font-semibold text-yellow-600">0</span></span>
        </div>
      </div>
      
      <div class="flex gap-3 justify-end mt-6">
        <button id="cancelImport" class="btn btn-outline">Cancel</button>
        <button id="processImport" class="btn btn-primary hidden"><i data-lucide="upload"></i>Import Leads</button>
      </div>
      
      <div id="importProgress" class="hidden mt-4">
        <div class="text-sm mb-2">Importing... <span id="progressCount">0</span> / <span id="progressTotal">0</span></div>
        <div class="meter"><i id="progressBar" style="width:0%"></i></div>
      </div>
    </div>
  </div>

  <script>
    lucide.createIcons();
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // ========= ONE METRIC (Conversations) =========
    const state = {
      calls: JSON.parse(localStorage.getItem('calls') || '[]'),
      goals: JSON.parse(localStorage.getItem('goals') || '{"convos":50,"offers":10,"contracts":5}')
    };

    function saveCalls(){
      localStorage.setItem('calls', JSON.stringify(state.calls));
    }

    function weekStartMs(){
      const d=new Date();
      const day=d.getDay();
      const diff=d.getDate()-day+(day===0?-6:1);
      const ws=new Date(d.setDate(diff));
      return new Date(ws.getFullYear(),ws.getMonth(),ws.getDate()).getTime();
    }

    function renderOneMetric(){
      const start=weekStartMs();
      const convos=state.calls.filter(c=>c.ts>=start).length;
      const goal=Number(state.goals.convos||50);
      document.getElementById('omValue').textContent = convos;
      document.getElementById('omTarget').textContent = `Goal ${goal}`;
      document.getElementById('omMeter').style.width = Math.min(100, Math.round((convos/goal)*100))+'%';
    }

    // Auto-log when user clicks call/text/email links
    function logConvo(type, meta = {}) {
      state.calls.push({ type, ts: Date.now(), ...meta });
      saveCalls();
      renderOneMetric(); // update the sticky bar
      updateKPI(); // keep KPI in sync
    }

    renderOneMetric();

    // THEME
    (function themeInit(){
      const root = document.documentElement;
      const saved = localStorage.getItem('THEME');
      if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        root.classList.add('dark');
      }
    })();

    document.getElementById('themeToggle').addEventListener('click', ()=>{
      const root = document.documentElement;
      const isDark = root.classList.toggle('dark');
      localStorage.setItem('THEME', isDark ? 'dark' : 'light');
      lucide.createIcons();
    });

    // ========= STATE =========
    state.settings = {
      sbUrl: localStorage.getItem('SUPABASE_URL') || '',
      sbAnon: localStorage.getItem('SUPABASE_ANON') || '',
      sbBucket: localStorage.getItem('SUPABASE_BUCKET') || 'contracts',
      ejService: localStorage.getItem('EJ_SERVICE') || '',
      ejTemplate: localStorage.getItem('EJ_TEMPLATE') || '',
      ejPublic: localStorage.getItem('EJ_PUBLIC') || ''
    };
    state.leads = JSON.parse(localStorage.getItem('leads') || '[]');
    state.deals = JSON.parse(localStorage.getItem('deals') || '[]');
    state.buyers = JSON.parse(localStorage.getItem('buyers') || '[]');
    state.signer = { 
      pdfBytes: null, 
      pages: [], 
      signatureUrl: null, 
      initialsUrl: null, 
      placements: [] 
    };
    state.selectedLeadId = null;

    const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const money = (n)=> new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(Number(n||0));

    // ========= NAV =========
    const sections = {
      sprint:'#tab-sprint',
      contracts:'#tab-contracts',
      pipeline:'#tab-pipeline',
      signer:'#tab-signer',
      buyers:'#tab-buyers',
      kpi:'#tab-kpi',
      settings:'#tab-settings'
    };

    document.querySelectorAll('.tab').forEach(t=>
      t.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        Object.values(sections).forEach(sel=>document.querySelector(sel).classList.add('hidden'));
        document.querySelector(sections[t.dataset.tab]).classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }));

    // ========= Lead Scoring =========
    function scoreLead(l){
      // Enhanced scoring with Privy indicators
      const sourceW = { 
        'Privy-Distressed': 35,
        'Privy-HighEquity': 30,
        'Privy-Absentee': 28,
        'Privy-PreForeclosure': 40,
        'Privy-Probate': 35,
        'Privy-TaxLien': 38,
        'Expired': 25, 
        'Agent': 20, 
        'FSBO': 15, 
        'Referral': 30, 
        'Other': 10 
      }[l.source] || 10;
      
      const spread = Math.max(0, (l.arv||0)*0.7 - (l.repairs||0) - (l.ask||0));
      const spreadW = Math.min(30, spread / 10000);
      
      // Equity calculation for subject-to potential
      const equity = (l.arv||0) - (l.mortgageBalance||0);
      const equityW = equity > 50000 ? 15 : equity > 20000 ? 10 : 0;
      
      const ageDays = (Date.now() - (l.createdAt||Date.now())) / 86400000;
      const recencyW = Math.max(0, 15 - ageDays);
      const dueW = l.nextAction && l.nextAction <= Date.now() ? 20 : 0;
      
      // Enhanced keywords for distress signals
      const kw = ((l.notes||'') + ' ' + (l.agent||'')).toLowerCase();
      const distressKw = /(pre-foreclosure|foreclosure|tax lien|probate|divorce|behind|vacant|tired|relocating|job loss|inheritance|code violation|expired)/.test(kw);
      const kwW = distressKw ? 15 : 0;
      
      // Days on market bonus (stale listings)
      const domW = l.dom > 90 ? 10 : l.dom > 60 ? 5 : 0;
      
      // Contact attempts - prioritize uncontacted leads
      const contactW = l.attempts === 0 ? 10 : l.attempts < 3 ? 5 : 0;
      
      return Math.round(sourceW + spreadW + equityW + recencyW + dueW + kwW + domW + contactW);
    }

    // ========= MBPS: Lead Intake =========
    const leadForm = document.getElementById('leadForm');
    const leadARV = document.getElementById('leadARV');
    const leadRepairs = document.getElementById('leadRepairs');
    const maoVal = document.getElementById('maoVal');
    const anchorVal = document.getElementById('anchorVal');

    function recalcMAO(){
      const arv = Number(leadARV.value||0), rep = Number(leadRepairs.value||0);
      const mao = Math.max(0, arv*0.7 - rep);
      maoVal.textContent = money(mao);
      anchorVal.textContent = money(mao*0.9);
    }

    ['input','change'].forEach(ev=>{
      leadARV.addEventListener(ev,recalcMAO);
      leadRepairs.addEventListener(ev,recalcMAO);
    });

    leadForm.addEventListener('submit',(e)=>{
      e.preventDefault();
      const lead = {
        id: 'L'+Date.now(),
        source: document.getElementById('leadSource').value,
        address: document.getElementById('leadAddress').value.trim(),
        seller: document.getElementById('leadSeller').value.trim(),
        agent: document.getElementById('leadAgent').value.trim(),
        phone: document.getElementById('leadPhone').value.trim(),
        email: document.getElementById('leadEmail').value.trim(),
        arv: Number(document.getElementById('leadARV').value||0),
        repairs: Number(document.getElementById('leadRepairs').value||0),
        ask: Number(document.getElementById('leadAsk').value||0),
        mortgageBalance: Number(document.getElementById('leadMortgage').value||0),
        dom: Number(document.getElementById('leadDOM').value||0),
        propertyType: document.getElementById('leadPropertyType').value,
        notes: document.getElementById('leadNotes').value.trim(),
        status: 'New',
        attempts: 0,
        offerSent: false,
        offerResponse: null,
        createdAt: Date.now(),
        nextAction: Date.now() + 24*3600*1000  // D+1 auto follow-up
      };
      
      // Track Privy searches
      if (lead.source.startsWith('Privy')) {
        const searches = JSON.parse(localStorage.getItem('privySearches') || '[]');
        const today = new Date().toDateString();
        const todaySearch = searches.find(s => s.date === today);
        if (todaySearch) {
          todaySearch.count++;
        } else {
          searches.push({ date: today, count: 1 });
        }
        localStorage.setItem('privySearches', JSON.stringify(searches));
      }
      
      state.leads.unshift(lead);
      save('leads',state.leads);
      leadForm.reset();
      recalcMAO();
      renderLeads();
      updateDailyMetrics();
      alert('Lead added');
    });

    // ========= Privy Bulk Import =========
    let privyImportData = null;
    let privyHeaders = [];
    
    document.getElementById('privyBulkImportBtn').addEventListener('click', ()=>{
      document.getElementById('bulkImportModal').classList.remove('hidden');
    });
    
    document.getElementById('closeBulkImport').addEventListener('click', ()=>{
      document.getElementById('bulkImportModal').classList.add('hidden');
      privyImportData = null;
      privyHeaders = [];
    });
    
    document.getElementById('cancelImport').addEventListener('click', ()=>{
      document.getElementById('bulkImportModal').classList.add('hidden');
      privyImportData = null;
      privyHeaders = [];
    });
    
    document.getElementById('selectPrivyFile').addEventListener('click', ()=>{
      document.getElementById('privyFileInput').click();
    });
    
    document.getElementById('privyFileInput').addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      if (!file) return;
      
      document.getElementById('privyFileName').textContent = file.name;
      
      try {
        const text = await file.text();
        const lines = text.split(/\r?\n/).filter(l => l.trim());
        const rows = lines.map(line => {
          // Handle both comma and tab delimited files
          const delimiter = line.includes('\t') ? '\t' : ',';
          // Parse CSV properly handling quoted fields
          const regex = new RegExp(`(?:^|${delimiter})("(?:[^"]|"")*"|[^${delimiter}]*)`, 'g');
          const fields = [];
          let match;
          while ((match = regex.exec(line)) !== null) {
            let field = match[1];
            if (field.startsWith('"') && field.endsWith('"')) {
              field = field.slice(1, -1).replace(/""/g, '"');
            }
            fields.push(field);
          }
          return fields;
        });
        
        privyHeaders = rows[0].map(h => h.trim());
        privyImportData = rows.slice(1).map(row => {
          const obj = {};
          privyHeaders.forEach((header, idx) => {
            obj[header] = row[idx] ? row[idx].trim() : '';
          });
          return obj;
        });
        
        // Show field mapping section
        document.getElementById('fieldMappingSection').classList.remove('hidden');
        
        // Populate mapping dropdowns
        const mappingSelects = [
          'mapAddress', 'mapOwner', 'mapMailing', 'mapPhone', 'mapEmail',
          'mapARV', 'mapMortgage', 'mapEquity', 'mapType', 'mapDOM', 
          'mapListPrice', 'mapStatus'
        ];
        
        mappingSelects.forEach(selectId => {
          const select = document.getElementById(selectId);
          select.innerHTML = '<option value="">-- Not Mapped --</option>';
          privyHeaders.forEach(header => {
            select.innerHTML += `<option value="${header}">${header}</option>`;
          });
        });
        
        // Auto-detect common field names
        autoDetectFields();
        
        // Preview data
        previewImportData();
        
      } catch(err) {
        alert('Error reading file: ' + err.message);
      }
    });
    
    function autoDetectFields() {
      const mappings = {
        'mapAddress': ['Property Address', 'Address', 'Property', 'Site Address'],
        'mapOwner': ['Owner Name', 'Owner', 'Name', 'Seller', 'Owner 1 Name'],
        'mapMailing': ['Mailing Address', 'Mail Address', 'Owner Address'],
        'mapPhone': ['Phone', 'Phone Number', 'Mobile', 'Cell'],
        'mapEmail': ['Email', 'Email Address', 'Owner Email'],
        'mapARV': ['Estimated Value', 'Est Value', 'ARV', 'Value', 'Zestimate'],
        'mapMortgage': ['Mortgage Balance', 'Loan Balance', 'Mortgage', 'Total Loan Amount'],
        'mapEquity': ['Equity', 'Est Equity', 'Estimated Equity'],
        'mapType': ['Property Type', 'Type', 'Property Use'],
        'mapDOM': ['Days on Market', 'DOM', 'Days Listed'],
        'mapListPrice': ['List Price', 'Listing Price', 'Ask Price', 'Price'],
        'mapStatus': ['Status', 'Property Status', 'Notes', 'Listing Status']
      };
      
      Object.entries(mappings).forEach(([selectId, possibleHeaders]) => {
        const select = document.getElementById(selectId);
        const match = privyHeaders.find(h => 
          possibleHeaders.some(ph => h.toLowerCase().includes(ph.toLowerCase()))
        );
        if (match) {
          select.value = match;
        }
      });
    }
    
    function previewImportData() {
      if (!privyImportData) return;
      
      const preview = document.getElementById('importPreview');
      const skipDupes = document.getElementById('skipDuplicates').checked;
      const addressField = document.getElementById('mapAddress').value;
      
      if (!addressField) {
        preview.innerHTML = '<div class="text-red-500">Please map the Property Address field</div>';
        return;
      }
      
      // Check for duplicates
      const existingAddresses = state.leads.map(l => l.address.toLowerCase());
      let validCount = 0;
      let dupeCount = 0;
      const previewHTML = [];
      
      privyImportData.slice(0, 5).forEach(row => {
        const address = row[addressField];
        if (!address) return;
        
        const isDupe = existingAddresses.includes(address.toLowerCase());
        if (isDupe && skipDupes) {
          dupeCount++;
          previewHTML.push(`<div class="text-yellow-600">⚠️ Duplicate: ${address}</div>`);
        } else {
          validCount++;
          const owner = row[document.getElementById('mapOwner').value] || 'Unknown';
          const arv = row[document.getElementById('mapARV').value] || '0';
          previewHTML.push(`<div class="text-green-600">✓ ${address} - ${owner} - ARV: $${arv}</div>`);
        }
      });
      
      preview.innerHTML = previewHTML.join('') + 
        (privyImportData.length > 5 ? `<div class="text-gray-500">...and ${privyImportData.length - 5} more</div>` : '');
      
      // Count totals
      let totalValid = 0;
      let totalDupes = 0;
      
      privyImportData.forEach(row => {
        const address = row[addressField];
        if (!address) return;
        const isDupe = existingAddresses.includes(address.toLowerCase());
        if (isDupe && skipDupes) {
          totalDupes++;
        } else {
          totalValid++;
        }
      });
      
      document.getElementById('totalRows').textContent = privyImportData.length;
      document.getElementById('validLeads').textContent = totalValid;
      document.getElementById('duplicateCount').textContent = totalDupes;
      
      document.getElementById('previewSection').classList.remove('hidden');
      document.getElementById('processImport').classList.remove('hidden');
    }
    
    // Re-preview when settings change
    ['mapAddress', 'skipDuplicates', 'autoCalcRepairs', 'defaultSource'].forEach(id => {
      document.getElementById(id).addEventListener('change', previewImportData);
    });
    
    document.getElementById('processImport').addEventListener('click', async ()=>{
      const addressField = document.getElementById('mapAddress').value;
      if (!addressField) {
        alert('Please map the Property Address field');
        return;
      }
      
      const skipDupes = document.getElementById('skipDuplicates').checked;
      const autoRepairs = document.getElementById('autoCalcRepairs').checked;
      const defaultSource = document.getElementById('defaultSource').value;
      
      // Field mappings
      const ownerField = document.getElementById('mapOwner').value;
      const mailingField = document.getElementById('mapMailing').value;
      const phoneField = document.getElementById('mapPhone').value;
      const emailField = document.getElementById('mapEmail').value;
      const arvField = document.getElementById('mapARV').value;
      const mortgageField = document.getElementById('mapMortgage').value;
      const equityField = document.getElementById('mapEquity').value;
      const typeField = document.getElementById('mapType').value;
      const domField = document.getElementById('mapDOM').value;
      const listPriceField = document.getElementById('mapListPrice').value;
      const statusField = document.getElementById('mapStatus').value;
      
      const existingAddresses = state.leads.map(l => l.address.toLowerCase());
      
      // Show progress
      document.getElementById('importProgress').classList.remove('hidden');
      document.getElementById('processImport').disabled = true;
      
      let imported = 0;
      let skipped = 0;
      const totalToProcess = privyImportData.length;
      
      document.getElementById('progressTotal').textContent = totalToProcess;
      
      for (let i = 0; i < privyImportData.length; i++) {
        const row = privyImportData[i];
        const address = row[addressField];
        
        if (!address) {
          skipped++;
          continue;
        }
        
        if (skipDupes && existingAddresses.includes(address.toLowerCase())) {
          skipped++;
          continue;
        }
        
        // Parse numeric values
        const parseNumber = (val) => {
          if (!val) return 0;
          return Number(val.toString().replace(/[$,]/g, '')) || 0;
        };
        
        const arv = parseNumber(row[arvField]);
        const mortgage = parseNumber(row[mortgageField]);
        const listPrice = parseNumber(row[listPriceField]);
        const equity = equityField ? parseNumber(row[equityField]) : (arv - mortgage);
        
        // Calculate repairs if needed
        let repairs = 0;
        if (autoRepairs) {
          if (defaultSource.includes('Distressed') || defaultSource.includes('PreForeclosure')) {
            repairs = Math.round(arv * 0.25); // 25% for distressed
          } else {
            repairs = Math.round(arv * 0.15); // 15% for others
          }
        }
        
        const lead = {
          id: 'L' + Date.now() + '_' + i,
          source: defaultSource,
          address: address,
          seller: row[ownerField] || '',
          agent: '', // Usually not in Privy data
          phone: row[phoneField] || '',
          email: row[emailField] || '',
          arv: arv,
          repairs: repairs,
          ask: listPrice || arv,
          mortgageBalance: mortgage,
          dom: parseNumber(row[domField]),
          propertyType: row[typeField] || 'SFH',
          notes: `Imported from Privy. ${row[statusField] || ''} ${row[mailingField] ? 'Mail: ' + row[mailingField] : ''} Equity: ${money(equity)}`.trim(),
          status: 'New',
          attempts: 0,
          offerSent: false,
          offerResponse: null,
          createdAt: Date.now(),
          nextAction: Date.now() + 24*3600*1000
        };
        
        state.leads.unshift(lead);
        imported++;
        
        // Update progress
        document.getElementById('progressCount').textContent = i + 1;
        document.getElementById('progressBar').style.width = Math.round(((i + 1) / totalToProcess) * 100) + '%';
        
        // Allow UI to update
        if (i % 10 === 0) {
          await new Promise(resolve => setTimeout(resolve, 10));
        }
      }
      
      // Save and update
      save('leads', state.leads);
      renderLeads();
      updateKPI();
      
      // Track the import
      const searches = JSON.parse(localStorage.getItem('privySearches') || '[]');
      const today = new Date().toDateString();
      const todaySearch = searches.find(s => s.date === today);
      if (todaySearch) {
        todaySearch.count += imported;
      } else {
        searches.push({ date: today, count: imported });
      }
      localStorage.setItem('privySearches', JSON.stringify(searches));
      
      alert(`Import complete!\n\nImported: ${imported} leads\nSkipped: ${skipped} (duplicates or invalid)`);
      
      // Reset modal
      document.getElementById('bulkImportModal').classList.add('hidden');
      privyImportData = null;
      privyHeaders = [];
      document.getElementById('importProgress').classList.add('hidden');
      document.getElementById('processImport').disabled = false;
    });

    // Import CSV (original simple import)
    document.getElementById('importLeadsBtn').addEventListener('click',()=>
      document.getElementById('importLeadsInput').click());

    document.getElementById('importLeadsInput').addEventListener('change', async (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const text = await f.text();
      const rows = text.split(/\r?\n/).map(r=>r.split(',').map(c=>c.replace(/^"|"$/g,'')) ).filter(r=>r.some(c=>c.trim()!==''));
      const header = rows.shift().map(h=>h.trim().toLowerCase());
      const idx = (name)=> header.indexOf(name);
      rows.forEach(r=>{
        const lead = {
          id: 'L'+Date.now()+Math.random().toString(36).slice(2,6),
          source: r[idx('source')]||'Expired',
          address: r[idx('address')]||'',
          seller: r[idx('seller')]||'',
          agent: r[idx('agent')]||'',
          phone: r[idx('phone')]||'',
          email: r[idx('email')]||'',
          arv: Number(r[idx('arv')]||0),
          repairs: Number(r[idx('repairs')]||0),
          ask: Number(r[idx('ask')]||0),
          notes: r[idx('notes')]||'',
          status: 'New',
          createdAt: Date.now(),
          nextAction: Date.now()+86400000
        };
        if (lead.address) state.leads.push(lead);
      });
      save('leads',state.leads);
      renderLeads();
      alert('Leads imported');
    });

    // Cadence Engine helpers
    function scheduleCadence(l, step=0){
      // D0 call+text, D2 text, D4 call+email, D7 terms, D10 last call
      const offsets = [0,2,4,7,10];
      const nextIndex = Math.min(offsets.length-1, step);
      l.nextAction = Date.now() + offsets[nextIndex]*86400000;
      l.cadenceStep = nextIndex+1;
    }

    function renderLeads(){
      const list = document.getElementById('leadList');
      const q=(document.getElementById('leadSearch').value||'').toLowerCase();
      const flt=document.getElementById('leadFilter').value;
      // Top 20 by: due today first, then score
      const today = Date.now();
      const arr = state.leads
        .filter(l=> (!flt || l.status===flt) && (l.address.toLowerCase().includes(q) || (l.seller||'').toLowerCase().includes(q) || (l.agent||'').toLowerCase().includes(q)))
        .map(l=> ({ l, score: scoreLead(l), due: (l.nextAction||0) <= today }))
        .sort((a,b)=> (b.due - a.due) || (b.score - a.score) || ((b.l.createdAt||0) - (a.l.createdAt||0)))
        .slice(0,20);

      document.getElementById('sprintCount').textContent = `${arr.length} in queue`;
      list.innerHTML='';
      arr.forEach(({l,score})=>{
        const div = document.createElement('div');
        div.className='border rounded-xl p-3 bg-white dark:bg-[#0b1322]';
        const dueBadge = (l.nextAction && l.nextAction<=today) ? '<span class="badge badge-pending ml-2">Due</span>':'';
        const offerBadge = l.offerSent ? '<span class="badge badge-offer ml-1">Offer Sent</span>' : '';
        const equity = (l.arv||0) - (l.mortgageBalance||0);
        const equityDisplay = l.mortgageBalance ? `Equity: ${money(equity)}` : '';
        
        div.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-medium">${l.address}</div>
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-500">Score</span>
              <span class="badge ${score>=60?'badge-signed':score>=40?'badge-offer':'badge-lead'}">${score}</span>
              ${dueBadge}
              ${offerBadge}
            </div>
          </div>
          <div class="text-xs text-gray-600 dark:text-gray-300 mt-1">
            ${l.seller||'—'} ${l.agent? ' • Agent: '+l.agent:''}
            ${l.propertyType ? ' • ' + l.propertyType : ''}
            ${l.dom ? ' • DOM: ' + l.dom : ''}
          </div>
          <div class="text-xs text-gray-500 mt-1">
            ARV ${money(l.arv)} • Repairs ${money(l.repairs)} • Ask ${money(l.ask)}
            ${equityDisplay}
          </div>
          <div class="flex flex-wrap gap-2 mt-2">
            <a class="btn btn-outline text-xs callBtn" href="tel:${l.phone||''}"><i data-lucide="phone"></i>Call</a>
            <a class="btn btn-outline text-xs textBtn" href="sms:${l.phone||''}"><i data-lucide="message-square"></i>Text</a>
            <button class="btn btn-outline text-xs emailLead"><i data-lucide="mail"></i>Email</button>
            <button class="btn btn-outline text-xs offerLead"><i data-lucide="file-text"></i>Offer</button>
            <button class="btn btn-outline text-xs followLead"><i data-lucide="clock"></i>Follow-Up</button>
            <button class="btn btn-outline text-xs toDeal"><i data-lucide="arrow-right"></i>To Deal</button>
            <button class="btn btn-outline text-xs delLead"><i data-lucide="trash"></i>Del</button>
          </div>
          <div class="text-xs text-gray-600 mt-1">${l.notes||''}</div>
        `;
        
        // Track call attempts
        div.querySelector('.callBtn').addEventListener('click', ()=>{
          l.attempts = (l.attempts || 0) + 1;
          l.lastContact = Date.now();
          logConvo('call', {leadId: l.id});
          save('leads', state.leads);
        });
        
        // Track text attempts
        div.querySelector('.textBtn').addEventListener('click', ()=>{
          l.attempts = (l.attempts || 0) + 1;
          l.lastContact = Date.now();
          logConvo('text', {leadId: l.id});
          save('leads', state.leads);
        });
        
        div.querySelector('.emailLead').addEventListener('click',()=> openOfferEmail(l));
        
        div.querySelector('.offerLead').addEventListener('click',()=> {
          leadToContract(l);
          l.offerSent = true;
          l.offerSentDate = Date.now();
          save('leads', state.leads);
        });
        
        div.querySelector('.followLead').addEventListener('click',()=> {
          scheduleCadence(l, (l.cadenceStep||0));
          save('leads',state.leads);
          renderLeads();
          alert('Follow-up scheduled');
        });
        
        div.querySelector('.toDeal').addEventListener('click',()=> leadToDeal(l));
        
        div.querySelector('.delLead').addEventListener('click',()=>{
          if(confirm('Delete lead?')){
            state.leads = state.leads.filter(x=>x.id!==l.id);
            save('leads',state.leads);
            renderLeads();
          }
        });
        
        div.addEventListener('click', ()=> state.selectedLeadId = l.id);
        list.appendChild(div);
      });
      lucide.createIcons();
    }

    document.getElementById('leadSearch').addEventListener('input',renderLeads);
    document.getElementById('leadFilter').addEventListener('change',renderLeads);

    function leadToDeal(l){
      const deal = {
        bizName: document.getElementById('bizName').value.trim() || 'Your LLC',
        bizAddress: document.getElementById('bizAddress').value.trim() || '',
        propertyAddress: l.address,
        sellerNames: l.seller || '',
        purchasePrice: Math.max(0, (l.arv||0)*0.7 - (l.repairs||0)),
        dealTerms: `Generated from lead. Source: ${l.source}. Notes: ${l.notes||''}`,
        status: 'lead',
        photoDataUrl: null,
        createdAt: Date.now(),
        fee: 0,
        id: 'D'+Date.now()
      };
      state.deals.unshift(deal);
      save('deals',state.deals);
      alert('Moved to Deals. Open Contracts tab to edit.');
    }

    function leadToContract(l){
      document.querySelector('.tab[data-tab="contracts"]').click();
      document.getElementById('propertyAddress').value = l.address;
      document.getElementById('sellerNames').value = l.seller||'';
      document.getElementById('purchasePrice').value = Math.max(0, (l.arv||0)*0.7 - (l.repairs||0));
      document.getElementById('dealTerms').value = `Offer auto-generated from lead. Source: ${l.source}.`;
      window.scrollTo({ top: 0, behavior:'smooth' });
      state.selectedLeadId = l.id;
    }

    function openOfferEmail(l){
      document.getElementById('offerEmailTo').value = l.email || '';
    }

    // Copy script buttons
    document.querySelectorAll('[data-script-copy]').forEach(btn=>
      btn.addEventListener('click',()=>{
        const p = btn.closest('details').querySelector('p');
        navigator.clipboard.writeText(p.textContent.replace(/\s+/g,' ').trim()).then(()=>{
          btn.textContent = 'Copied!';
          setTimeout(()=>btn.textContent='Copy', 2000);
        });
      }));

    // ========= Contracts / Templates =========
    const STATUS_MAP = {
      lead:{label:'Lead',cls:'badge-lead'},
      offer:{label:'Offer Out',cls:'badge-offer'},
      pending:{label:'Pending Signature',cls:'badge-pending'},
      sent:{label:'Sent to Seller',cls:'badge-sent'},
      signed:{label:'Signed',cls:'badge-signed'},
      attorney:{label:'To Attorney / Title',cls:'badge-attorney'},
      closed:{label:'Closed',cls:'badge-closed'}
    };

    function CONTRACT_TEXT(template, d){
      const baseHeader = `PURCHASE AGREEMENT
Date: ${new Date().toLocaleDateString()}
Buyer: ${d.bizName}, located at ${d.bizAddress}.
Seller(s): ${d.sellerNames}.
Property: ${d.propertyAddress}.`;
      
      const baseBody = `Purchase Price: ${money(d.purchasePrice)}.
Earnest Money: $1,000 (refundable within inspection period unless otherwise stated).
Closing: On or before 30 days from execution, or as mutually agreed.
Condition: Property sold AS-IS. Buyer may access property for inspections.
Title & Taxes: Seller to provide clear, marketable title. Taxes prorated at closing.
Assignments: Buyer may assign this agreement.`;
      
      let extra = '';
      if (template==='standard'){
        extra = `Additional Terms: ${d.dealTerms || 'N/A'}.`;
      } else if (template==='subject_to'){
        extra = `SUBJECT-TO ADDENDUM:
1) Buyer to acquire property subject-to existing financing (no loan assumption).
2) Buyer will make monthly payments directly to lender(s) on time.
3) Seller consents to this arrangement and acknowledges due-on-sale risk.
4) Buyer covers taxes, insurance, maintenance from closing.
Additional Terms: ${d.dealTerms || 'N/A'}.`;
      } else if (template==='assignment'){
        extra = `ASSIGNMENT OF CONTRACT:
Assignor: ${d.bizName}
Assignee: ____________________________
Underlying Contract: ${d.propertyAddress}
Assignment Fee: ${money(d.fee||0)}
Assignee accepts all obligations; Assignor discloses all known facts.
Additional Terms: ${d.dealTerms || 'N/A'}.`;
      } else if (template==='jv'){
        extra = `JOINT VENTURE AGREEMENT:
Partner A: ${d.bizName}
Partner B: ____________________________
Purpose: Marketing & assignment of ${d.propertyAddress}
Split: ____% / ____%
Expenses: Pre-approval required above $____.
Additional Terms: ${d.dealTerms || 'N/A'}.`;
      } else if (template==='authorization'){
        extra = `AUTHORIZATION TO RELEASE:
Seller authorizes ${d.bizName} to obtain mortgage payoff, reinstatement, and escrow details on ${d.propertyAddress}.
Lender: __________________
Loan #: ______________
Phone: ______________
Additional Terms: ${d.dealTerms || 'N/A'}.`;
      }
      
      const footer = `
Signatures:
Buyer: ____________________________ Date: ____________
Seller: ____________________________ Date: ____________
Seller: ____________________________ Date: ____________`;
      
      return `${baseHeader}\n${baseBody}\n${extra}\n${footer}`;
    }

    async function generatePdf(deal, opts={}){
      const { jsPDF } = window.jspdf;
      const { includePhoto=true, templateKey='standard' } = opts;
      const doc = new jsPDF({ unit:'pt', format:'letter' });
      const margin=40, lineHeight=16, maxWidth=515;
      let y=60;
      doc.setFont('Helvetica','bold');
      doc.setFontSize(16);
      const title = templateKey==='assignment' ? 'ASSIGNMENT AGREEMENT' :
                   templateKey==='jv' ? 'JOINT VENTURE AGREEMENT' :
                   templateKey==='authorization' ? 'AUTHORIZATION TO RELEASE' :
                   templateKey==='subject_to' ? 'PURCHASE + SUBJECT-TO ADDENDUM' : 'PURCHASE AGREEMENT';
      doc.text(title, margin, y);
      y+=30;
      if (includePhoto && deal.photoDataUrl){
        try {
          doc.addImage(deal.photoDataUrl,'JPEG', margin, y, 140, 100);
        } catch {}
        y+=120;
      }
      doc.setFont('Helvetica','normal');
      doc.setFontSize(11);
      const text = CONTRACT_TEXT(templateKey, deal);
      const lines = doc.splitTextToSize(text, maxWidth);
      lines.forEach((ln,i)=> doc.text(ln, margin, y + i*lineHeight));
      doc.setFontSize(9);
      doc.text('Generated by REI Stack — For attorney review. Not legal advice.', margin, 760);
      return doc;
    }

    // Photo upload (drop + click)
    (function photoUpload(){
      const photoInput = document.getElementById('photoInput');
      const photoDrop = document.getElementById('photoDrop');
      if (!photoInput || !photoDrop) return;
      const show = (dataUrl)=>{
        state.photoDataUrl = dataUrl;
        document.getElementById('photoPreview').classList.remove('hidden');
        document.getElementById('photoImg').src = dataUrl;
      };
      photoDrop.addEventListener('click',()=> photoInput.click());
      photoDrop.addEventListener('dragover', e=>{e.preventDefault(); photoDrop.classList.add('dragover');});
      photoDrop.addEventListener('dragleave', ()=> photoDrop.classList.remove('dragover'));
      photoDrop.addEventListener('drop', e=>{
        e.preventDefault();
        photoDrop.classList.remove('dragover');
        const f = e.dataTransfer.files && e.dataTransfer.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = ()=> show(r.result);
        r.readAsDataURL(f);
      });
      photoInput.addEventListener('change', e=>{
        const f = e.target.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = ()=> show(r.result);
        r.readAsDataURL(f);
      });
    })();

    // Save Deal
    document.getElementById('dealForm').addEventListener('submit',(e)=>{
      e.preventDefault();
      const deal = {
        bizName: document.getElementById('bizName').value.trim(),
        bizAddress: document.getElementById('bizAddress').value.trim(),
        propertyAddress: document.getElementById('propertyAddress').value.trim(),
        sellerNames: document.getElementById('sellerNames').value.trim(),
        purchasePrice: parseFloat(document.getElementById('purchasePrice').value||'0'),
        fee: parseFloat(document.getElementById('assignmentFee').value||'0'),
        dealTerms: document.getElementById('dealTerms').value.trim(),
        template: document.getElementById('contractTemplate').value,
        status: document.getElementById('status').value,
        photoDataUrl: state.photoDataUrl || null,
        createdAt: Date.now(),
        id: 'D'+Date.now()
      };
      state.deals.unshift(deal);
      save('deals',state.deals);
      renderDealsTable();
      renderPipeline();
      e.target.reset();
      state.photoDataUrl=null;
      const prev=document.getElementById('photoPreview');
      if(prev) prev.classList.add('hidden');
      alert('Deal saved');
    });

    // Generate PDF from latest deal
    document.getElementById('genPdfBtn').addEventListener('click', async ()=>{
      const d = state.deals[0];
      if(!d){
        alert('Save a deal first.');
        return;
      }
      (await generatePdf(d, { templateKey: d.template||'standard' })).save(`Contract_${d.propertyAddress.replaceAll(' ','_')}.pdf`);
    });

    // Prefill from selected lead
    document.getElementById('dealFromLeadBtn').addEventListener('click',()=>{
      const l = state.leads.find(x=>x.id===state.selectedLeadId) || state.leads[0];
      if(!l){
        alert('No lead selected');
        return;
      }
      document.getElementById('propertyAddress').value = l.address;
      document.getElementById('sellerNames').value = l.seller||'';
      document.getElementById('purchasePrice').value = Math.max(0, (l.arv||0)*0.7 - (l.repairs||0));
      document.getElementById('dealTerms').value = `Offer auto-generated from lead. Source: ${l.source}.`;
      document.querySelector('.tab[data-tab="contracts"]').click();
    });

    // Deals table
    function renderDealsTable(){
      const tbody = document.getElementById('dealRows');
      if(!tbody) return;
      const q=(document.getElementById('search').value||'').toLowerCase();
      const fs=document.getElementById('filterStatus').value;
      tbody.innerHTML='';
      state.deals
        .filter(d=>!fs||d.status===fs)
        .filter(d=> d.propertyAddress.toLowerCase().includes(q) || (d.sellerNames||'').toLowerCase().includes(q))
        .forEach((d,idx)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="py-2 pr-4">${d.propertyAddress}</td>
            <td class="py-2 pr-4">${d.sellerNames||''}</td>
            <td class="py-2 pr-4">${money(d.purchasePrice)}</td>
            <td class="py-2 pr-4">${money(d.fee||0)}</td>
            <td class="py-2 pr-4"><span class="badge ${STATUS_MAP[d.status].cls}">${STATUS_MAP[d.status].label}</span></td>
            <td class="py-2 pr-4 flex gap-2">
              <button class="btn btn-outline text-xs px-2 py-1 gen">PDF</button>
              <button class="btn btn-outline text-xs px-2 py-1 edit">Edit</button>
              <button class="btn btn-outline text-xs px-2 py-1 del">Delete</button>
            </td>
          `;
          tr.querySelector('.gen').onclick = async ()=>{
            (await generatePdf(d, { templateKey: d.template||'standard' })).save(`Contract_${d.propertyAddress.replaceAll(' ','_')}.pdf`);
          };
          tr.querySelector('.edit').onclick = ()=> loadDealIntoForm(idx);
          tr.querySelector('.del').onclick = ()=>{
            if(confirm('Delete this deal?')){
              state.deals.splice(idx,1);
              save('deals',state.deals);
              renderDealsTable();
              renderPipeline();
            }
          };
          tbody.appendChild(tr);
        });
    }

    function loadDealIntoForm(idx){
      const d = state.deals[idx];
      if(!d) return;
      document.getElementById('bizName').value = d.bizName;
      document.getElementById('bizAddress').value = d.bizAddress;
      document.getElementById('propertyAddress').value = d.propertyAddress;
      document.getElementById('sellerNames').value = d.sellerNames;
      document.getElementById('purchasePrice').value = d.purchasePrice;
      document.getElementById('assignmentFee').value = d.fee||0;
      document.getElementById('dealTerms').value = d.dealTerms||'';
      document.getElementById('contractTemplate').value = d.template||'standard';
      document.getElementById('status').value = d.status;
      state.photoDataUrl = d.photoDataUrl||null;
      if(state.photoDataUrl){
        document.getElementById('photoPreview').classList.remove('hidden');
        document.getElementById('photoImg').src = state.photoDataUrl;
      }
      document.querySelector('.tab[data-tab="contracts"]').click();
    }

    document.getElementById('search').addEventListener('input', renderDealsTable);
    document.getElementById('filterStatus').addEventListener('change', renderDealsTable);

    // Pipeline render
    function renderPipeline(){
      document.getElementById('dealCount').textContent = `${state.deals.length} total deals`;
      ['lead','offer','pending','sent','signed','attorney','closed'].forEach(st=>{
        const col = document.getElementById('col-'+st);
        if(!col) return;
        col.innerHTML='';
        state.deals.filter(d=>d.status===st).forEach(deal=>{
          const card = document.createElement('div');
          card.className='bg-white dark:bg-[#0b1322] rounded-xl border p-3 text-sm space-y-1';
          card.innerHTML = `
            <div class="font-medium">${deal.propertyAddress}</div>
            <div class="text-xs text-gray-500">${deal.sellerNames||''} • ${money(deal.purchasePrice)}</div>
            <div class="flex items-center justify-between pt-1 gap-2">
              <span class="badge ${STATUS_MAP[deal.status].cls}">${STATUS_MAP[deal.status].label}</span>
              <div class="flex items-center gap-2">
                <select class="mobile-only border rounded-lg px-2 py-1 text-xs">
                  ${Object.keys(STATUS_MAP).map(k=>`<option value="${k}" ${k===deal.status?'selected':''}>${STATUS_MAP[k].label}</option>`).join('')}
                </select>
                <button class="btn btn-outline text-xs px-2 py-1 desktop-only">PDF</button>
              </div>
            </div>
          `;
          const sel = card.querySelector('select');
          sel && (sel.onchange = ()=>{
            deal.status = sel.value;
            save('deals',state.deals);
            renderPipeline();
            renderDealsTable();
          });
          const pdfBtn = card.querySelector('button');
          pdfBtn && (pdfBtn.onclick = async ()=>{
            (await generatePdf(deal, { templateKey: deal.template||'standard' })).save(`Contract_${deal.propertyAddress.replaceAll(' ','_')}.pdf`);
          });
          col.appendChild(card);
        });
      });
    }

    // ========= EmailJS + Supabase =========
    function sb(){
      return window.supabase.createClient(state.settings.sbUrl, state.settings.sbAnon);
    }

    async function uploadPdfAndGetUrl(fileBlob, fileNameHint='Contract'){
      if (!state.settings.sbUrl || !state.settings.sbAnon){
        throw new Error('Supabase not configured');
      }
      const client = sb();
      const safe=(fileNameHint||'Contract').replace(/[^a-z0-9-_]/gi,'_');
      const path = `${safe}_${Date.now()}.pdf`;
      const { error } = await client.storage.from(state.settings.sbBucket||'contracts').upload(path, fileBlob, { contentType:'application/pdf', upsert:false });
      if (error) throw error;
      const { data } = client.storage.from(state.settings.sbBucket||'contracts').getPublicUrl(path);
      return data.publicUrl;
    }

    async function ensureEmailJs(){
      if (!window.emailjs){
        await new Promise(res=>{
          const s=document.createElement('script');
          s.src='https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js';
          s.onload=res;
          document.body.appendChild(s);
        });
      }
      const pub = state.settings.ejPublic;
      if(!pub) throw new Error('EmailJS public key missing');
      window.emailjs.init({ publicKey: pub });
    }

    async function sendEmail({to, subject, body, vars={}}){
      const svc=state.settings.ejService, tpl=state.settings.ejTemplate;
      if(!(svc&&tpl)) throw new Error('EmailJS service or template missing');
      await ensureEmailJs();
      return window.emailjs.send(svc, tpl, { to_email: to, subject, message: body, ...vars });
    }

    // Contracts tab email button
    document.getElementById('sendEmailBtn').addEventListener('click', async ()=>{
      try{
        const to = document.getElementById('emailTo').value.trim();
        if(!to) return alert('Seller email required');
        const svc = document.getElementById('emailjsService').value.trim();
        if(svc){
          state.settings.ejService=svc;
          localStorage.setItem('EJ_SERVICE', svc);
        }
        const tpl = document.getElementById('emailjsTemplate').value.trim();
        if(tpl){
          state.settings.ejTemplate=tpl;
          localStorage.setItem('EJ_TEMPLATE', tpl);
        }
        const pub = document.getElementById('emailjsPublic').value.trim();
        if(pub){
          state.settings.ejPublic=pub;
          localStorage.setItem('EJ_PUBLIC', pub);
        }
        const deal = state.deals[0];
        if(!deal) return alert('Save a deal first');
        const pdf = await generatePdf(deal, { templateKey: deal.template||'standard' });
        const blob = pdf.output('blob');
        const link = await uploadPdfAndGetUrl(blob, deal.propertyAddress);
        await sendEmail({ to, subject:`Contract for ${deal.propertyAddress} — ${deal.bizName}`, body:`Here is the agreement link: ${link}`, vars:{ bizName:deal.bizName, sellerNames:deal.sellerNames, propertyAddress:deal.propertyAddress, link } });
        alert('Email sent with public link!');
      }catch(e){
        alert('Send failed: '+e.message);
      }
    });

    // Offer versioning (Cash / Terms / Both)
    function computeMAOFromLeadOrForm(){
      const arv = Number(document.getElementById('leadARV').value||0);
      const rep = Number(document.getElementById('leadRepairs').value||0);
      return Math.max(0, arv*0.7 - rep);
    }

    async function sendOfferVariant(kind){
      try{
        const to = (document.getElementById('offerEmailTo').value||'').trim();
        if(!to) return alert('Recipient required');
        const address = document.getElementById('leadAddress').value || (state.leads[0]?.address||'Property');
        const biz = document.getElementById('bizName').value || 'Your LLC';
        const mao = computeMAOFromLeadOrForm();
        let price = mao;
        let templateKey='standard';
        let terms = 'Cash offer';
        if (kind==='cash'){
          const pct = Number(document.getElementById('offerCashPct').value||100)/100;
          price = Math.round(mao*pct);
          terms = `Cash offer at ~${Math.round(pct*100)}% of MAO.`;
        } else if(kind==='terms'){
          const arv = Number(document.getElementById('leadARV').value||0);
          const downPct = Number(document.getElementById('offerTermsDownPct').value||5)/100;
          const rate = Number(document.getElementById('offerTermsRate').value||4.5);
          const yrs = Number(document.getElementById('offerTermsAmort').value||30);
          const down = Math.round(arv*downPct);
          // Rough P&I for visibility
          const princ = Math.max(0, (price||arv) - down);
          const mRate = rate/100/12;
          const n = yrs*12;
          const pmt = mRate>0 ? Math.round(princ * (mRate*Math.pow(1+mRate,n))/(Math.pow(1+mRate,n)-1)) : Math.round(princ/n);
          templateKey='subject_to';
          terms = `Subject-to terms: ~${money(down)} down, ~${rate}% ${yrs}yr, est P&I ≈ ${money(pmt)}/mo (taxes/ins extra).`;
          price = arv || mao; // terms price often nearer ARV
        }
        const tempDeal = {
          bizName: biz,
          bizAddress: document.getElementById('bizAddress').value||'',
          propertyAddress: address,
          sellerNames: '',
          purchasePrice: price,
          dealTerms: terms,
          status: 'offer',
          photoDataUrl: null,
          template: templateKey
        };
        const pdf = await generatePdf(tempDeal, { templateKey });
        const blob = pdf.output('blob');
        const link = await uploadPdfAndGetUrl(blob, tempDeal.propertyAddress);
        const body = `${terms}\n\nView agreement: ${link}`;
        await sendEmail({ to, subject:`Offer for ${address} — ${biz} (${kind.toUpperCase()})`, body, vars:{ bizName:biz, sellerNames:'', propertyAddress:address, link } });
        alert(`${kind==='cash'?'Cash':'Terms'} offer sent!`);
      }catch(e){
        alert('Offer send failed: '+e.message);
      }
    }

    document.getElementById('sendCashOfferBtn').addEventListener('click', e=>{
      e.preventDefault();
      sendOfferVariant('cash');
    });

    document.getElementById('sendTermsOfferBtn').addEventListener('click', e=>{
      e.preventDefault();
      sendOfferVariant('terms');
    });

    document.getElementById('sendBothOffersBtn').addEventListener('click', async e=>{
      e.preventDefault();
      await sendOfferVariant('cash');
      await sendOfferVariant('terms');
    });

    // Dispo blast (simple tag match on buyers.criteria)
    document.getElementById('dispoSendBtn').addEventListener('click', async ()=>{
      try{
        const tags = (document.getElementById('dispoTags').value||'').toLowerCase().split(/[,;]+/).map(s=>s.trim()).filter(Boolean);
        const body = document.getElementById('dispoBody').value||'New deal available.';
        if (!tags.length) return alert('Enter at least one tag');
        const matches = state.buyers.filter(b=>
          (b.criteria||'').toLowerCase().split(/[,;]+/).some(c=> tags.includes(c.trim())));
        if (!matches.length) return alert('No matching buyers yet.');
        await ensureEmailJs();
        for (const b of matches){
          await sendEmail({ to:b.email, subject:'Deal Opportunity', body, vars:{} });
        }
        alert('Blast sent to matching buyers!');
      }catch(e){
        alert('Blast failed: '+e.message);
      }
    });

    // ========= Signer (PDF preview + typed/drawn placement) =========
    const pdfjsLibLocal = window['pdfjs-dist/build/pdf'];
    pdfjsLibLocal.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    const pdfFile = document.getElementById('pdfFile');
    const pdfContainer = document.getElementById('pdfContainer');
    const addSigBtn = document.getElementById('addSigBtn');
    const addInitBtn = document.getElementById('addInitBtn');
    const finishBtn = document.getElementById('finishBtn');
    let currentTool = null;

    pdfFile && pdfFile.addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      state.signer.pdfBytes = await file.arrayBuffer();
      await loadPdfForPreview(state.signer.pdfBytes);
      if(addSigBtn) addSigBtn.disabled=false;
      if(addInitBtn) addInitBtn.disabled=false;
      if(finishBtn) finishBtn.disabled=false;
    });

    async function loadPdfForPreview(pdfBytes){
      if (!pdfContainer) return;
      pdfContainer.innerHTML='';
      state.signer.placements = [];
      const loadingTask = pdfjsLibLocal.getDocument({ data: pdfBytes });
      const pdf = await loadingTask.promise;
      state.signer.pages=[];
      for(let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 1.1 });
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const ctx = canvas.getContext('2d');
        await page.render({ canvasContext: ctx, viewport }).promise;
        canvas.className='mx-auto border rounded-lg bg-white';
        canvas.dataset.page=i;
        pdfContainer.appendChild(canvas);
        state.signer.pages.push({canvas,viewport});
        const tap = (evt)=>{
          if(!currentTool) return;
          const rect=canvas.getBoundingClientRect();
          const x=(evt.touches?evt.touches[0].clientX:evt.clientX)-rect.left;
          const y=(evt.touches?evt.touches[0].clientY:evt.clientY)-rect.top;
          placeFieldOnCanvas(canvas,x,y,currentTool==='sig'?'Signature':'Initials');
        };
        canvas.addEventListener('click', tap, {passive:true});
        canvas.addEventListener('touchstart', tap, {passive:true});
      }
    }

    function placeFieldOnCanvas(canvas,x,y,label){
      const ctx=canvas.getContext('2d');
      ctx.save();
      ctx.strokeStyle='#06b6d4';
      ctx.setLineDash([4,3]);
      ctx.strokeRect(x-60,y-18,120,36);
      ctx.fillStyle='#06b6d4';
      ctx.font='12px sans-serif';
      ctx.fillText(label,x-55,y-24);
      ctx.restore();
      state.signer.placements.push({ page:Number(canvas.dataset.page), x, y, type: label.toLowerCase() });
    }

    addSigBtn && addSigBtn.addEventListener('click',()=> currentTool='sig');
    addInitBtn && addInitBtn.addEventListener('click',()=> currentTool='init');

    // Draw pads
    function makePad(canvas){
      if(!canvas) return null;
      function resize(){
        const ratio = Math.max(1, Math.floor(window.devicePixelRatio||1));
        const dw = canvas.clientWidth||300;
        const dh = canvas.classList.contains('h-24')?96:160;
        canvas.width=dw*ratio;
        canvas.height=dh*ratio;
        const ctx = canvas.getContext('2d');
        ctx.setTransform(ratio,0,0,ratio,0,0);
      }
      resize();
      window.addEventListener('resize', resize);
      const ctx=canvas.getContext('2d');
      let drawing=false, last=null;
      function draw(e){
        const r=canvas.getBoundingClientRect();
        const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;
        const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;
        if(!drawing) return;
        ctx.lineWidth=2;
        ctx.lineCap='round';
        ctx.strokeStyle='#111827';
        ctx.beginPath();
        ctx.moveTo(last.x,last.y);
        ctx.lineTo(x,y);
        ctx.stroke();
        last={x,y};
      }
      canvas.addEventListener('mousedown', e=>{drawing=true; last={x:e.offsetX,y:e.offsetY}});
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', ()=>drawing=false);
      canvas.addEventListener('mouseleave', ()=>drawing=false);
      canvas.addEventListener('touchstart', e=>{drawing=true; const r=canvas.getBoundingClientRect(); last={x:e.touches[0].clientX-r.left,y:e.touches[0].clientY-r.top}}, {passive:true});
      canvas.addEventListener('touchmove', draw, {passive:true});
      canvas.addEventListener('touchend', ()=>drawing=false);
      return {
        clear(){ ctx.clearRect(0,0,canvas.width,canvas.height); },
        toDataURL(){ return canvas.toDataURL('image/png'); }
      };
    }

    const sigPad = makePad(document.getElementById('sigPad'));
    const initPad = makePad(document.getElementById('initPad'));
    const sigClear = document.getElementById('sigClear');
    const initClear = document.getElementById('initClear');
    sigClear && sigClear.addEventListener('click',()=> sigPad && sigPad.clear());
    initClear && initClear.addEventListener('click',()=> initPad && initPad.clear());

    document.getElementById('sigSave') && document.getElementById('sigSave').addEventListener('click',()=>{
      state.signer.signatureUrl = sigPad && sigPad.toDataURL();
      alert('Signature (drawn) saved. Tap to place.');
    });

    document.getElementById('initSave') && document.getElementById('initSave').addEventListener('click',()=>{
      state.signer.initialsUrl = initPad && initPad.toDataURL();
      alert('Initials (drawn) saved. Tap to place.');
    });

    // Typed signature/initials (from your inputs & font selectors)
    const typedSigInput = document.getElementById('typedSigInput') || document.getElementById('typedSignatureInput');
    const typedSigFont = document.getElementById('typedSigFont');
    const typedInitInput = document.getElementById('typedInitInput') || document.getElementById('typedInitialsInput');
    const typedInitFont = document.getElementById('typedInitFont');

    function renderTypedToDataURL(text, fontCss, px){
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = Math.max(400, text.length*24);
      canvas.height = px+40;
      ctx.fillStyle='#111827';
      ctx.font = `${px}px ${fontCss||'cursive'}`;
      ctx.textBaseline='alphabetic';
      ctx.fillText(text, 20, px+10);
      return canvas.toDataURL('image/png');
    }

    document.getElementById('typedSigGenerate') && document.getElementById('typedSigGenerate').addEventListener('click',()=>{
      const text = (typedSigInput && typedSigInput.value.trim()) || '';
      if(!text) return alert('Type your name for the signature');
      const font = (typedSigFont && typedSigFont.value) || "'Great Vibes', cursive";
      state.signer.signatureUrl = renderTypedToDataURL(text, font, 50);
           alert('Typed signature saved. Tap PDF to place.');
    });

    document.getElementById('typedInitGenerate') && document.getElementById('typedInitGenerate').addEventListener('click',()=>{
      const text = (typedInitInput && typedInitInput.value.trim()) || '';
      if(!text) return alert('Type your initials');
      const font = (typedInitFont && typedInitFont.value) || "'Great Vibes', cursive";
      state.signer.initialsUrl = renderTypedToDataURL(text, font, 36);
      alert('Typed initials saved. Tap PDF to place.');
    });

    // Finalize PDF with placements
    finishBtn && finishBtn.addEventListener('click', async ()=>{
      if(!state.signer.pdfBytes) return alert('No PDF loaded');
      if(!state.signer.placements.length) return alert('No signatures/initials placed');
      try{
        const pdfDoc = await PDFLib.PDFDocument.load(state.signer.pdfBytes);
        const pages = pdfDoc.getPages();
        for(const p of state.signer.placements){
          const page = pages[p.page-1];
          const {width,height} = page.getSize();
          const scale = width / (state.signer.pages[p.page-1].viewport.width);
          const imgUrl = p.type==='signature'? state.signer.signatureUrl : state.signer.initialsUrl;
          if(!imgUrl) continue;
          const img = await pdfDoc.embedPng(imgUrl);
          const dims = img.scale(0.5);
          page.drawImage(img, {
            x: p.x*scale - dims.width/2,
            y: height - p.y*scale - dims.height/2,
            width: dims.width,
            height: dims.height
          });
        }
        const finalBytes = await pdfDoc.save();
        const blob = new Blob([finalBytes], {type:'application/pdf'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Signed_Contract.pdf';
        a.click();
        URL.revokeObjectURL(url);
        alert('Signed PDF downloaded!');
      }catch(e){
        alert('Finalize failed: '+e.message);
      }
    });

    // ========= Buyers CRM =========
    function renderBuyersTable(){
      const tbody = document.getElementById('buyerRows');
      if(!tbody) return;
      tbody.innerHTML='';
      state.buyers.forEach((b,idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 pr-4">${b.name||''}</td>
          <td class="py-2 pr-4">${b.email||''}</td>
          <td class="py-2 pr-4">${b.phone||''}</td>
          <td class="py-2 pr-4">${b.criteria||''}</td>
          <td class="py-2 pr-4">${b.notes||''}</td>
          <td class="py-2 pr-4 flex gap-2">
            <button class="btn btn-outline text-xs px-2 py-1 edit">Edit</button>
            <button class="btn btn-outline text-xs px-2 py-1 del">Delete</button>
          </td>
        `;
        tr.querySelector('.edit').onclick = ()=> editBuyer(idx);
        tr.querySelector('.del').onclick = ()=>{
          if(confirm('Delete buyer?')){
            state.buyers.splice(idx,1);
            save('buyers',state.buyers);
            renderBuyersTable();
          }
        };
        tbody.appendChild(tr);
      });
    }

    function editBuyer(idx){
      const b = state.buyers[idx];
      if(!b) return;
      const name = prompt('Buyer Name:', b.name||'');
      if(!name) return;
      b.name = name;
      b.email = prompt('Email:', b.email||'') || '';
      b.phone = prompt('Phone:', b.phone||'') || '';
      b.criteria = prompt('Criteria/Tags (comma separated):', b.criteria||'') || '';
      b.notes = prompt('Notes:', b.notes||'') || '';
      save('buyers',state.buyers);
      renderBuyersTable();
    }

    document.getElementById('addBuyerBtn') && document.getElementById('addBuyerBtn').addEventListener('click',()=>{
      const name = prompt('Buyer Name:');
      if(!name) return;
      const buyer = {
        name,
        email: prompt('Email:') || '',
        phone: prompt('Phone:') || '',
        criteria: prompt('Criteria/Tags (e.g. 30318; <200k; rehab):') || '',
        notes: prompt('Notes:') || '',
        id: 'B'+Date.now()
      };
      state.buyers.push(buyer);
      save('buyers',state.buyers);
      renderBuyersTable();
    });

    // ========= KPI Dashboard =========
    function updateKPI(){
      const start = weekStartMs();
      const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1).getTime();
      
      // Conversations this week
      const convos = state.calls.filter(c=>c.ts>=start).length;
      const goalConvos = Number(state.goals.convos||50);
      document.getElementById('kpiConvos').textContent = convos;
      document.getElementById('kpiConvosTarget').textContent = `/ ${goalConvos}`;
      document.getElementById('kpiConvosMeter').style.width = Math.min(100, Math.round((convos/goalConvos)*100))+'%';
      
      // Offers this week
      const offers = state.leads.filter(l=>l.offerSentDate && l.offerSentDate>=start).length;
      const goalOffers = Number(state.goals.offers||10);
      document.getElementById('kpiOffers').textContent = offers;
      document.getElementById('kpiOffersTarget').textContent = `/ ${goalOffers}`;
      document.getElementById('kpiOffersMeter').style.width = Math.min(100, Math.round((offers/goalOffers)*100))+'%';
      
      // Contracts this month
      const contracts = state.deals.filter(d=>['signed','attorney','closed'].includes(d.status) && d.createdAt>=monthStart).length;
      const goalContracts = Number(state.goals.contracts||5);
      document.getElementById('kpiContracts').textContent = contracts;
      document.getElementById('kpiContractsTarget').textContent = `/ ${goalContracts}`;
      document.getElementById('kpiContractsMeter').style.width = Math.min(100, Math.round((contracts/goalContracts)*100))+'%';
      
      // Assignment fees this month
      const fees = state.deals.filter(d=>d.createdAt>=monthStart).reduce((sum,d)=>sum+(d.fee||0),0);
      document.getElementById('kpiFees').textContent = money(fees);
      document.getElementById('kpiFeesMeter').style.width = Math.min(100, Math.round((fees/35000)*100))+'%';
      
      // Update daily metrics
      updateDailyMetrics();
    }

    function updateDailyMetrics(){
      const today = new Date().toDateString();
      const todayStart = new Date(today).getTime();
      const weekStart = weekStartMs();
      
      // Privy searches today
      const searches = JSON.parse(localStorage.getItem('privySearches') || '[]');
      const todaySearch = searches.find(s => s.date === today);
      document.getElementById('privySearchesToday').textContent = todaySearch ? todaySearch.count : 0;
      
      // Offers sent today
      const offersToday = state.leads.filter(l=>l.offerSentDate && l.offerSentDate>=todayStart).length;
      document.getElementById('offersSentToday').textContent = offersToday;
      
      // Follow-ups today
      const followUpsToday = state.calls.filter(c=>c.ts>=todayStart && c.type!=='initial').length;
      document.getElementById('followUpsToday').textContent = followUpsToday;
      
      // Response rate
      const contacted = state.leads.filter(l=>l.attempts>0).length;
      const responded = state.leads.filter(l=>l.offerResponse).length;
      const responseRate = contacted>0 ? Math.round((responded/contacted)*100) : 0;
      document.getElementById('responseRate').textContent = responseRate + '%';
      
      // Weekly conversion funnel
      const weekSearches = searches.filter(s => {
        const searchDate = new Date(s.date).getTime();
        return searchDate >= weekStart;
      }).reduce((sum, s) => sum + s.count, 0);
      
      const weekOffers = state.leads.filter(l=>l.offerSentDate && l.offerSentDate>=weekStart).length;
      const weekContracts = state.deals.filter(d=>d.createdAt>=weekStart && ['signed','attorney','closed'].includes(d.status)).length;
      
      const searchToOfferRate = weekSearches>0 ? Math.round((weekOffers/weekSearches)*100) : 0;
      const offerToContractRate = weekOffers>0 ? Math.round((weekContracts/weekOffers)*100) : 0;
      
      document.getElementById('searchToOfferRate').textContent = searchToOfferRate + '%';
      document.getElementById('searchToOfferMeter').style.width = searchToOfferRate + '%';
      document.getElementById('offerToContractRate').textContent = offerToContractRate + '%';
      document.getElementById('offerToContractMeter').style.width = offerToContractRate + '%';
      
      // Monthly pace
      const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth()+1, 0).getDate();
      const dayOfMonth = new Date().getDate();
      const monthProgress = dayOfMonth / daysInMonth;
      const monthDeals = state.deals.filter(d=>d.createdAt>=new Date(new Date().getFullYear(), new Date().getMonth(), 1).getTime() && ['signed','attorney','closed'].includes(d.status)).length;
      const projectedDeals = Math.round(monthDeals / monthProgress);
      const projectedFees = Math.round(projectedDeals * 7000); // Avg $7k per deal
      
      document.getElementById('monthlyPace').textContent = `Current: ${monthDeals} deals • Projected: ${projectedDeals} deals (~${money(projectedFees)})`;
      
      // Recommendations
      const recommendations = [];
      if (weekSearches < 20) recommendations.push('⚡ Increase Privy searches (target: 20+/week)');
      if (searchToOfferRate < 50) recommendations.push('📞 Improve contact rate (target: 50%+ search→offer)');
      if (offerToContractRate < 30 && weekOffers > 5) recommendations.push('💰 Refine offer strategy (target: 30%+ offer→contract)');
      if (projectedDeals < 3) recommendations.push('🎯 Pick up pace to hit 3-5 deals/month');
      
      document.getElementById('paceRecommendation').textContent = recommendations.length ? recommendations.join(' • ') : '✅ On track! Keep going!';
    }

    // Quick action buttons
    document.getElementById('logPrivySearchBtn') && document.getElementById('logPrivySearchBtn').addEventListener('click',()=>{
      const searches = JSON.parse(localStorage.getItem('privySearches') || '[]');
      const today = new Date().toDateString();
      const todaySearch = searches.find(s => s.date === today);
      if (todaySearch) {
        todaySearch.count++;
      } else {
        searches.push({ date: today, count: 1 });
      }
      localStorage.setItem('privySearches', JSON.stringify(searches));
      updateDailyMetrics();
      alert('Privy search logged');
    });

    document.getElementById('markOfferSentBtn') && document.getElementById('markOfferSentBtn').addEventListener('click',()=>{
      if (state.leads.length === 0) {
        alert('No leads available to mark');
        return;
      }
      const lead = state.leads[0];
      lead.offerSent = true;
      lead.offerSentDate = Date.now();
      save('leads', state.leads);
      updateKPI();
      alert('Offer marked as sent');
    });

    document.getElementById('viewActivityLogBtn') && document.getElementById('viewActivityLogBtn').addEventListener('click',()=>{
      const log = state.calls.slice(-20).reverse().map(c=> {
        const d = new Date(c.ts);
        return `${d.toLocaleDateString()} ${d.toLocaleTimeString()} - ${c.type}`;
      }).join('\n');
      alert('Recent Activity:\n\n' + (log || 'No activity yet'));
    });

    // Save goals
    document.getElementById('saveGoalsBtn') && document.getElementById('saveGoalsBtn').addEventListener('click',()=>{
      state.goals.convos = Number(document.getElementById('goalConvos').value||50);
      state.goals.offers = Number(document.getElementById('goalOffers').value||10);
      state.goals.contracts = Number(document.getElementById('goalContracts').value||5);
      localStorage.setItem('goals', JSON.stringify(state.goals));
      updateKPI();
      renderOneMetric();
      alert('Goals saved');
    });

    // ========= Settings =========
    function loadSettings(){
      document.getElementById('sbUrl').value = state.settings.sbUrl;
      document.getElementById('sbAnon').value = state.settings.sbAnon;
      document.getElementById('sbBucket').value = state.settings.sbBucket;
      document.getElementById('ejService').value = state.settings.ejService;
      document.getElementById('ejTemplate').value = state.settings.ejTemplate;
      document.getElementById('ejPublic').value = state.settings.ejPublic;
      document.getElementById('goalConvos').value = state.goals.convos || 50;
      document.getElementById('goalOffers').value = state.goals.offers || 10;
      document.getElementById('goalContracts').value = state.goals.contracts || 5;
    }

    document.getElementById('saveSbBtn') && document.getElementById('saveSbBtn').addEventListener('click',()=>{
      state.settings.sbUrl = document.getElementById('sbUrl').value.trim();
      state.settings.sbAnon = document.getElementById('sbAnon').value.trim();
      state.settings.sbBucket = document.getElementById('sbBucket').value.trim() || 'contracts';
      localStorage.setItem('SUPABASE_URL', state.settings.sbUrl);
      localStorage.setItem('SUPABASE_ANON', state.settings.sbAnon);
      localStorage.setItem('SUPABASE_BUCKET', state.settings.sbBucket);
      alert('Supabase settings saved');
    });

    document.getElementById('saveEjBtn') && document.getElementById('saveEjBtn').addEventListener('click',()=>{
      state.settings.ejService = document.getElementById('ejService').value.trim();
      state.settings.ejTemplate = document.getElementById('ejTemplate').value.trim();
      state.settings.ejPublic = document.getElementById('ejPublic').value.trim();
      localStorage.setItem('EJ_SERVICE', state.settings.ejService);
      localStorage.setItem('EJ_TEMPLATE', state.settings.ejTemplate);
      localStorage.setItem('EJ_PUBLIC', state.settings.ejPublic);
      alert('EmailJS settings saved');
    });

    // ========= Export/Import =========
    document.getElementById('exportCsvBtn') && document.getElementById('exportCsvBtn').addEventListener('click',()=>{
      const rows = [['address','seller','phone','email','agent','arv','repairs','ask','notes','source','status']];
      state.leads.forEach(l=>rows.push([
        l.address, l.seller||'', l.phone||'', l.email||'', l.agent||'',
        l.arv||0, l.repairs||0, l.ask||0, l.notes||'', l.source||'', l.status||''
      ]));
      const csv = rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `REI_Leads_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    });

    document.getElementById('backupBtn') && document.getElementById('backupBtn').addEventListener('click',()=>{
      const backup = {
        version: '1.0',
        timestamp: Date.now(),
        leads: state.leads,
        deals: state.deals,
        buyers: state.buyers,
        calls: state.calls,
        goals: state.goals,
        settings: state.settings
      };
      const blob = new Blob([JSON.stringify(backup,null,2)],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `REI_Backup_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    });

    document.getElementById('restoreBtn') && document.getElementById('restoreBtn').addEventListener('click',()=>{
      document.getElementById('restoreInput').click();
    });

    document.getElementById('restoreInput') && document.getElementById('restoreInput').addEventListener('change', async e=>{
      const file = e.target.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const backup = JSON.parse(text);
        if(confirm('Restore from backup? This will replace all current data.')){
          state.leads = backup.leads || [];
          state.deals = backup.deals || [];
          state.buyers = backup.buyers || [];
          state.calls = backup.calls || [];
          state.goals = backup.goals || {convos:50,offers:10,contracts:5};
          state.settings = backup.settings || {};
          save('leads',state.leads);
          save('deals',state.deals);
          save('buyers',state.buyers);
          save('calls',state.calls);
          save('goals',state.goals);
          Object.keys(state.settings).forEach(k=>{
            const storageKey = {
              sbUrl: 'SUPABASE_URL',
              sbAnon: 'SUPABASE_ANON',
              sbBucket: 'SUPABASE_BUCKET',
              ejService: 'EJ_SERVICE',
              ejTemplate: 'EJ_TEMPLATE',
              ejPublic: 'EJ_PUBLIC'
            }[k];
            if(storageKey) localStorage.setItem(storageKey, state.settings[k]);
          });
          location.reload();
        }
      }catch(err){
        alert('Restore failed: '+err.message);
      }
    });

    // ========= Initialize =========
    renderLeads();
    renderDealsTable();
    renderPipeline();
    renderBuyersTable();
    loadSettings();
    updateKPI();
    lucide.createIcons();
  </script>
</body>
</html></parameter>
</invoke>
